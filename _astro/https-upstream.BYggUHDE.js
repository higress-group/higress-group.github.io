import{c as d,__tla as E}from"./astro-component.m4CCZO6J.js";import{r,m as o,u as y,__tla as v}from"./constant.D4Mjy2rC.js";import{__tla as F}from"./astro/assets-service.BhtN0nM5.js";let e,l,a,n,i,c,t,u=Promise.all([(()=>{try{return E}catch{}})(),(()=>{try{return v}catch{}})(),(()=>{try{return F}catch{}})()]).then(async()=>{let s;s=`<h2 id="prerequisites">Prerequisites</h2>
<ol>
<li>Higress is installed in the higress-system namespace in K8s, with HTTP port listening on 80. For testing convenience, the gateway port is mapped to local 127.0.0.1:80;</li>
<li>The goal is to deploy the https-httpbin service in the default namespace, with the service listening on port 443;</li>
<li>For details about the https-httpbin service, please refer to <a href="https://github.com/2456868764/httpbin" referrerpolicy="unsafe-url" rel="nofollow" target="_blank">github httpbin</a>;</li>
</ol>
<h2 id="prepare-certificates">Prepare Certificates</h2>
<ol>
<li>Generate CA (root certificate):</li>
</ol>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.1vui4.css"><script type="module" src="/_astro/ec.dy9ns.js"><\/script><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="code"><span style="--0:#99A0A6"># Generate CA private key</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0">openssl</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">genrsa</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-out</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">ca.key</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">2048</span></div></div><div class="ec-line"><div class="code"><span style="--0:#99A0A6"># Generate CA root certificate</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0">openssl</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">req</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-x509</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-new</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-nodes</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-key</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">ca.key</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-subj</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"/CN=MyCA"</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-days</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">3650</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-out</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">ca.crt</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="openssl genrsa -out ca.key 2048\x7Fopenssl req -x509 -new -nodes -key ca.key -subj &#x22;/CN=MyCA&#x22; -days 3650 -out ca.crt"><div></div></button></div></figure></div>
<ol start="2">
<li>Generate server certificate</li>
</ol>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="code"><span style="--0:#99A0A6"># Generate server private key</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0">openssl</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">genrsa</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-out</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">server.key</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">2048</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#99A0A6"># Generate server certificate signing request (CSR)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0">openssl</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">req</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-new</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-key</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">server.key</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-subj</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"/CN=https-httpbin-v1.default.svc.cluster.local"</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-out</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">server.csr</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#99A0A6"># Sign server certificate using CA</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0">openssl</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">x509</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-req</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-in</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">server.csr</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-CA</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">ca.crt</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-CAkey</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">ca.key</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-CAcreateserial</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-out</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">server.crt</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-days</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">3650</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-sha256</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="openssl genrsa -out server.key 2048\x7Fopenssl req -new -key server.key -subj &#x22;/CN=https-httpbin-v1.default.svc.cluster.local&#x22; -out server.csr\x7Fopenssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 3650 -sha256"><div></div></button></div></figure></div>
<ol start="3">
<li>Generate Gateway certificate</li>
</ol>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="code"><span style="--0:#99A0A6"># Generate Gateway private key</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0">openssl</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">genrsa</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-out</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">gateway.key</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">2048</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#99A0A6"># Generate Gateway certificate signing request (CSR)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0">openssl</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">req</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-new</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-key</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">gateway.key</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-subj</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"/CN=gateway.higress-system.svc.cluster.local"</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-out</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">gateway.csr</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#99A0A6"># Sign Gateway certificate using CA</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0">openssl</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">x509</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-req</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-in</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">gateway.csr</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-CA</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">ca.crt</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-CAkey</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">ca.key</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-CAcreateserial</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-out</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">gateway.crt</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-days</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">3650</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-sha256</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="openssl genrsa -out gateway.key 2048\x7Fopenssl req -new -key gateway.key -subj &#x22;/CN=gateway.higress-system.svc.cluster.local&#x22; -out gateway.csr\x7Fopenssl x509 -req -in gateway.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out gateway.crt -days 3650 -sha256"><div></div></button></div></figure></div>
<ol start="4">
<li>Import CA certificate, Gateway, and server certificates into secrets</li>
</ol>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="code"><span style="--0:#B392F0">kubectl</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">create</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">secret</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">generic</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">gateway-cert-cacert</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">--from-file=cacert=ca.crt</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">--namespace=default</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0">kubectl</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">create</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">secret</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">tls</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">gateway-cert</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">--key</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">gateway.key</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">--cert</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">gateway.crt</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">--namespace=default</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0">kubectl</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">create</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">secret</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">tls</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">server-cert</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">--key</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">server.key</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">--cert</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">server.crt</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">--namespace=default</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="kubectl create secret generic gateway-cert-cacert --from-file=cacert=ca.crt --namespace=default\x7Fkubectl create secret tls gateway-cert --key gateway.key --cert gateway.crt --namespace=default\x7Fkubectl create secret tls server-cert --key server.key --cert server.crt --namespace=default"><div></div></button></div></figure></div>
<h2 id="prepare-the-backend-https-httpbin-service">Prepare the Backend https-httpbin Service</h2>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="code"><span style="--0:#85E89D">apiVersion</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">v1</span></div></div><div class="ec-line"><div class="code"><span style="--0:#85E89D">kind</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">Service</span></div></div><div class="ec-line"><div class="code"><span style="--0:#85E89D">metadata</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">name</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">https-httpbin-v1</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">namespace</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">default</span></div></div><div class="ec-line"><div class="code"><span style="--0:#85E89D">spec</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">selector</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#85E89D">app</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">https-httpbin-v1</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">ports</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">    </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#85E89D">protocol</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">TCP</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#85E89D">port</span><span style="--0:#E1E4E8">: </span><span style="--0:#79B8FF">443</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#85E89D">targetPort</span><span style="--0:#E1E4E8">: </span><span style="--0:#79B8FF">443</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0">---</span></div></div><div class="ec-line"><div class="code"><span style="--0:#85E89D">apiVersion</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">apps/v1</span></div></div><div class="ec-line"><div class="code"><span style="--0:#85E89D">kind</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">Deployment</span></div></div><div class="ec-line"><div class="code"><span style="--0:#85E89D">metadata</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">name</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">https-httpbin-v1</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">namespace</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">default</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">labels</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#85E89D">app</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">https-httpbin-v1</span></div></div><div class="ec-line"><div class="code"><span style="--0:#85E89D">spec</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">replicas</span><span style="--0:#E1E4E8">: </span><span style="--0:#79B8FF">1</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">selector</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#85E89D">matchLabels</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#85E89D">app</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">https-httpbin-v1</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">template</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#85E89D">metadata</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#85E89D">labels</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#85E89D">app</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">https-httpbin-v1</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#85E89D">spec</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#85E89D">containers</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">        </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#85E89D">name</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">https-httpbin-v1</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#85E89D">image</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">registry.cn-hangzhou.aliyuncs.com/2456868764/httpbin:v1.0.2</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#85E89D">imagePullPolicy</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">Always</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#85E89D">ports</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">            </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#85E89D">containerPort</span><span style="--0:#E1E4E8">: </span><span style="--0:#79B8FF">443</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#85E89D">command</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">            </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#9ECBFF">/app/httpbin</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">            </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#9ECBFF">--https-enable=true</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">            </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#9ECBFF">--https-port=443</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">            </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#9ECBFF">--mtls=true</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">            </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#9ECBFF">--cert=/etc/cert/tls.crt</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">            </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#9ECBFF">--key=/etc/cert/tls.key</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">            </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#9ECBFF">--cacert=/etc/cacert/cacert</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#85E89D">env</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">            </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#85E89D">name</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">POD_NAME</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#85E89D">valueFrom</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#85E89D">fieldRef</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">                  </span><span style="--0:#85E89D">fieldPath</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">metadata.name</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">            </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#85E89D">name</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">NAMESPACE</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#85E89D">valueFrom</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#85E89D">fieldRef</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">                  </span><span style="--0:#85E89D">fieldPath</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">metadata.namespace</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#85E89D">volumeMounts</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">            </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#85E89D">mountPath</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">"/etc/cert"</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#85E89D">name</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">server-cert</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#85E89D">readOnly</span><span style="--0:#E1E4E8">: </span><span style="--0:#79B8FF">true</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">            </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#85E89D">mountPath</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">"/etc/cacert"</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#85E89D">name</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">ca-cert</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#85E89D">readOnly</span><span style="--0:#E1E4E8">: </span><span style="--0:#79B8FF">true</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#85E89D">resources</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#85E89D">requests</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#85E89D">cpu</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">10m</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#85E89D">volumes</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">        </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#85E89D">name</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">server-cert</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#85E89D">secret</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#85E89D">secretName</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">server-cert</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">        </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#85E89D">name</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">ca-cert</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#85E89D">secret</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#85E89D">secretName</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">gateway-cert-cacert</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="apiVersion: v1\x7Fkind: Service\x7Fmetadata:\x7F  name: https-httpbin-v1\x7F  namespace: default\x7Fspec:\x7F  selector:\x7F    app: https-httpbin-v1\x7F  ports:\x7F    - protocol: TCP\x7F      port: 443\x7F      targetPort: 443\x7F---\x7FapiVersion: apps/v1\x7Fkind: Deployment\x7Fmetadata:\x7F  name: https-httpbin-v1\x7F  namespace: default\x7F  labels:\x7F    app: https-httpbin-v1\x7Fspec:\x7F  replicas: 1\x7F  selector:\x7F    matchLabels:\x7F      app: https-httpbin-v1\x7F  template:\x7F    metadata:\x7F      labels:\x7F        app: https-httpbin-v1\x7F    spec:\x7F      containers:\x7F        - name: https-httpbin-v1\x7F          image: registry.cn-hangzhou.aliyuncs.com/2456868764/httpbin:v1.0.2\x7F          imagePullPolicy: Always\x7F          ports:\x7F            - containerPort: 443\x7F          command:\x7F            - /app/httpbin\x7F            - --https-enable=true\x7F            - --https-port=443\x7F            - --mtls=true\x7F            - --cert=/etc/cert/tls.crt\x7F            - --key=/etc/cert/tls.key\x7F            - --cacert=/etc/cacert/cacert\x7F          env:\x7F            - name: POD_NAME\x7F              valueFrom:\x7F                fieldRef:\x7F                  fieldPath: metadata.name\x7F            - name: NAMESPACE\x7F              valueFrom:\x7F                fieldRef:\x7F                  fieldPath: metadata.namespace\x7F          volumeMounts:\x7F            - mountPath: &#x22;/etc/cert&#x22;\x7F              name: server-cert\x7F              readOnly: true\x7F            - mountPath: &#x22;/etc/cacert&#x22;\x7F              name: ca-cert\x7F              readOnly: true\x7F          resources:\x7F            requests:\x7F              cpu: 10m\x7F      volumes:\x7F        - name: server-cert\x7F          secret:\x7F            secretName: server-cert\x7F        - name: ca-cert\x7F          secret:\x7F            secretName: gateway-cert-cacert"><div></div></button></div></figure></div>
<h2 id="configure-the-route">Configure the Route</h2>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="code"><span style="--0:#85E89D">apiVersion</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">networking.k8s.io/v1</span></div></div><div class="ec-line"><div class="code"><span style="--0:#85E89D">kind</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">Ingress</span></div></div><div class="ec-line"><div class="code"><span style="--0:#85E89D">metadata</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">annotations</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#99A0A6"># backend protocol</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#85E89D">nginx.ingress.kubernetes.io/backend-protocol</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">"HTTPS"</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#99A0A6"># gateway to backend mtls</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#85E89D">nginx.ingress.kubernetes.io/proxy-ssl-secret</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">"default/gateway-cert"</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#99A0A6"># SNI for backend check</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#85E89D">nginx.ingress.kubernetes.io/proxy-ssl-name</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">"https-httpbin-v1.default.svc.cluster.local"</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#85E89D">nginx.ingress.kubernetes.io/proxy-ssl-server-name</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">"on"</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">name</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">ingress-https-httpbin</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">namespace</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">default</span></div></div><div class="ec-line"><div class="code"><span style="--0:#85E89D">spec</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">ingressClassName</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">higress</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#85E89D">rules</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">    </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#85E89D">host</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">foo.com</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#85E89D">http</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#85E89D">paths</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8">          </span></span><span style="--0:#E1E4E8">- </span><span style="--0:#85E89D">path</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">/</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#85E89D">pathType</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">Prefix</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#85E89D">backend</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#85E89D">service</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#85E89D">name</span><span style="--0:#E1E4E8">: </span><span style="--0:#9ECBFF">https-httpbin-v1</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#85E89D">port</span><span style="--0:#E1E4E8">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">                  </span><span style="--0:#85E89D">number</span><span style="--0:#E1E4E8">: </span><span style="--0:#79B8FF">443</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="apiVersion: networking.k8s.io/v1\x7Fkind: Ingress\x7Fmetadata:\x7F  annotations:\x7F    # backend protocol\x7F    nginx.ingress.kubernetes.io/backend-protocol: &#x22;HTTPS&#x22;\x7F    # gateway to backend mtls\x7F    nginx.ingress.kubernetes.io/proxy-ssl-secret: &#x22;default/gateway-cert&#x22;\x7F    # SNI for backend check\x7F    nginx.ingress.kubernetes.io/proxy-ssl-name: &#x22;https-httpbin-v1.default.svc.cluster.local&#x22;\x7F    nginx.ingress.kubernetes.io/proxy-ssl-server-name: &#x22;on&#x22;\x7F  name: ingress-https-httpbin\x7F  namespace: default\x7Fspec:\x7F  ingressClassName: higress\x7F  rules:\x7F    - host: foo.com\x7F      http:\x7F        paths:\x7F          - path: /\x7F            pathType: Prefix\x7F            backend:\x7F              service:\x7F                name: https-httpbin-v1\x7F                port:\x7F                  number: 443"><div></div></button></div></figure></div>
<p>Ingress Annotation configuration:</p>
<ul>
<li><code dir="auto">nginx.ingress.kubernetes.io/backend-protocol</code> specifies the protocol used by the backend service. The default is HTTP, and it supports HTTP, HTTP2, HTTPS, GRPC, and GRPCS.</li>
<li><code dir="auto">nginx.ingress.kubernetes.io/proxy-ssl-secret</code> enables mtls by specifying the gateway certificate, in the format <code dir="auto">namespace/secret-name</code>. Note that you also need to create a CA certificate secret with the name of the proxy-ssl-secret plus the <code dir="auto">-cacert</code> suffix, such as <code dir="auto">gateway-cert-cacert</code>, otherwise it will report an error.</li>
<li><code dir="auto">nginx.ingress.kubernetes.io/proxy-ssl-name</code> specifies the domain name used by the backend service for SNI verification.</li>
<li><code dir="auto">nginx.ingress.kubernetes.io/proxy-ssl-server-name</code> enables SNI.</li>
</ul>
<h1 id="testing">Testing</h1>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="code"><span style="--0:#B392F0">curl</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-H</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"host: foo.com"</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">http://127.0.0.1/ping</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0">"pong"</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="curl -H &#x22;host: foo.com&#x22; http://127.0.0.1/ping\x7F\x7F&#x22;pong&#x22;"><div></div></button></div></figure></div>`,n={title:"Configure a Route to HTTPS Service",keywords:["ops","config","route","upstream","https"],description:"Introduce how to configure a route for backend services using the HTTPS protocol",custom_edit_url:"https://github.com/higress-group/higress-group.github.io/blob/main/src/content/docs/latest/en/ops/how-tos/https-upstream.md"},a="/home/runner/work/higress-group.github.io/higress-group.github.io/src/content/docs/latest/en/ops/how-tos/https-upstream.md",t=void 0,c=function(){return`
# Configure a Route to HTTPS Service


## Prerequisites

1. Higress is installed in the higress-system namespace in K8s, with HTTP port listening on 80. For testing convenience, the gateway port is mapped to local 127.0.0.1:80;
2. The goal is to deploy the https-httpbin service in the default namespace, with the service listening on port 443;
3. For details about the https-httpbin service, please refer to [github httpbin](https://github.com/2456868764/httpbin);

## Prepare Certificates

1. Generate CA (root certificate):
\`\`\`shell
# Generate CA private key
openssl genrsa -out ca.key 2048
# Generate CA root certificate
openssl req -x509 -new -nodes -key ca.key -subj "/CN=MyCA" -days 3650 -out ca.crt
\`\`\`

2. Generate server certificate

\`\`\`shell
# Generate server private key
openssl genrsa -out server.key 2048

# Generate server certificate signing request (CSR)
openssl req -new -key server.key -subj "/CN=https-httpbin-v1.default.svc.cluster.local" -out server.csr

# Sign server certificate using CA
openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 3650 -sha256
\`\`\`

3. Generate Gateway certificate

\`\`\`shell
# Generate Gateway private key
openssl genrsa -out gateway.key 2048

# Generate Gateway certificate signing request (CSR)
openssl req -new -key gateway.key -subj "/CN=gateway.higress-system.svc.cluster.local" -out gateway.csr

# Sign Gateway certificate using CA
openssl x509 -req -in gateway.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out gateway.crt -days 3650 -sha256
\`\`\`

4. Import CA certificate, Gateway, and server certificates into secrets

\`\`\`shell
kubectl create secret generic gateway-cert-cacert --from-file=cacert=ca.crt --namespace=default
kubectl create secret tls gateway-cert --key gateway.key --cert gateway.crt --namespace=default
kubectl create secret tls server-cert --key server.key --cert server.crt --namespace=default
\`\`\`

## Prepare the Backend https-httpbin Service

\`\`\`yaml
apiVersion: v1
kind: Service
metadata:
  name: https-httpbin-v1
  namespace: default
spec:
  selector:
    app: https-httpbin-v1
  ports:
    - protocol: TCP
      port: 443
      targetPort: 443
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: https-httpbin-v1
  namespace: default
  labels:
    app: https-httpbin-v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: https-httpbin-v1
  template:
    metadata:
      labels:
        app: https-httpbin-v1
    spec:
      containers:
        - name: https-httpbin-v1
          image: registry.cn-hangzhou.aliyuncs.com/2456868764/httpbin:v1.0.2
          imagePullPolicy: Always
          ports:
            - containerPort: 443
          command:
            - /app/httpbin
            - --https-enable=true
            - --https-port=443
            - --mtls=true
            - --cert=/etc/cert/tls.crt
            - --key=/etc/cert/tls.key
            - --cacert=/etc/cacert/cacert
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          volumeMounts:
            - mountPath: "/etc/cert"
              name: server-cert
              readOnly: true
            - mountPath: "/etc/cacert"
              name: ca-cert
              readOnly: true
          resources:
            requests:
              cpu: 10m
      volumes:
        - name: server-cert
          secret:
            secretName: server-cert
        - name: ca-cert
          secret:
            secretName: gateway-cert-cacert
\`\`\`

## Configure the Route

\`\`\`yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    # backend protocol
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    # gateway to backend mtls
    nginx.ingress.kubernetes.io/proxy-ssl-secret: "default/gateway-cert"
    # SNI for backend check
    nginx.ingress.kubernetes.io/proxy-ssl-name: "https-httpbin-v1.default.svc.cluster.local"
    nginx.ingress.kubernetes.io/proxy-ssl-server-name: "on"
  name: ingress-https-httpbin
  namespace: default
spec:
  ingressClassName: higress
  rules:
    - host: foo.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: https-httpbin-v1
                port:
                  number: 443
\`\`\`

Ingress Annotation configuration:
- \`nginx.ingress.kubernetes.io/backend-protocol\` specifies the protocol used by the backend service. The default is HTTP, and it supports HTTP, HTTP2, HTTPS, GRPC, and GRPCS.
- \`nginx.ingress.kubernetes.io/proxy-ssl-secret\` enables mtls by specifying the gateway certificate, in the format \`namespace/secret-name\`. Note that you also need to create a CA certificate secret with the name of the proxy-ssl-secret plus the \`-cacert\` suffix, such as \`gateway-cert-cacert\`, otherwise it will report an error.
- \`nginx.ingress.kubernetes.io/proxy-ssl-name\` specifies the domain name used by the backend service for SNI verification.
- \`nginx.ingress.kubernetes.io/proxy-ssl-server-name\` enables SNI.


# Testing

\`\`\`shell
curl -H "host: foo.com" http://127.0.0.1/ping

"pong"`},l=function(){return s},i=function(){return[{depth:2,slug:"prerequisites",text:"Prerequisites"},{depth:2,slug:"prepare-certificates",text:"Prepare Certificates"},{depth:2,slug:"prepare-the-backend-https-httpbin-service",text:"Prepare the Backend https-httpbin Service"},{depth:2,slug:"configure-the-route",text:"Configure the Route"},{depth:1,slug:"testing",text:"Testing"}]},e=d((f,h,g)=>{const{layout:m,...p}=n;return p.file=a,p.url=t,r`${o()}${y(s)}`})});export{e as Content,u as __tla,l as compiledContent,e as default,a as file,n as frontmatter,i as getHeadings,c as rawContent,t as url};
