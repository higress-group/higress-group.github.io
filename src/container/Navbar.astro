---
// Navbar component with left-center-right layout
import SearchButton from '../components/SearchButton.astro';
import LanguageSelect from '../components/LanguageSelect.astro';
import Dropdown from '../components/dropdown/Dropdown.astro';
import { useTranslations } from "../i18n/utils";
import Button from '../components/button/Button.astro';
import MobileNavbar from './mobile/MobileNavbar.astro';

const locale = Astro.currentLocale || 'root';
const t = useTranslations(locale);

const currentPath = Astro.url.pathname;
const isEnglish = currentPath === '/en' || currentPath.startsWith('/en/');
const homeUrl = isEnglish ? '/en' : '/';

// Determine if we are on the home page
const isHome = currentPath === '/' || currentPath === '/en' || currentPath === '/en/';
const isProducts = /himarket|ai-gateway|api-gateway|blog/.test(currentPath);
// Set default to transparent for all pages. Scroll effect only applies to Home.
const navClass = "bg-transparent";

// Helper function to add locale prefix to internal links
const localizeUrl = (url: string) => {
  // Don't modify external URLs (starting with http:// or https://)
  if (url.startsWith('http://') || url.startsWith('https://')) {
    return url;
  }
  // Add /en prefix for English locale
  return isEnglish ? `/en${url}` : url;
};

const navItems = [
  {
    type: 'dropdown',
    label: t('navbar.product'),
    items: [
      { label: t('page.header.gateway'), href: localizeUrl('/api-gateway') },
      { label: t('page.header.ai.gateway'), href: localizeUrl('/ai-gateway') },
      { label: 'HiMarket', href: localizeUrl('/himarket') },
    ]
  },
  {
    type: 'link',
    label: t('navbar.docs'),
    href: localizeUrl('/docs/latest/overview/what-is-higress'),
  },
  {
    type: 'link',
    label: t('navbar.enterprise'),
    href: "https://www.aliyun.com/product/api-gateway",
    target: "blank",
  },
  {
    type: 'dropdown',
    label: t('navbar.community'),
    items: [
      { label: t('navbar.community.blog'), href: localizeUrl('/blog') },
      { label: t('navbar.community.developer'), href: localizeUrl('/docs/developers/developers_dev') },
    ]
  }
];
---

<nav id="main-nav" class:list={["fixed top-0 left-0 right-0 z-50 transition-all duration-300", navClass]} data-is-home={String(isHome || isProducts)}>
  <div class="mx-auto px-4 lg:px-10">
    <div class="flex h-16 items-center justify-between">
      <!-- Left: Logo -->
      <div class="flex flex-1 items-center">
        <a href={homeUrl} class="min-w-33.75 flex items-center">
          <img src="/images/logo.svg" alt="Higress Logo" class="h-8 w-auto" />
        </a>
      </div>

      <!-- Center: Navigation Links (Desktop) -->
      <div class="nav-links hidden lg:flex items-center">
        {navItems.map((item, index) => (
          <div class="nav-link">
            {item.type === 'dropdown' ? (
              <Dropdown label={item.label} items={item.items} />
            ) : (
              <a
                href={item.href}
                target={item.target}
                class="text-sm text-strong hover:text-primary no-underline transition-colors px-2"
              >
                {item.label}
              </a>
            )}
          </div>
        ))}
      </div>
      <!-- Right: Search, Theme & Language Toggle -->
      <div class="flex flex-1 items-center justify-end gap-4">
        <!-- Language Select -->
        <LanguageSelect />
        <!-- Search -->
        <SearchButton />

        <div class="hidden lg:block">
          <Button mode="black" width='120px'>
            <a
              class="text-white"
              href="https://github.com/alibaba/higress"
              target="_blank"
            >
              GITHUB
            </a>
          </Button>
        </div>

        <!-- Mobile Menu Button -->
        <button
          id="mobile-menu-btn"
          type="button"
          class="lg:hidden flex p-2 focus:outline-none bg-transparent"
          aria-label="Toggle menu"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <MobileNavbar navItems={navItems} homeUrl={homeUrl} />
</nav>

<script>
  const nav = document.getElementById('main-nav');
  const isHome = nav?.dataset.isHome === 'true';

  // Scroll effect logic
  if ((isHome) && nav) {
    const handleScroll = () => {
      if (window.scrollY > 20) {
        nav.classList.remove('bg-transparent');
        nav.classList.add('bg-white/20', 'backdrop-blur-sm', 'shadow-sm');
      } else {
        nav.classList.add('bg-transparent');
        nav.classList.remove('bg-white/20', 'backdrop-blur-sm', 'shadow-sm');
      }
    };

    window.addEventListener('scroll', handleScroll);
    handleScroll();
  }
</script>

<style>
  .nav-links {
    .nav-link {
      position: relative;
      display: flex;
      align-items: center;
      height: 1.75rem;
      padding: 0 1rem;
      &:not(:last-child) {
        &::after {
          content: "";
          position: absolute;
          width: 1px;
          height: 60%;
          background-color: var(--color-black);
          right: 0;
        }
      }
    }
  }
</style>
