---
// Navbar component with left-center-right layout
import Search from '../components/starlight/Search.astro';
import LanguageSelect from '../components/LanguageSelect.astro';
import Dropdown from '../components/dropdown/Dropdown.astro';
import { useTranslations, localizeUrl } from "../i18n/utils";
import Button from '../components/button/Button.astro';
import MobileNavbar from './mobile/MobileNavbar.astro';
import { LINKS } from '@/constant';
import { getNavbarConfig, isHomePage } from '../utils/navbarConfig';

const locale = Astro.currentLocale || 'root';
const t = useTranslations(locale);

const currentPath = Astro.url.pathname;
const isEnglish = currentPath === '/en' || currentPath.startsWith('/en/');
const homeUrl = isEnglish ? '/en' : '/';

// 获取当前页面的导航栏配置
const navbarConfig = getNavbarConfig(currentPath);
const isHome = isHomePage(currentPath);
const navClass = navbarConfig.initialBackground;

const navItems = [
  {
    type: 'dropdown',
    label: t('navbar.product'),
    items: [
      { label: t('page.header.gateway'), href: localizeUrl('/api-gateway', locale) },
      { label: t('page.header.ai.gateway'), href: localizeUrl('/ai-gateway', locale) },
      { label: 'HiMarket', href: localizeUrl('/himarket', locale) },
    ]
  },
  {
    type: 'link',
    label: t('navbar.docs'),
    href: localizeUrl('/docs/latest/overview/what-is-higress', locale),
  },
  {
    type: 'link',
    label: t('navbar.enterprise'),
    href: LINKS.enterprise,
    target: "blank",
  },
  {
    type: 'dropdown',
    label: t('navbar.community'),
    items: [
      { label: t('navbar.community.blog'), href: localizeUrl('/blog', locale) },
      { label: t('navbar.community.glossary'), href: localizeUrl('/glossary', locale) },
      { label: t('navbar.community.plugins'), href: localizeUrl('/plugins', locale) },
      { label: t('navbar.community.developer'), href: localizeUrl('/docs/developers/developers_dev', locale) },
    ]
  }
];

// Helper to check if a link is active
const checkIsActive = (href: string | undefined) => {
  if (!href || href.startsWith('http')) return false;

  const normalize = (p: string) => p.endsWith('/') ? p.slice(0, -1) : p;
  const path = normalize(currentPath);
  const target = normalize(href);

  // Docs
  if (target.includes('/docs/latest')) {
     return path.includes('/docs') && !path.includes('/docs/developers');
  }
  
  // Blog
  if (target.includes('/blog')) {
    return path.includes('/blog');
  }

  // Developers
  if (target.includes('/docs/developers')) {
    return path.includes('/docs/developers');
  }

  return path === target || path.startsWith(target + '/');
};

const isItemActive = (item: any) => {
  if (item.type === 'dropdown') {
    return item.items?.some((sub: any) => checkIsActive(sub.href));
  }
  return checkIsActive(item.href);
};
---

<nav id="main-nav" class:list={["fixed top-0 left-0 right-0 z-50 transition-all duration-300", navClass]} data-is-home={String(isHome)}>
  <div class="mx-auto px-4 lg:px-10">
    <div class="flex h-16 items-center justify-between">
      <!-- Left: Logo -->
      <div class="flex flex-1 items-center">
        <a href={homeUrl} class="min-w-33.75 flex items-center">
          <img src="https://img.alicdn.com/imgextra/i3/O1CN01H2YwEH1OL9g5izfgK_!!6000000001688-55-tps-101-24.svg" alt="Higress Logo" class="h-6 w-auto" decoding="async" fetchpriority="high" />
        </a>
      </div>

      <!-- Center: Navigation Links (Desktop) -->
      <div class="nav-links hidden lg:flex items-center">
        {navItems.map((item) => {
          const isActive = isItemActive(item);
          // Calculate active state for dropdown items if they exist
          const dropdownItems = item.type === 'dropdown' && item.items 
            ? item.items.map(sub => ({
                ...sub,
                active: checkIsActive(sub.href)
              }))
            : undefined;

          let displayLabel = item.label;
          if (dropdownItems) {
            const activeItem = dropdownItems.find(d => d.active);
            if (activeItem) {
              displayLabel = activeItem.label;
            }
          }

          return (
          <div class="nav-link">
            {item.type === 'dropdown' ? (
              <Dropdown label={displayLabel} items={dropdownItems} isActive={isActive} />
            ) : (
              <a
                href={item.href}
                target={item.target}
                class:list={[
                  "text-sm hover:text-primary no-underline transition-colors px-2",
                  isActive ? "text-primary" : "text-strong"
                ]}
              >
                {item.label}
              </a>
            )}
          </div>
        )})}
      </div>
      <!-- Right: Search, Theme & Language Toggle -->
      <div class="flex flex-1 items-center justify-end gap-4">
        <!-- Language Select -->
        <LanguageSelect />
        <!-- Search -->
        <Search />

        <div class="hidden lg:block">
          <a
            href={LINKS.higressGithub}
            target="_blank"
            class="inline-flex items-center justify-center w-10 h-10 transition-opacity hover:opacity-70"
            aria-label="GitHub"
          >
            <svg class="w-6 h-6 fill-current text-strong" viewBox="0 0 24 24">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
          </a>
        </div>

        <!-- Mobile Menu Button -->
        <button
          id="mobile-menu-btn"
          type="button"
          class="lg:hidden flex p-2 focus:outline-none bg-transparent"
          aria-label="Toggle menu"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <MobileNavbar navItems={navItems} homeUrl={homeUrl} />
</nav>

<script>
  import { getNavbarConfig } from '../utils/navbarConfig';
  
  const nav = document.getElementById('main-nav');

  if (nav) {
    // 获取当前页面的导航栏配置
    const currentPath = window.location.pathname;
    const config = getNavbarConfig(currentPath);
    
    if (config.enableScrollEffect) {
      const handleScroll = () => {
        if (window.scrollY > config.scrollThreshold) {
          nav.classList.remove(config.initialBackground);
          nav.classList.add(...config.scrollClasses);
        } else {
          nav.classList.add(config.initialBackground);
          nav.classList.remove(...config.scrollClasses);
        }
      };

      window.addEventListener('scroll', handleScroll);
      // Initialize on page load
      handleScroll();
    }
  }
</script>

<style>
  .nav-links {
    .nav-link {
      position: relative;
      display: flex;
      align-items: center;
      height: 1.75rem;
      padding: 0 1rem;
      &:not(:last-child) {
        &::after {
          content: "";
          position: absolute;
          width: 1px;
          height: 60%;
          background-color: var(--color-black);
          right: 0;
        }
      }
    }
  }

</style>
