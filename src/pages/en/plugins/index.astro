---
import SiteLayout from "../../../layout/siteLayout.astro";
import { PLUGINS, PLUGIN_CATEGORIES, type PluginCategory } from "../../../utils/pSEOData";
import { useTranslations } from "@/i18n/utils";
import { LINKS } from "@/constant";

const locale = 'en';
const t = useTranslations(locale);
const isZh = false;

const title = "Higress Plugin Marketplace - Rich Gateway Plugin Ecosystem";
const description = "Explore Higress official plugin library with 40+ plugins covering AI, authentication, security, traffic management and more.";

// æŒ‰åˆ†ç±»åˆ†ç»„æ’ä»¶
const pluginsByCategory = PLUGIN_CATEGORIES.map(cat => ({
  ...cat,
  plugins: PLUGINS.filter(p => p.category === cat.id)
}));

// åˆ†ç±»å›¾æ ‡æ˜ å°„
const categoryIcons: Record<PluginCategory, string> = {
  ai: 'ğŸ¤–',
  authentication: 'ğŸ”',
  security: 'ğŸ›¡ï¸',
  traffic: 'ğŸš¦',
  transformation: 'ğŸ”„',
};
---

<SiteLayout title={title} description={description} keywords="Higress plugins,API gateway plugins,Wasm plugins,AI plugins,authentication,rate limiting,WAF">
  <div class="bg-gradient-to-b from-gray-50 to-white min-h-screen">
    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-primary/5 via-primary/10 to-primary/5 py-16 px-4 sm:px-6 lg:px-8">
      <div class="max-w-7xl mx-auto text-center">
        <h1 class="text-4xl font-extrabold text-gray-900 sm:text-5xl lg:text-6xl">
          {t('plugins.hero.title')}
        </h1>
        <p class="mt-6 text-xl text-gray-600 max-w-3xl mx-auto">
          {t('plugins.hero.description')}
        </p>

        <!-- Search Bar -->
        <div class="mt-10 max-w-2xl mx-auto relative group">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 flex items-center justify-center pointer-events-none z-10 w-14">
              <svg class="h-5 w-5 text-primary transition-colors flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <input
              type="text"
              id="plugin-search"
              placeholder={t('plugins.search.placeholder')}
              class="block w-full pl-14 pr-4 py-4 border-2 border-primary rounded-2xl leading-5 bg-white placeholder-gray-400 focus:outline-none focus:ring-0 focus:border-primary transition-all text-lg shadow-sm group-hover:shadow-md"
            />
          </div>
          <div class="mt-4 flex justify-center gap-4 flex-wrap">
            <span class="px-4 py-2 bg-white rounded-full text-sm text-gray-600 shadow-sm border border-gray-100">
              {t('plugins.stats.total')} <strong class="text-primary">{PLUGINS.length}</strong> {t('plugins.stats.plugins')}
            </span>
            <span class="px-4 py-2 bg-white rounded-full text-sm text-gray-600 shadow-sm border border-gray-100">
              {t('plugins.stats.covered')} <strong class="text-primary">{PLUGIN_CATEGORIES.length}</strong> {t('plugins.stats.categories')}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Category Navigation -->
    <div class="sticky top-16 z-10 bg-white/80 backdrop-blur-md border-b border-gray-200 py-4 shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide items-center">
          <button
            data-category-filter="all"
            class="category-btn flex-shrink-0 px-5 py-2 rounded-full bg-primary text-white text-sm font-medium transition-all shadow-sm"
          >
            {t('plugins.category.all')}
          </button>
          {PLUGIN_CATEGORIES.map(cat => (
            <button
              data-category-filter={cat.id}
              class="category-btn flex-shrink-0 px-5 py-2 rounded-full bg-gray-100 hover:bg-primary/10 hover:text-primary text-gray-700 text-sm font-medium transition-all"
            >
              <span class="mr-1.5">{categoryIcons[cat.id]}</span>
              {cat.labelEn}
            </button>
          ))}
        </div>
      </div>
    </div>

    <!-- Plugins by Category -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
      <div id="no-results" class="hidden text-center py-20">
        <div class="text-6xl mb-4">ğŸ”</div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">{t('plugins.no_results.title')}</h3>
        <p class="text-gray-500">{t('plugins.no_results.description')}</p>
      </div>

      {pluginsByCategory.map(cat => (
        <section
          data-category-section={cat.id}
          class="mb-20 scroll-mt-36 transition-opacity duration-300"
        >
          <div class="flex items-center gap-4 mb-8">
            <span class="text-4xl">{categoryIcons[cat.id]}</span>
            <div>
              <h2 class="text-3xl font-bold text-gray-900">{cat.labelEn}</h2>
              <p class="text-gray-600 mt-1">{cat.descriptionEn}</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {cat.plugins.map(plugin => (
              <a
                href={`/docs/latest/${plugin.docPath}/`}
                data-plugin-card
                data-plugin-name={plugin.name.toLowerCase()}
                data-plugin-name-en={plugin.nameEn.toLowerCase()}
                data-plugin-description={plugin.description.toLowerCase()}
                data-plugin-description-en={plugin.descriptionEn.toLowerCase()}
                class="group bg-white rounded-xl border border-gray-200 p-6 hover:border-primary/30 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1"
              >
                <div class="flex items-start justify-between mb-3">
                  <h3 class="text-lg font-bold text-gray-900 group-hover:text-primary transition-colors">
                    {plugin.nameEn}
                  </h3>
                  <svg class="h-5 w-5 text-gray-400 group-hover:text-primary group-hover:translate-x-1 transition-all" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </div>
                <p class="text-gray-600 text-sm line-clamp-3 leading-relaxed">
                  {plugin.descriptionEn}
                </p>
              </a>
            ))}
          </div>
        </section>
      ))}
    </div>

    <!-- CTA Section -->
    <div class="bg-gradient-to-r from-primary/5 via-primary/10 to-primary/5 py-16 px-4 sm:px-6 lg:px-8">
      <div class="max-w-3xl mx-auto text-center">
        <h2 class="text-3xl font-bold text-gray-900 mb-4">
          {t('plugins.cta.title')}
        </h2>
        <p class="text-lg text-gray-600 mb-8">
          {t('plugins.cta.description')}
        </p>
        <div class="flex justify-center gap-4 flex-wrap">
          <a
            href="/docs/latest/plugins/custom/"
            class="px-8 py-3 bg-primary text-white font-medium rounded-lg hover:bg-primary/90 transition shadow-md hover:shadow-lg"
          >
            {t('plugins.cta.custom_plugin')}
          </a>
          <a
            href={LINKS.higressGithub}
            target="_blank"
            class="px-8 py-3 bg-white text-gray-700 font-medium rounded-lg border border-gray-300 hover:border-primary hover:text-primary transition shadow-sm hover:shadow-md"
          >
            {t('plugins.cta.contribute')}
          </a>
        </div>
      </div>
    </div>
  </div>
</SiteLayout>

<script>
  const searchInput = document.getElementById('plugin-search') as HTMLInputElement;
  const categoryBtns = document.querySelectorAll('.category-btn');
  const sections = document.querySelectorAll('[data-category-section]');
  const cards = document.querySelectorAll('[data-plugin-card]');
  const noResults = document.getElementById('no-results');

  let currentCategory = 'all';
  let currentSearch = '';

  function filterPlugins() {
    let hasVisiblePlugins = false;

    sections.forEach(section => {
      const categoryId = section.getAttribute('data-category-section');
      const sectionCards = section.querySelectorAll('[data-plugin-card]');
      let visibleInSection = false;

      sectionCards.forEach(card => {
        const name = card.getAttribute('data-plugin-name') || '';
        const nameEn = card.getAttribute('data-plugin-name-en') || '';
        const description = card.getAttribute('data-plugin-description') || '';
        const descriptionEn = card.getAttribute('data-plugin-description-en') || '';

        const matchesSearch = !currentSearch ||
          name.includes(currentSearch) ||
          nameEn.includes(currentSearch) ||
          description.includes(currentSearch) ||
          descriptionEn.includes(currentSearch);

        const matchesCategory = currentCategory === 'all' || categoryId === currentCategory;

        if (matchesSearch && matchesCategory) {
          (card as HTMLElement).style.display = 'block';
          visibleInSection = true;
          hasVisiblePlugins = true;
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });

      if (visibleInSection) {
        (section as HTMLElement).style.display = 'block';
      } else {
        (section as HTMLElement).style.display = 'none';
      }
    });

    if (noResults) {
      noResults.classList.toggle('hidden', hasVisiblePlugins);
    }
  }

  searchInput?.addEventListener('input', (e) => {
    currentSearch = (e.target as HTMLInputElement).value.toLowerCase();
    filterPlugins();
  });

  categoryBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const categoryId = btn.getAttribute('data-category-filter') || 'all';

      // Update UI
      categoryBtns.forEach(b => {
        b.classList.remove('bg-primary', 'text-white', 'shadow-sm');
        b.classList.add('bg-gray-100', 'text-gray-700');
      });
      btn.classList.add('bg-primary', 'text-white', 'shadow-sm');
      btn.classList.remove('bg-gray-100', 'text-gray-700');

      currentCategory = categoryId;
      filterPlugins();
    });
  });
</script>

<!-- SEO: Structured Data -->
<script type="application/ld+json" set:html={JSON.stringify({
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": title,
  "description": description,
  "numberOfItems": PLUGINS.length,
  "itemListElement": PLUGINS.slice(0, 10).map((plugin, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "name": plugin.nameEn,
    "description": plugin.descriptionEn,
    "url": `https://higress.ai/docs/latest/${plugin.docPath}/`
  }))
})} />

<script type="application/ld+json" set:html={JSON.stringify({
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://higress.ai/en/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Plugin Marketplace",
      "item": "https://higress.ai/en/plugins/"
    }
  ]
})} />

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
