---
import Default from '@astrojs/starlight/components/PageTitle.astro';
import fs from 'fs/promises';
import path from 'path';
import Button from '../button/Button.astro';
import { useTranslations } from '../../i18n/utils';

// 获取当前页面的路径信息
const currentPath = Astro.url.pathname;

const t = useTranslations(Astro.currentLocale);
// 在构建时读取 markdown 原始内容
let markdownContent = '';
try {
  const mdFilePath = currentPath.split('/').filter(Boolean).join('/');
  const fullPath = path.join(process.cwd(), 'src/content/docs', `${mdFilePath}.md`);

  try {
    markdownContent = await fs.readFile(fullPath, 'utf-8');
  } catch (readError) {
    // 如果 .md 不存在，尝试 .mdx
    const mdxPath = path.join(process.cwd(), 'src/content/docs', `${mdFilePath}.mdx`);
    try {
      markdownContent = await fs.readFile(mdxPath, 'utf-8');
    } catch {
      console.warn(`Failed to read markdown file: ${fullPath}`);
    }
  }
} catch (error) {
  console.error('Failed to read markdown content:', error);
}
---

<div class="page-header-wrapper mt-10 md:mt-0">
  <!-- 隐藏的 markdown 内容存储 -->
  <div id="markdown-content-storage" style="display: none;">{markdownContent}</div>

  <!-- 顶部操作栏 -->
  <nav aria-label="Page actions" class="page-actions-nav relative">
    <!-- Back 按钮 -->
    <Button contentAlign='center' width='auto' class="sm:w-22.5 justify-center! sm:justify-between!" mode="gray" id="back-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
      <span class="button-text hidden sm:inline ml-2 sm:ml-0">{t('page.title.back')}</span>
    </Button>

    <div class="absolute right-0 top-0 md:top-17">
      <!-- 组合按钮：外观是一个按钮，内部分两个点击区域 -->
      <div class="combined-button flex items-stretch border rounded-full overflow-hidden bg-white">
        <!-- 左侧：复制区域 -->
        <button
          id="copy-main-btn"
          class="flex items-center px-3 sm:px-4 py-2 hover:bg-gray-50 transition-colors flex-1"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          <span class="button-text ml-2 sm:ml-3 text-xs sm:text-sm whitespace-nowrap">{t('page.title.copy_page')}</span>
        </button>

        <!-- 分隔线 -->
        <div class="w-px"></div>

        <!-- 右侧：菜单触发区域 -->
        <button
          id="action-menu-btn"
          class="flex items-center justify-center px-2 sm:px-3 py-2 hover:bg-gray-50 transition-colors"
        >
          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>

      <!-- Dropdown Menu -->
      <div id="action-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-50 hidden border border-gray-100">
        <div class="p-2 space-y-1">
          <button id="copy-menu-item" class="w-full group rounded-lg bg-white text-left px-4 py-2 text-sm text-black hover:bg-indigo-20 hover:text-primary flex items-center">
            <svg class="mr-2 h-4 w-4 text-black group-hover:text-primary" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        {t('page.title.copy_page')}
                      </button>
                      <button id="view-markdown-item" class="w-full group rounded-lg bg-white text-left px-4 py-2 text-sm text-black hover:bg-indigo-20 hover:text-primary flex items-center">             <svg class="mr-2 h-4 w-4 text-black group-hover:text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
            {t('page.title.view_markdown')}
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- 原始的 PageTitle 组件 -->
  <Default {...Astro.props} />
</div>

<div id="i18n-data"
  data-copied={t('page.title.copied')}
  data-copy-failed={t('page.title.copy_failed')}
  style="display: none;"
></div>

<script>
  // Back 按钮功能
  const backButton = document.getElementById('back-btn');

  if (backButton) {
    backButton.addEventListener('click', () => {
      // 检查是否有历史记录
      if (window.history.length > 1) {
        window.history.back();
      } else {
        // 如果没有历史记录，返回首页
        window.location.href = '/';
      }
    });
  }

  // 复制功能 - 统一的复制逻辑
  const markdownStorage = document.getElementById('markdown-content-storage');
  const i18nData = document.getElementById('i18n-data') as HTMLElement;
  const copiedText = i18nData?.dataset.copied || 'Copied!';
  const copyFailedText = i18nData?.dataset.copyFailed || 'Copy failed';

  const copyMarkdown = async (button: HTMLElement) => {
    try {
      const content = markdownStorage?.textContent;
      if (!content) throw new Error('No content');

      await navigator.clipboard.writeText(content);

      // 显示复制成功提示
      const originalHTML = button.innerHTML;
      button.innerHTML = `<span class="text-green-600 font-bold">${copiedText}</span>`;
      setTimeout(() => {
        button.innerHTML = originalHTML;
      }, 1500);
    } catch (err) {
      console.error('Copy failed', err);
      alert(copyFailedText);
    }
  };

  // 主复制按钮功能
  const copyMainBtn = document.getElementById('copy-main-btn');
  if (copyMainBtn) {
    copyMainBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      copyMarkdown(copyMainBtn);
    });
  }

  // 菜单交互逻辑
  const menuBtn = document.getElementById('action-menu-btn');
  const menu = document.getElementById('action-menu');

  // 菜单中的复制按钮功能
  const copyMenuBtn = document.getElementById('copy-menu-item');
  if (copyMenuBtn && menu) {
    copyMenuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      copyMarkdown(copyMenuBtn);
      // 复制后延迟关闭菜单，让用户看到“已复制”状态
      setTimeout(() => {
        menu.classList.add('hidden');
      }, 500);
    });
  }

  // 切换菜单
  if (menuBtn && menu) {
    menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      menu.classList.toggle('hidden');
    });

    // 点击外部关闭
    document.addEventListener('click', (e) => {
      if (!menu.contains(e.target as Node) && !menuBtn.contains(e.target as Node)) {
        menu.classList.add('hidden');
      }
    });
  }

  // 查看 Markdown 功能 - 直接跳转到源文件
  const viewMarkdownBtn = document.getElementById('view-markdown-item');

  // 获取当前页面的 Markdown 文件路径
  const getMarkdownFilePath = () => {
    const currentPath = window.location.pathname;

    // 移除开头的斜杠
    let path = currentPath.replace(/^\//, '');

    // 移除末尾的斜杠
    path = path.replace(/\/$/, '');

    // 检查是否是英文路径
    const isEnglish = path.startsWith('en/');

    // 移除 en/ 前缀（如果存在）来获取实际的文档路径
    const docPath = isEnglish ? path.replace(/^en\//, '') : path;

    // 构建文件路径
    // 如果是英文: /overview/en/{docPath}.md
    // 如果是中文: /overview/{docPath}.md
    const filePath = isEnglish
      ? `/overview/en/${docPath}.md`
      : `/overview/${docPath}.md`;

    return filePath;
  };

  // 点击按钮跳转到源文件
  if (viewMarkdownBtn) {
    viewMarkdownBtn.addEventListener('click', () => {
      const filePath = getMarkdownFilePath();
      // 在新标签页打开源文件
      window.open(filePath, '_blank');
    });
  }
</script>

<style>
  .page-header-wrapper {
    margin-bottom: 1rem;
  }

  .page-actions-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
  }

  .combined-button {
    border-color: var(--color-gray-02);
  }

  .combined-button .w-px {
    background-color: var(--color-gray-02);
  }

  .combined-button button {
    color: var(--color-black);
    background-color: #fff;
  }
</style>
