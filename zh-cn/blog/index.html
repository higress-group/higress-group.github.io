<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Blog | Higress</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://higress.io/zh-cn/img/higress_logo_small.png"><meta data-rh="true" name="twitter:image" content="https://higress.io/zh-cn/img/higress_logo_small.png"><meta data-rh="true" property="og:url" content="https://higress.io/zh-cn/blog"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="keywords" content="higress,higress官网,云原生网关"><meta data-rh="true" property="og:title" content="Blog | Higress"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/zh-cn/img/higress_logo_small.png"><link data-rh="true" rel="canonical" href="https://higress.io/zh-cn/blog"><link data-rh="true" rel="alternate" href="https://higress.io/en-us/blog" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://higress.io/zh-cn/blog" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://higress.io/blog" hreflang="default"><link data-rh="true" rel="alternate" href="https://higress.io/blog" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Higress RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Higress Atom Feed">




<link rel="stylesheet" href="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.js"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-YHS75WKFBR" async></script><link rel="stylesheet" href="/zh-cn/assets/css/styles.d24e4978.css">
<link rel="preload" href="/zh-cn/assets/js/runtime~main.72d24805.js" as="script">
<link rel="preload" href="/zh-cn/assets/js/main.3644cddb.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="//img.alicdn.com/imgextra/i1/O1CN01I7WjVs1K33EQjInid_!!6000000001107-2-tps-960-290.png" alt="Higress logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="//img.alicdn.com/imgextra/i1/O1CN01I7WjVs1K33EQjInid_!!6000000001107-2-tps-960-290.png" alt="Higress logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><a class="navbar__item navbar__link" href="/zh-cn/docs/overview/what-is-higress">文档</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Higress 企业版</a><ul class="dropdown__menu"><li><a href="https://www.aliyun.com/product/aliware/mse?spm=higress-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">企业版说明</a></li><li><a href="https://free.aliyun.com/?searchKey=云原生网关&amp;spm=higress-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">免费试用</a></li></ul></div><a href="https://survey.aliyun.com/apps/zhiliao/SmDQwdihe" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">案例征集</a><a class="navbar__item navbar__link" href="/zh-cn/docs/developers/developers_dev">开发者</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a href="https://github.com/alibaba/higress/releases" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">下载</a><a href="http://demo.higress.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">控制台样例</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/en-us/blog" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/blog" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/admin-sdk-intro">如何使用 Higress Admin SDK 进行配置管理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/higress-code">higress-core源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/e2e-debug">教程：如何在本地进行higress调试和端到端测试</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/hring">Higress 团队招募小伙伴加入～</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/release-1.3">Higress 开源一周年：新版本，新标准，新工具，新征程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/plugin-transformer">通过 Higress Wasm 插件 3 倍性能实现 Spring-cloud-gateway 功能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2023-kubecon">Higress在2023 KubeCon China的分享</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/config-with-file">基于文件配置实现 Higress 极简独立部署</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/DeployOnWindows">Windows 下 Higress 部署实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/configmap">Higress 全局配置控制面原理分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/ai_plugin">Higress助力AI大模型企业级应用落地</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/user-mq">美洽智能客服使用 Higress 统一网关落地实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/skywalking">Higress 集成 Skywalking 可观测性探索</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/ospp-2023">Higress 开源之夏项目报名</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/release-100">上线控制台，降低使用门槛 ｜ Higress 1.0.0 RC 版本发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/user-uu">UU跑腿基于Higress的云原生网关实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/release-070">Higress 0.7.0 版本发布：GA 进入倒计时</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos">Higress + Nacos 微服务网关最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/30-line-wasm">30行代码写一个Wasm Go插件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/first-meetup">欢迎报名Higress首次线下Meetup</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/higress">阿里巴巴重磅开源云原生网关</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/admin-sdk-intro">如何使用 Higress Admin SDK 进行配置管理</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-02-08T00:00:00.000Z" itemprop="datePublished">2024年2月8日</time> · <!-- -->阅读需 5 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">CH3CHO</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Higress 一个遵循开源 Ingress/Gateway API 标准，提供流量调度、服务治理、安全防护三合一的高集成、易使用、易扩展、热更新的下一代云原生网关。而配置管理网关的运维工作中扮演者重要的角色。如何让配置管理自动化，尤其是与其他的运维系统进行对接，就成为了一个非常迫切的需求。本文将介绍如何使用 Higress Admin SDK 来管理 Higress 系统内的各类配置。希望能够对存在此类需求的朋友有所帮助。</p><h1>2. Higress Admin SDK</h1><p>Higress Admin SDK 脱胎于 Higress Console。起初，它是作为 Higress Console 的一部分，为前端界面提供实际的功能支持。后来考虑到对接外部系统等需求，我们将配置管理的部分剥离出来，形成一个独立的逻辑组件，便于各个系统进行对接。目前支持服务来源管理、服务管理、路由管理、域名管理、证书管理、插件管理等功能。</p><p>Higress Admin SDK 现在只提供 Java 版本，且要求 JDK 版本不低于 17。</p><h1>3. 开发实操</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="31-环境准备">3.1 环境准备<a href="#31-环境准备" class="hash-link" aria-label="3.1 环境准备的直接链接" title="3.1 环境准备的直接链接">​</a></h2><p>这里我们以本地基于 Kind 搭建的 K8s 集群作为实验环境。所以首先，请大家参考这篇<a href="https://higress.io/zh-cn/docs/user/quickstart#%E5%9C%BA%E6%99%AF%E4%BA%8C%E5%9C%A8%E6%9C%AC%E5%9C%B0-k8s%E7%8E%AF%E5%A2%83%E4%B8%AD%E4%BD%BF%E7%94%A8" target="_blank" rel="noopener noreferrer">文档</a>在本地完成 K8s 集群的搭建和 Higress 的安装。</p><p>然后，我们需要创建一个测试用的 K8s 服务。大家可以将下方的 YAML 保存为 <code>test.yaml</code>，然后执行 <code>kubectl apply -f test.yaml</code> 命令在 K8s 中创建对应的资源。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mendhak/http</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">https</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">29</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="32-代码编写">3.2 代码编写<a href="#32-代码编写" class="hash-link" aria-label="3.2 代码编写的直接链接" title="3.2 代码编写的直接链接">​</a></h2><p>这里的目标是创建一个路由，使 <code>http://www.test.com/</code> 这个 URL 指向我们刚刚创建的 <code>higress-demo-service</code>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="第一步配置依赖">第一步：配置依赖<a href="#第一步配置依赖" class="hash-link" aria-label="第一步：配置依赖的直接链接" title="第一步：配置依赖的直接链接">​</a></h3><p>根据项目所使用的构建工具来添加 Higress Admin SDK 依赖：</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">io.higress.api</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">higress-admin-sdk</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">0.0.2</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-gradle codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gradle codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">implementation</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;io.higress.api:higress-admin-sdk:0.0.2&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="第二步创建-higress-sdk-实例">第二步：创建 Higress SDK 实例<a href="#第二步创建-higress-sdk-实例" class="hash-link" aria-label="第二步：创建 Higress SDK 实例的直接链接" title="第二步：创建 Higress SDK 实例的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">String</span><span class="token plain"> kubeConfigFile </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Paths</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.home&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/.kube/config&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">HigressServiceConfig</span><span class="token plain"> config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">HigressServiceConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">withKubeConfigPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kubeConfigFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">HigressServiceProvider</span><span class="token plain"> provider </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">HigressServiceProvider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里我们使用的是 K8s 集群外的配置方式，所以需要设置 kubeConfig 文件的路径，以便 SDK 操作 K8s 内的各类资源。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="第二步创建域名">第二步：创建域名<a href="#第二步创建域名" class="hash-link" aria-label="第二步：创建域名的直接链接" title="第二步：创建域名的直接链接">​</a></h3><p>这里我们使用 SDK 中的 <code>DomainService</code> 来创建一个 <code>www.test.com</code> 域名，并将该域名设置为只开放 HTTP 访问。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Domain</span><span class="token plain"> domain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Domain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;www.test.com&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enableHttps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Domain</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">EnableHttps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">OFF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">domainService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">domain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="第三步创建路由">第三步：创建路由<a href="#第三步创建路由" class="hash-link" aria-label="第三步：创建路由的直接链接" title="第三步：创建路由的直接链接">​</a></h3><p>这里我们使用 SDK 中的 <code>DomainService</code> 来创建一个名为 <code>higress-demo</code> 的路由。路由绑定 <code>www.test.com</code> 域名，匹配所有以 <code>/</code> 开头的请求，并将请求转发至 <code>higress-demo-service.default.svc.cluster.local</code> 服务的 8080 端口。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Route</span><span class="token plain"> route </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Route</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;higress-demo&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">domains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">singletonList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;www.test.com&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RoutePredicate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">matchType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RoutePredicateTypeEnum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">PRE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">matchValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">services</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">singletonList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">UpstreamService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;higress-demo-service.default.svc.cluster.local:8080&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">routeService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">route</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="33-测试验证">3.3 测试验证<a href="#33-测试验证" class="hash-link" aria-label="3.3 测试验证的直接链接" title="3.3 测试验证的直接链接">​</a></h2><p>执行编写好的代码：确认一切正常。然后在 Shell 中执行以下命令，检查请求路由情况。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -svk http://localhost/ -H </span><span class="token string" style="color:#e3116c">&quot;Host: www.test.com&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>能够以 JSON 格式返回请求的详细信息就说明路由配置已经可以正常工作。</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;path&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;headers&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;host&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;www.test.com&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;user-agent&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;curl/8.4.0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;accept&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*/*&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-forwarded-for&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10.42.0.230&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-forwarded-proto&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-envoy-internal&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-request-id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;4a3db96b-c46c-4c8a-a60f-a513f258736d&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-envoy-decorator-operation&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;higress-demo-service.default.svc.cluster.local:8080/*&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-envoy-attempt-count&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-b3-traceid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;a426d189c027371957f008c2cb2e9e8f&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-b3-spanid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;57f008c2cb2e9e8f&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-b3-sampled&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;req-start-time&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1707363093608&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;original-host&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;www.test.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;method&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;GET&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;body&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;fresh&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;hostname&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;www.test.com&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;ip&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10.42.0.230&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;ips&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;10.42.0.230&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;protocol&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;query&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;subdomains&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;www&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;xhr&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;os&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;hostname&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;higress-demo-app&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;connection&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-总结">4. 总结<a href="#4-总结" class="hash-link" aria-label="4. 总结的直接链接" title="4. 总结的直接链接">​</a></h2><p>目前 Higress Admin SDK 支持的功能还比较简单。未来社区也会在进一步着力增强 Higress 的治理侧功能，SDK 的能力也会不断完善。大家对 SDK 和 Console 有任何疑问和建议，都欢迎在 <a href="https://github.com/higress-group/higress-console" target="_blank" rel="noopener noreferrer">GitHub</a> 上提出。感谢大家的支持！</p><p>以上实操过程的项目代码可以在这里下载：<a target="_blank" href="/zh-cn/assets/files/20240208_higress-admin-sdk-demo-f1a76d3b8534c6c881dd6404e406ee4e.zip">下载链接</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/higress-code">higress-core源码分析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-01-25T00:00:00.000Z" itemprop="datePublished">2024年1月25日</time> · <!-- -->阅读需 27 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">SJC</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="引言">引言<a href="#引言" class="hash-link" aria-label="引言的直接链接" title="引言的直接链接">​</a></h2><p>在开源社区中，源码分析是深入理解项目内部机制的关键步骤。通过仔细研究项目的源代码，我们可以揭示背后的设计原理、算法和工作流程。这不仅有助于提高我们的编程技能，还可以为开发者社区提供宝贵的学习资源。</p><p>本文将聚焦于分析<a href="https://github.com/alibaba/higress" target="_blank" rel="noopener noreferrer">Higress</a>的源码，该项目在开源界备受瞩目。通过浏览阅读其代码，我们将初步展现其核心特性、架构设计和实现细节。希望各位用户以及开发者在本文中能够找到有价值的见解。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="关于higress">关于Higress<a href="#关于higress" class="hash-link" aria-label="关于Higress的直接链接" title="关于Higress的直接链接">​</a></h2><p>Higress是基于阿里内部的Envoy Gateway实践沉淀、以开源Istio + Envoy为核心构建的下一代云原生网关，实现了流量网关 + 微服务网关 + 安全网关三合一的高集成能力，深度集成Dubbo、Nacos、Sentinel等微服务技术栈，能够帮助用户极大的降低网关的部署及运维成本且能力不打折；在标准上全面支持Ingress与Gateway API，积极拥抱云原生下的标准API规范；同时，Higress Controller也支持Nginx Ingress平滑迁移，帮助用户零成本快速迁移到Higress。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="代码目录说明">代码目录说明<a href="#代码目录说明" class="hash-link" aria-label="代码目录说明的直接链接" title="代码目录说明的直接链接">​</a></h2><ul><li>cmd: 命令行参数解析等处理代码</li><li>pkg/ingress: Ingress 资源转换为 Istio 资源等相关代码</li><li>pkg/bootstrap: 包括启动 gRPC/xDS/HTTP server 等的代码</li><li>registry: 实现对接多种注册中心进行服务发现的代码</li><li>envoy: 依赖的 envoy 官方仓库 commit，以及对应的补丁代码</li><li>istio: 依赖的 istio 官方仓库 commit，以及对应的补丁代码</li><li>plugins: Higress 插件 sdk，以及官方内置插件代码</li><li>script: 编译相关脚本</li><li>docker: docker 镜像构建相关脚本</li></ul><p>本文主要围绕着higress-core组件的源码，研究higress-core自启动以来做了哪些事情。higress-core的代码主要位于<code>pkg</code>目录下。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higress-core源码整体分析">higress-core源码整体分析<a href="#higress-core源码整体分析" class="hash-link" aria-label="higress-core源码整体分析的直接链接" title="higress-core源码整体分析的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动入口pkgcmdservergo">启动入口：pkg/cmd/server.go<a href="#启动入口pkgcmdservergo" class="hash-link" aria-label="启动入口：pkg/cmd/server.go的直接链接" title="启动入口：pkg/cmd/server.go的直接链接">​</a></h3><p>在该文件下，主要进行了命令参数的解析，并调用<code>NewServer</code>来创建一个Server实例，调用该实例的<code>Start</code>方法来启动实例Server，调用<code>waitForMonitorSignal</code>方法来监听进程的退出。</p><p>显然这里有两个很重要的方法函数：<code>NewServer</code>和<code>Start</code>，接下来针对这两个函数进行具体分析。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建实例newserver">创建实例：NewServer<a href="#创建实例newserver" class="hash-link" aria-label="创建实例：NewServer的直接链接" title="创建实例：NewServer的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="初始化pilot的环境-apimodelenvironment">初始化Pilot的环境 API<code>model.Environment</code><a href="#初始化pilot的环境-apimodelenvironment" class="hash-link" aria-label="初始化pilot的环境-apimodelenvironment的直接链接" title="初始化pilot的环境-apimodelenvironment的直接链接">​</a></h4><p><code>model.Environment</code>为Pilot 中的核心环境对象，集成了许多不同的组件，包括服务发现、配置存储、网络观察等，以提供一个完整的环境 API。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">e </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Environment</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PushContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewPushContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DomainSuffix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> constants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultKubernetesDomain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MCPMode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="为modelenvironment设置ledger">为<code>model.Environment</code>设置<code>Ledger</code><a href="#为modelenvironment设置ledger" class="hash-link" aria-label="为modelenvironment设置ledger的直接链接" title="为modelenvironment设置ledger的直接链接">​</a></h4><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetLedger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">buildLedger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RegistryOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>Ledger</code> 是一个表示经过修改的 map 的接口。这个 map 具有三个独特的特征：</p><ol><li>每个 map 的唯一状态都有一个唯一的哈希值。</li><li>map 的先前状态在固定的时间内被保留。</li><li>给定先前的哈希值，我们可以从 map 中检索先前的状态（如果仍然被保留）。</li></ol><p><code>Ledger</code>提供了个接口来获取之前版本的Value，接口详情如下：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// GetPreviousValue executes a get against a previous version of the ledger, using that version&#x27;s root hash.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">GetPreviousValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">previousRootHash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="为modelenvironment设置服务发现的接口servicediscovery用于列举服务和实例">为<code>model.Environment</code>设置服务发现的接口<code>ServiceDiscovery</code>，用于列举服务和实例。<a href="#为modelenvironment设置服务发现的接口servicediscovery用于列举服务和实例" class="hash-link" aria-label="为modelenvironment设置服务发现的接口servicediscovery用于列举服务和实例的直接链接" title="为modelenvironment设置服务发现的接口servicediscovery用于列举服务和实例的直接链接">​</a></h4><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ac </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> aggregate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewController</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">aggregate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Options</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MeshHolder</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceDiscovery </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ac</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="初始化server实例">初始化<code>Server</code>实例<a href="#初始化server实例" class="hash-link" aria-label="初始化server实例的直接链接" title="初始化server实例的直接链接">​</a></h4><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerArgs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">      args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    httpMux</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">         http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewServeMux</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    readinessProbes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">readinessProbe</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">          server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Watcher </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mesh</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewFixedWatcher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v1alpha1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MeshConfig</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里说明一下<code>Server</code>结构体的各个字段的含义：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Server </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ServerArgs  </span><span class="token comment" style="color:#999988;font-style:italic">// Server参数配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment      </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Environment  </span><span class="token comment" style="color:#999988;font-style:italic">// Pilot环境配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubeClient       higresskube</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Client  </span><span class="token comment" style="color:#999988;font-style:italic">// 与 Kubernetes 集成的客户端</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configController model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ConfigStoreCache  </span><span class="token comment" style="color:#999988;font-style:italic">// 配置存储控制器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configStores     </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ConfigStoreCache  </span><span class="token comment" style="color:#999988;font-style:italic">// 多个配置存储的缓存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    httpServer       </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Server  </span><span class="token comment" style="color:#999988;font-style:italic">// HTTP 请求处理器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    httpMux          </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServeMux  </span><span class="token comment" style="color:#999988;font-style:italic">// HTTP 请求多路复用器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    grpcServer       </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Server  </span><span class="token comment" style="color:#999988;font-style:italic">// grpc服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xdsServer        </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">xds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DiscoveryServer  </span><span class="token comment" style="color:#999988;font-style:italic">// xds服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server           server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Instance  </span><span class="token comment" style="color:#999988;font-style:italic">// Pilot Server实例配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    readinessProbes  </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">readinessProbe  </span><span class="token comment" style="color:#999988;font-style:italic">// server内部服务记录表，记录服务是否准备好</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>在这里，<code>server.Instance</code>维护了一个chan变量<code>components chan Component</code>，<code>Component</code>则定义了一个函数方法模板。当我们调用<code>Instance</code>的<code>RunComponent(t Component)</code>方法，则会将变量<code>t</code>发送给<code>components</code>管道，而我们调用<code>Instance</code>的<code>Start(stop &lt;-chan struct{}) error</code>方法，则会从<code>components</code>管道去接收<code>Component</code>对象，并执行该对象的函数方法。</p></blockquote><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type Component func(stop &lt;-chan struct{}) error</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="创建初始启动函数列表">创建初始启动函数列表<a href="#创建初始启动函数列表" class="hash-link" aria-label="创建初始启动函数列表的直接链接" title="创建初始启动函数列表的直接链接">​</a></h4><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">initFuncList </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initKubeClient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initXdsServer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initHttpServer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initConfigController</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initRegistryEventHandlers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initAuthenticators</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p><code>initKubeClient</code>函数</p><ol><li><p>首先判断<code>kubeClient</code>是否为空，不为空进行下一步；</p></li><li><p>调用<code>istiokube.DefaultRestConfig</code>方法，创建一个具有 RESTful 风格的<code>Kubernetes Config</code>；</p></li><li><p>以<code>Kubernetes Config</code>为入参，调用<code>istiokube.NewClientConfigForRestConfig</code>方法创建一个具有 RESTful 风格的<code>Kubernetes Client Config</code>；</p></li><li><p>调用higress定义的<code>NewClient</code>方法，集成 Istio 客户端、Higress 客户端和可能的 Kingress 客户端，并为每个客户端设置了相应的 SharedInformerFactory。</p></li></ol></li><li><p><code>initXdsServer</code>函数</p><ol><li>调用<code>pliot xds</code>的<code>NewDiscoveryServer</code>方法，创建一个<code>xdsServer</code>实例，并初始化一些资源。<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> xds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewDiscoveryServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PodName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PodNamespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RegistryOptions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">KubeOptions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClusterAliases</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpGenerators</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmPlugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmpluginGenerator</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpGenerators</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DestinationRule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DestinationRuleGenerator</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpGenerators</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EnvoyFilter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EnvoyFilterGenerator</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpGenerators</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Gateway</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GatewayGenerator</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpGenerators</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VirtualService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VirtualServiceGenerator</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpGenerators</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceEntry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceEntryGenerator</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ProxyNeedsPush </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">proxy </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Proxy</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PushRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>将<code>xdsServer</code>的<code>Start</code>方法注册给pilot server instance，并调用higress server的<code>initGrpcServer</code>初始化函数，将xds服务注册在grpc服务上，使得可以通过grpc协议端口进行xds协议的通信。</li></ol></li><li><p><code>initHttpServer</code>函数，初始化http server，添加8888端口的debug接口的处理器，并添加<code>/ready</code>路由的处理器，用于遍历higress server的<code>readinessProbes</code>，判断内部服务记录表内的服务是否准备完毕。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddDebugHandlers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">httpMux</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">httpMux</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HandleFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/ready&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">readyHandler</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><code>initConfigController</code>函数，这部分内容比较核心，将会在后面详细展开，暂时先跳过。</p></li><li><p><code>initRegistryEventHandlers</code>函数，这部分内容跟<code>initConfigController</code>函数有关，暂时先跳过。</p></li><li><p><code>initAuthenticators</code>函数，顾名思义，就是初始化认证器，并将其应用于 xDS 服务器。通过添加不同的认证器，可以支持不同的身份验证方式，这样服务器在处理请求时可以验证客户端的身份信息。</p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="遍历启动函数列表执行启动函数">遍历启动函数列表，执行启动函数<a href="#遍历启动函数列表执行启动函数" class="hash-link" aria-label="遍历启动函数列表，执行启动函数的直接链接" title="遍历启动函数列表，执行启动函数的直接链接">​</a></h4><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> initFuncList </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="注册pilot-server">注册Pilot Server<a href="#注册pilot-server" class="hash-link" aria-label="注册Pilot Server的直接链接" title="注册Pilot Server的直接链接">​</a></h4><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RunComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stop </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kubeClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RunAndWait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>注意这里的<code>kubeClient</code>所调用的方法是<code>istio</code>的Kubernetes客户端提供的。</p></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="在ready服务记录表里注册xds服务">在ready服务记录表里注册xds服务<a href="#在ready服务记录表里注册xds服务" class="hash-link" aria-label="在ready服务记录表里注册xds服务的直接链接" title="在ready服务记录表里注册xds服务的直接链接">​</a></h4><div class="language-gog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">s.readinessProbes[&quot;xds&quot;] = func() (bool, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return s.xdsServer.IsServerReady(), nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动实例start">启动实例：Start<a href="#启动实例start" class="hash-link" aria-label="启动实例：Start的直接链接" title="启动实例：Start的直接链接">​</a></h3><ul><li>第一部分：遍历pilot server的<code>components</code>，执行chan管道里的函数</li></ul><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>第二部分：等待缓存同步完成</li></ul><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">waitForCacheSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;failed to sync cache&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>第三部分：启动grpc服务</li></ul><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">grpcListener</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Listen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;tcp&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GrpcAddress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;starting gRPC discovery service at %s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> grpcListener</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Addr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">grpcServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Serve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">grpcListener</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;error serving GRPC server: %v&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>第四部分：启动http服务</li></ul><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">httpListener</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Listen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;tcp&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HttpAddress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;starting HTTP service at %s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> httpListener</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Addr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">httpServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Serve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">httpListener</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;error serving http server: %v&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higress-core核心源码分析">higress-core核心源码分析<a href="#higress-core核心源码分析" class="hash-link" aria-label="higress-core核心源码分析的直接链接" title="higress-core核心源码分析的直接链接">​</a></h2><p>在前面有两个函数<code>initConfigController</code>和<code>initRegistryEventHandlers</code>我们没有介绍，这两个函数可以说是higress-core的核心代码，接下来对这两个函数进行具体剖析。在分析之前，我们先看一下<code>pkg</code>其他目录的功能。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── common //公共包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── config //配置包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── ingress //higress定义的ingress资源控制器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── config //配置ingress config和kingress config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── kube //集成Kubernetes配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── annotations //处理 Ingress 的注解相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── common //通用的代码和工具函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── configmap //处理 ConfigMap 相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── controller //控制器相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── http2rpc //处理 HTTP 到 RPC 的转换的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── ingress //处理 Ingress 配置的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── ingressv1 //Ingress 的 API 版本 v1 相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── kingress //处理 Kingress 相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── mcpbridge //MCP（Mesh Configuration Protocol）的桥接相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── secret //处理 Secret 相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── util //通用的工具函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── wasmplugin //处理 WebAssembly 插件相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── log //日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── mcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── translation //翻译模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── kube //higress定义的Kubernetes客户端，包含了istio提供的Kubernetes客户端</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过目录我们可以清晰地看到higress集成了多个Kubernetes资源以及Ingress配置。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="initconfigcontroller函数剖析"><code>initConfigController</code>函数剖析<a href="#initconfigcontroller函数剖析" class="hash-link" aria-label="initconfigcontroller函数剖析的直接链接" title="initconfigcontroller函数剖析的直接链接">​</a></h3><p>我们先大致分析一下这个函数的流程，函数的具体逻辑稍后分析。最后会给出一个函数调用的流程图，可以结合流程图进行源码的理解分析。</p><ol><li>设置 <code>common.Options</code> 结构体的一些选项，这些选项可能影响配置控制器的行为。这些选项包括是否启用控制器、集群 ID、Ingress 类等</li><li>创建一个 <code>translation.NewIngressTranslation</code> 对象，该对象用于处理 Ingress 的翻译和配置</li><li>向 <code>ingressConfig</code> 中添加本地集群的配置，并获取对应的 Ingress 控制器和 Kingress 控制器</li><li>使用 <code>configaggregate.MakeCache</code> 创建一个带有缓存的配置控制器</li><li>创建一个 Istio 配置存储，并将其设置到 <code>Server</code> 对象的 <code>environment.IstioConfigStore</code> 中</li><li>将 <code>ingressConfig</code> 设置到 <code>Server</code> 对象的 <code>environment.IngressStore</code> 中</li><li>将包含配置和启动 Ingress 控制器、Kingress 控制器以及相关的配置控制器的函数方法注册到pilot server instance的<code>components</code>管道中。</li></ol><p>我们从中挑选出几个比较重要的函数出来：<code>NewIngressTranslation</code>、<code>AddLocalCluster</code>、<code>InitializeCluster</code>以及<code>configController</code>的<code>Run</code>方法，其它的像<code>MakeCache</code>、<code>MakeIstioStore</code>方法则是有<code>istio</code>提供的函数方法，用于对接higress中的discovery容器中<code>Pilot</code>组件。确定好接下来要分析的内容之后，我们来到<code>pkg/ingress/translattion</code>目录，查看一下<code>translation.go</code>。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="translationgo剖析"><code>translation.go</code>剖析<a href="#translationgo剖析" class="hash-link" aria-label="translationgo剖析的直接链接" title="translationgo剖析的直接链接">​</a></h4><p><code>IngressTranslation</code>实现了两个接口：<code>model.ConfigStoreCache</code>和<code>model.IngressStore</code>，其中<code>model.ConfigStoreCache</code>还包含了<code>model.ConfigStore</code>接口。我们可以大致浏览一下，可以发现基本上是调用<code>IngressTranslation</code>结构体中的<code>ingressConfig</code>和<code>kingressConfig</code>的方法，位于<code>pkg/ingress/config</code>目录下。</p><p>除了实现接口方法之外，还提供了<code>NewIngressTranslation</code>、<code>AddLocalCluster</code>、<code>InitializeCluster</code>方法。同样地，我们也可以发现这三个方法本质上也是调用<code>ingressConfig</code>和<code>kingressConfig</code>的方法。</p><p>既然<code>translation.go</code>本质上是调用<code>pkg/ingress/config</code>目录下的函数，不妨我们进入该目录，查看一下<code>ingress_config.go</code>，对于<code>kingress_config.go</code>，我们暂不做分析。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="ingress_configgo剖析"><code>ingress_config.go</code>剖析<a href="#ingress_configgo剖析" class="hash-link" aria-label="ingress_configgo剖析的直接链接" title="ingress_configgo剖析的直接链接">​</a></h4><p>在<code>ingress_config.go</code>中有一个名为<code>IngressConfig</code>结构体，内容如下(附带注释)：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> IngressConfig </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 远程 Ingress 控制器的映射，键为集群 ID，值为 common.IngressController</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remoteIngressControllers </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IngressController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 用于保护并发访问 remoteIngressControllers 的互斥锁</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mutex sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RWMutex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Ingress 路由和域名的缓存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingressRouteCache  model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IngressRouteCollection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingressDomainCache model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IngressDomainCollection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 本地 Kubernetes 客户端</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    localKubeClient kube</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理 VirtualService 事件的事件处理程序切片</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtualServiceHandlers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理 Gateway 事件的事件处理程序切片</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gatewayHandlers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理 DestinationRule 事件的事件处理程序切片</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destinationRuleHandlers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理 EnvoyFilter 事件的事件处理程序切片</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    envoyFilterHandlers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理 ServiceEntry 事件的事件处理程序切片</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serviceEntryHandlers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理 WasmPlugin 事件的事件处理程序切片</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wasmPluginHandlers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 用于处理监视错误的处理程序</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    watchErrorHandler cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WatchErrorHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 缓存的 EnvoyFilter 配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cachedEnvoyFilters </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 正在监视的 Secret 集合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    watchedSecretSet sets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 用于协调注册表的调解器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RegistryReconciler </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">reconcile</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Reconciler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// MCP 桥接是否已调解的标志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mcpbridgeReconciled </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 管理 MCP 桥接相关的控制器和列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mcpbridgeController mcpbridge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpBridgeController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mcpbridgeLister     netlisterv1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpBridgeLister</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 管理 WasmPlugin 相关的控制器和列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wasmPluginController wasmplugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmPluginController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wasmPluginLister     extlisterv1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmPluginLister</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 已注册的 WasmPlugin 集合，键为 WasmPlugin 名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wasmPlugins </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">extensions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmPlugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 管理 HTTP2RPC 相关的控制器和列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http2rpcController http2rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Http2RpcController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http2rpcLister     netlisterv1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Http2RpcLister</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 已注册的 HTTP2RPC 集合，键为 HTTP2RPC 名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http2rpcs </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">higressv1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Http2Rpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Configmap 的管理器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">configmap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ConfigmapMgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 用于更新 XDS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    XDSUpdater model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">XDSUpdater</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理注解的注解处理程序</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    annotationHandler annotations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AnnotationHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 命名空间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 集群 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clusterId </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>该结构体提供了一些方法，其实这个结构体本质上也是实现了<code>translation.go</code>提到的两个接口，方法列表和<code>translation.go</code>极其相似，我们分析一下一些比较复杂的方法，剩下的可自行定位到源码查看：</p><ul><li><p><code>NewIngressConfig</code></p><ol><li>初始化<code>IngressConfig</code>，创建多个子控制器(mcpbridge、wasmplugin、http2rpc等)并赋值给对应的字段上。</li><li>为多个子控制器注册事件监听器，用于监听Kubernetes资源的变化，并进行相应的处理。<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">IngressConfig</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remoteIngressControllers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IngressController</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    localKubeClient</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">          localKubeClient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    XDSUpdater</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">               XDSUpdater</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    annotationHandler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        annotations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewAnnotationHandlerManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mcpbridgeController </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> mcpbridge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewController</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localKubeClient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> clusterId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mcpbridgeController</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddEventHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AddOrUpdateMcpBridge</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeleteMcpBridge</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mcpbridgeController </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mcpbridgeController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mcpbridgeLister </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mcpbridgeController</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Lister</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol></li></ul><p>在这里，有几个方法需要注意：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. `annotations.NewAnnotationHandlerManager()`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. `mcpbridge.NewController(localKubeClient, clusterId)`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. `wasmplugin.NewController(localKubeClient, clusterId)`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. `http2rpc.NewController(localKubeClient, clusterId)`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. `configmap.NewController(localKubeClient, clusterId, namespace)`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>很明显这些方法分别对应<code>pkg/ingress/kube</code>目录下一些自定义的资源配置方法，后面会针对该目录进行单独的介绍。</p><ul><li><p><code>RegisterEventHandler</code></p><ol><li><p>对kind变量进行判断，判断属于哪种资源，并添加到对应的事件处理程序切片</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> kind </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VirtualService</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">virtualServiceHandlers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">virtualServiceHandlers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>注册事件监听器</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> remoteIngressController </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">remoteIngressControllers </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remoteIngressController</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterEventHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们可以定位一下<code>remoteIngressController</code>的<code>RegisterEventHandler</code>方法：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">controller</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RegisterEventHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GroupVersionKind</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> kind </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VirtualService</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">virtualServiceHandlers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">virtualServiceHandlers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol></li><li><p><code>AddLocalCluster</code></p><ol><li>创建ingress总控制器，并注册到<code>remoteIngressControllers</code>中<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ingressController </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewController</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">localKubeClient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">localKubeClient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> secretController</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">remoteIngressControllers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClusterId</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingressController</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol></li><li><p><code>InitializeCluster</code></p><ol><li>设置错误监听处理器<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingressController</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetWatchErrorHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">watchErrorHandler</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>其中<code>SetWatchErrorHandler</code>方法如下，调用各个informer的<code>SetWatchErrorHandler</code>方法：<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">controller</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SetWatchErrorHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handler </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Reflector</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> errs </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serviceInformer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetWatchErrorHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       errs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> multierror</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">errs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ingressInformer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetWatchErrorHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       errs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> multierror</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">errs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>通过go协程启动<code>ingressController</code><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> ingressController</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stop</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol></li><li><p><code>List</code></p><ol><li><p>前期检查，预防空指针或逻辑错误</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> typ </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Gateway </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typ </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VirtualService </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typ </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DestinationRule </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typ </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EnvoyFilter </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typ </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceEntry </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typ </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmPlugin </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ErrUnsupportedOp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Currently, only support list all namespaces gateways or virtualservices.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> namespace </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IngressLog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Warnf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ingress store only support type %s of all namespace.&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> typ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ErrUnsupportedOp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>如果kind类型是envoyfilter，拿出来处理掉</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> typ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EnvoyFilter </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Build configmap envoy filters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmapEnvoyFilters</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">configmapMgr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ConstructEnvoyFilters</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>如果不是，调用ingress控制器(如果有kingress控制器，也给带上)的<code>List</code>方法，添加到config列表，以ingress控制器的方法为例，会获取informer对象的存储器，并对其进行遍历，将遍历到的对象进行深拷贝，并返回config列表。由于<code>List</code>方法是实现<code>ConfigStore</code>接口的，<code>istio</code>内部会对这个config列表进行下一步处理。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> configs </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mutex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ingressController </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">remoteIngressControllers </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">configs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ingressController</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mutex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RUnlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>对config列表根据创建时间进行排序，并创建一个包装好的config列表，wrapperConfigs里除了<code>Config``，还会包含</code>AnnotationsConfig`注解配置</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SortIngressByCreationTime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">configs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wrapperConfigs </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createWrapperConfigs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">configs</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>根据kind类型，将wrapperConfigs转换为对应的资源，代码如下，并为convertGateways附加注释</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> typ </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Gateway</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//1.初始化ConvertOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//2.调用ingress控制器的ConvertGateway方法，在这里，ingress控制器首先做一些检查，并遍历rule规则列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//  为每个rule创建IngressDomainBuilder构造器，中间过程会构造gateway包装器、获取tls密钥名称等等</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//  在这个过程中会对config包装器进行修改</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//3.apply注解</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//4.组合成istio能够识别的config列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">convertGateways</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wrapperConfigs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VirtualService</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">convertVirtualService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wrapperConfigs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DestinationRule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">convertDestinationRule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wrapperConfigs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这块内容较多，具备一定的难度，需要对各个资源有一定的理解。</p></li></ol></li></ul><p>以下几个方法的作用是极为相似的</p><ul><li><code>AddOrUpdateWasmPlugin</code></li><li><code>DeleteWasmPlugin</code></li><li><code>AddOrUpdateMcpBridge</code></li><li><code>DeleteMcpBridge</code></li><li><code>AddOrUpdateHttp2Rpc</code></li><li><code>DeleteHttp2Rpc</code></li></ul><p>顾名思义，就是在监听对应资源的过程中，发生资源的添加或者变更或者删除进行对应的操作。</p><p>以<code>AddOrUpdateWasmPlugin</code>和<code>DeleteWasmPlugin</code>为例。</p><ul><li><p><code>AddOrUpdateWasmPlugin</code></p><ol><li>获取wasmplugin<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wasmPlugin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wasmPluginLister</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WasmPlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clusterNamespacedName</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Namespace</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clusterNamespacedName</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>将wasmplugin转化为istio能够识别的wasmplugin<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">istioWasmPlugin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">convertIstioWasmPlugin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wasmPlugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>更新<code>IngressConfig</code><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wasmPlugins</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">clusterNamespacedName</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> istioWasmPlugin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol></li><li><p><code>DeleteWasmPlugin</code></p><ol><li>更新<code>IngressConfig</code><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wasmPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> clusterNamespacedName</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>如果存在该wasmplugin，触发<code>wasmPluginHandlers</code>的事件监听器，执行对应的操作<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wasmPluginHandlers </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IngressLog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;WasmPlugin triggerd update&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Meta</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Meta</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventDelete</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol></li></ul><p>到此为此，<code>ingress_config.go</code>的内容基本介绍完毕，大部分内容并未做过多深入，感兴趣的朋友可以自行下载源码浏览查看。</p><p>我们现在回到最开始的<code>initConfigController</code>函数上，可以发现这个函数的核心内容其实就是<code>ingress_config.go</code>，当然还有对应的多个控制器，关于控制器的介绍，将在后面进行介绍。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="initregistryeventhandlers函数剖析"><code>initRegistryEventHandlers</code>函数剖析<a href="#initregistryeventhandlers函数剖析" class="hash-link" aria-label="initregistryeventhandlers函数剖析的直接链接" title="initregistryeventhandlers函数剖析的直接链接">​</a></h3><p>该函数相对于<code>initConfigController</code>函数来说简单很多，其主要做的内容就是配置xds更新处理器，并将其作为事件监听器的事件处理程序，注册给<code>configController</code>，也就是说，当发生资源的变更时，会通过xds协议进行推送更新。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pkgingresskube目录介绍"><code>pkg/ingress/kube</code>目录介绍<a href="#pkgingresskube目录介绍" class="hash-link" aria-label="pkgingresskube目录介绍的直接链接" title="pkgingresskube目录介绍的直接链接">​</a></h2><p>这部分内容较多，后续可自行针对感兴趣的部分进行精读。</p><ul><li><p><code>annotations</code></p><p>这里主要处理ingress注解的配置，在<code>NewAnnotationHandlerManager</code>方法里列出了一些已经支持的注解，每个注解的处理程序需要实现<code>AnnotationHandler</code>所定义的接口列表。</p></li><li><p><code>common</code></p><p>这里核心的文件为<code>controller.go</code>，主要做了一些资源的包装，以及定义了<code>IngressController</code>接口方法，其实现类有<code>pkg/ingress/kube/ingress/controller.go</code>和<code>pkg/ingress/kube/ingressv1/controller.go</code></p></li><li><p><code>configmap</code></p><p>这里主要为<code>ConfigMap</code>添加了<code>higress</code>的KV对，在<code>controller.go</code>中定义了<code>ItemController</code>接口，和前者提到的一样，这里也提供了相似的更新配置的方法<code>AddOrUpdateHigressConfig</code>，同样地，也是先获取当前的value值，并获取旧的value值，进行一个比对，比对结果可能为新增、更新、删除，分别执行对应的事件监听器里所定义的事件处理器，也就是<code>XDSUpdater</code>。</p></li><li><p><code>controller</code></p><p>在前面的介绍中，提到了很多次事件监听器，可能会有人疑问是怎么做资源监听的，资源监听的代码就位于本目录下了。这里可以着重介绍一下，事件监听的具体实现原理。</p><ol><li><p>定义了<code>Controller[lister any]</code>接口，其实现类为<code>CommonController</code>。
我们可以看一下这个实现结构体有哪些需要注意的字段。</p><p><strong>lister</strong>: 这个字段为any类型，会在<code>NewCommonController</code>方法里传入进来，点击查看该方法调用情况，可以发现传入该字段的都是各个资源的监听器，例如<code>ConfigMap</code>的监听器就是<code>client.KubeInformer().Core().V1().ConfigMaps().Lister().ConfigMaps(namespace)</code>，其它也是如此。
<strong>updateHandler</strong>: 这个字段为<code>func(util.ClusterNamespacedName)</code>类型，主要用于存储对应监听器lister所提供的更新或者新增事件处理器，存储代码如下：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">CommonController</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lister</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AddEventHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addOrUpdate </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClusterNamespacedName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">delete</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClusterNamespacedName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updateHandler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> addOrUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">delete</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">removeHandler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">delete</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>removeHandler</strong>: 同<strong>updateHandler</strong></p></li><li><p>接口方法除了刚刚介绍的<code>AddEventHandler</code>方法，还有个<code>Run</code>方法需要注意一下</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">CommonController</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lister</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stop </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> utilruntime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HandleCrash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ShutDown</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WaitForCacheSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HasSynced</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       IngressLog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Failed to sync %s controller cache&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">typeName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IngressLog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s cache has synced&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">typeName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> wait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Until</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">worker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看有个<code>wait.Until</code>方法，用于每秒钟执行<code>c.worker</code>方法，直到接收到<code>stop</code>信号，方法调用链如下：<code>c.worker</code>-&gt;<code>c.processNextWorkItem()</code>-&gt;<code>c.onEvent(ingressNamespacedName)</code>-&gt;<code>c.updateHandler(obj)</code>，可以看出来当我们创建一个控制器，并为其注册了一个事件监听器以及事件处理器(updateHandler)，因此每秒钟会执行事件处理器，也就实现了监听的逻辑。</p></li></ol><p>也就是说，这个目录下主要定义了一个公共的控制器，可以节省大量代码的编写，我们在创建一个新的子控制器的时候，可以调用<code>NewCommonController</code>方法来实现监听逻辑。</p></li><li><p><code>http2rpc</code></p><p>代码较为简单，通过<code>NewCommonController</code>来创建<code>Http2RpcController</code>，并提供了<code>GetHttp2Rpc</code>方法。</p></li><li><p><code>ingress</code></p><p>Ingress控制器的核心代码逻辑，主要为前文提到的<code>ingress_config.go</code>所调用。部分内容在前文已经简单介绍过。</p></li><li><p><code>ingressv1</code></p><p>Ingress的API版本v1相关的控制器代码。</p></li><li><p><code>kingress</code></p><p>kingress相关的控制器代码。</p></li><li><p><code>mcpbridge</code></p><p>同<code>http2rpc</code>目录。</p></li><li><p><code>secret</code></p><p>同<code>http2rpc</code>目录。</p></li><li><p><code>util</code></p><p>工具包。</p></li><li><p><code>wasmplugin</code></p><p>同<code>http2rpc</code>目录。</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higress-core流程图">higress-core流程图<a href="#higress-core流程图" class="hash-link" aria-label="higress-core流程图的直接链接" title="higress-core流程图的直接链接">​</a></h2><p>经过前面的源码分析，相信大家对higress核心逻辑已经有了初步的理解，后续可以针对自己感兴趣的部分，进行深入研究，其中会涉及到Kubernetes资源配置的核心逻辑以及Istio的基本掌握，当然，如果给它研究透了，对这些基本原理的理解将会更为深刻。</p><p>流程图如下：</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/higress-code0-7cade8cdd7da0af9b26d32509bf400c4.png" width="876" height="548" class="img_ev3q"></p><p>对于初始化配置控制器部分，可进一步绘画流程图。</p><p><img loading="lazy" alt="img1.png" src="/zh-cn/assets/images/higress-code1-ca225a577cf9fa2079101f80da3e10b2.png" width="914" height="384" class="img_ev3q"></p><p>关于事件监听部分，其流程图如下：</p><p><img loading="lazy" alt="img2.png" src="/zh-cn/assets/images/higress-code2-f370ace5f5ede0c4f87dab8e9acf1e2d.png" width="749" height="603" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><p>以上是对higress源码的初步分析，希望能够给用户以及开发者对higress有个基本的了解。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/e2e-debug">教程：如何在本地进行higress调试和端到端测试</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-12-19T00:00:00.000Z" itemprop="datePublished">2023年12月19日</time> · <!-- -->阅读需 15 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">SJC</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景说明">背景说明<a href="#背景说明" class="hash-link" aria-label="背景说明的直接链接" title="背景说明的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="本地调试">本地调试<a href="#本地调试" class="hash-link" aria-label="本地调试的直接链接" title="本地调试的直接链接">​</a></h3><p>本地调试旨在在开发者的本地开发环境中识别、定位和修复代码中的错误（bug）。这个阶段的主要目标是确保单个模块或组件的正确性，以便更容易理解和解决问题。</p><p>开发者通常使用本地集成开发环境（IDE）或调试器来逐步执行代码、查看变量的值、观察程序的流程，并通过打断点来检查代码的执行过程。</p><p>本地调试是一个快速、迅速定位问题并进行修复的阶段，能够提供实时的反馈。它有助于确保代码的局部正确性，而不需要考虑整个系统的交互。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="端到端测试">端到端测试<a href="#端到端测试" class="hash-link" aria-label="端到端测试的直接链接" title="端到端测试的直接链接">​</a></h3><p>e2e测试是一种端到端的测试，是一种全面的测试方法，用于验证整个软件系统在真实环境中的功能和性能。它模拟用户的实际使用情况，确保整个系统的各个部分正确协同工作，以达到用户期望的功能。</p><p>端到端测试关注整个系统的集成和交互，旨在发现不同组件之间的问题以及在实际使用场景中可能出现的 bug。这有助于确保系统在生产环境中的稳定性和可靠性。</p><p>在higress中，e2e测试的主要流程可用下图来表示：</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug0-e9db11f70bb082a52732b7b318a076a7.png" width="1083" height="133" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="弊端">弊端<a href="#弊端" class="hash-link" aria-label="弊端的直接链接" title="弊端的直接链接">​</a></h3><ul><li><p>在本地开发的过程中，我们需要频繁的进行e2e测试，但是每次都要重新构建镜像、加载镜像、安装higress、运行e2e测试，这样的过程非常耗时，因此我们希望尽量地减少这些过程，复用测试环境以提高开发效率。</p></li><li><p>当e2e运行的时候出现问题，我们希望能够快速定位问题，这就需要在e2e测试中实现本地调试的功能。</p></li><li><p>另外，通常开发wasm插件的时候是不需要重新构建镜像的，只需要复用测试环境即可。然而，当涉及到higress-core组件代码(higress核心代码)修改的时候，就需要重新构建镜像，频繁地修改代码、重新构建镜像以运行e2e测试，这样开发效率就会大大降低。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="#解决方案" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h3><ul><li>不涉及higress-core组件修改</li></ul><p>可分为端到端测试的优化和在端到端测试中实现本地调试的功能，端到端优化可采用实现测试环境复用的方法，通过修改makefile文件来减少环境的创建等开销。</p><p>而在端到端测试中实现本地调试的功能，可通过Goland来实现，提前准备好测试环境，修改e2e测试的部分代码来减少e2e环境创建的开销，更加方便的实现debug功能。</p><ul><li>涉及higress-core组件修改</li></ul><p>可在本地启动higress-core组件，并使其能够与kind集群中的discovery、gateway等组件进行交互。</p><p>例如在涉及到higress-config的ConfigMap修改的时候，其流程大致如下：</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug5-cbdc082e404661537dfc9eccfe2f35a8.png" width="1076" height="177" class="img_ev3q"></p><p>可以发现，只需要修改higress-core容器与discovery容器之间的xds协议通信地址，使其能够与本地的higress-core容器进行交互，其是注册在grpc服务上的，因此只需要修改xds地址为本地的grpc服务地址即可。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="具体实现">具体实现<a href="#具体实现" class="hash-link" aria-label="具体实现的直接链接" title="具体实现的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="端到端测试优化">端到端测试优化<a href="#端到端测试优化" class="hash-link" aria-label="端到端测试优化的直接链接" title="端到端测试优化的直接链接">​</a></h3><p>通过makefile来完成，包含启动系列环境和执行e2e测试。</p><p>以运行插件测试为例，其make命令如下：</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress-wasmplugin-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token target symbol" style="color:#36acaa">higress-wasmplugin-test</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tools/kind</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> delete-cluster create-cluster docker-build kube-load-image install-dev-wasmplugin run-higress-e2e-test-wasmplugin delete-cluster</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>开发者首次运行环境可先删除最后一个<code>delete-cluster</code>的操作，第二次运行e2e测试的时候可以删除前面的操作，只保留<code>run-higress-e2e-test-wasmplugin</code>的操作，这样就可以减少很多时间。</p><p>然而make命令不支持添加到goland里面实现debug功能，运行出错的时候也不方便定位问题，更推荐使用下面这个方法。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="在e2e中实现本地调试">在e2e中实现本地调试<a href="#在e2e中实现本地调试" class="hash-link" aria-label="在e2e中实现本地调试的直接链接" title="在e2e中实现本地调试的直接链接">​</a></h3><p>通过Goland来完成，提前准备好环境，修改Goland启动参数来完成本地调试。</p><ul><li>e2e测试之前的准备</li></ul><p>根据各自的需求来定制环境，如果测试环境中需要用到higress的controller、gateway等组件，需要提前本地安装好环境，安装教程可参考<a href="https://higress.io/zh-cn/docs/user/quickstart/" target="_blank" rel="noopener noreferrer">这里</a>，或者参考端到端测试优化步骤来准备好测试环境。</p><p>安装好higress后，可以使用如下命令来查看higress的pod是否正常运行：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods --all-namespaces</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>显示结果如下图所示：</p><p><img loading="lazy" alt="1.png" src="/zh-cn/assets/images/e2e-debug1-6d4ad979b78fd26ceedc43b24fc18b3c.png" width="980" height="136" class="img_ev3q"></p><p>都显示Running状态，说明higress已经正常运行。</p><ul><li>e2e的flag修改</li></ul><p>在<code>test/e2e/conformance/utils/flags</code>目录下，有一个<code>flags.go</code>文件，里面定义了e2e测试的flag：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IngressClassName     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ingress-class&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;higress&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Name of IngressClass to use for tests&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ShowDebug            </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;debug&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Whether to print debug logs&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CleanupBaseResources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;cleanup-base-resources&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Whether to cleanup base test resources after the run&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SupportedFeatures    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;supported-features&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Supported features included in conformance tests suites&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ExemptFeatures       </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;exempt-features&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Exempt Features excluded from conformance tests suites&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IsWasmPluginTest     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;isWasmPluginTest&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Determine if run wasm plugin conformance test&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WasmPluginType       </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;wasmPluginType&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;GO&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Define wasm plugin type, currently supports GO, CPP&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WasmPluginName       </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;wasmPluginName&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Define wasm plugin name&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IsEnvoyConfigTest    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;isEnvoyConfigTest&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Determine if run envoy config conformance test&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可临时修改这些flag的初始值，也可以在Goland编辑器中定义启动参数，例如设置<code>IsWasmPluginTest</code>为true可只运行wasm插件的e2e测试。</p><p>修改好flag之后，我们就可以在Goland中通过debug的方式运行e2e测试。可先在如下位置添加一个断点，等待e2e环境准备完毕：</p><p><img loading="lazy" alt="2.png" src="/zh-cn/assets/images/e2e-debug2-de7c59fff6871ae104cb9f1fdbae9f65.png" width="1335" height="987" class="img_ev3q"></p><p>e2e测试在前期环境准备的过程中会创建一些namespace并启动一些pod，可以手动查看一下pod的启动情况。</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug3-4d25bee1f70fb8ae0a0a90deee54244d.png" width="1201" height="605" class="img_ev3q"></p><p>在这张图里面，除了我们提前安装好的higress组件之外，还有一些其他的pod，这些pod是e2e测试过程中创建的，如果有些pod在本地e2e测试中用不到，可手动修改代码来减少前期环境的准备时间。</p><blockquote><p>注意：如果设置了cleanup-base-resources为false，那么e2e测试结束之后，这些pod不会被删除，但是重启的时候会报错，例如：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Pod &quot;consul-standlone&quot; is invalid: spec: Forbidden: pod updates may not change fields other than `spec.containers[*].image`, `spec.initContainers[*].image`, `spec.activeDeadlineSeconds`, `spec.tolerations` (only additions to existing tolerations) or `spec.terminationGracePeriodSeconds` (allow it to be set to 1 if it was previously negative)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><blockquote><p>建议设置为true，每次测试完需要等待pod的销毁，然后重新测试，这些过程一般很快，也可以修改代码来减少一些pod的创建。</p></blockquote><ul><li>e2e测试环境优化</li></ul><p>例如只需要higress环境，而不需要<code>higress-conformance-infra</code>,<code>higress-conformance-app-backend</code>等namespace环境，可以手动在如下几行代码里添加注释，来跳过这些环境的创建，然后测试中只用到了higress的组件：</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug4-263420d802513c11800de3ce76b453f8.png" width="1372" height="984" class="img_ev3q"></p><p>在这里，我只需要运行<code>EnvoyConfigTracing</code>的Test测试，它只跟higress和higress-conformance-infra有关，注释掉了其他namespace的准备环境，可以看到e2e测试不到1s就结束了。</p><p>如果需要其他namespace的环境，而不需要nacos/consul等环境，可以在suite的New方法里找到以下代码块，根据需要进行注释：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// apply defaults</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> suite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BaseManifests </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    suite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BaseManifests </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;base/manifests.yaml&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;base/consul.yaml&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;base/eureka.yaml&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;base/nacos.yaml&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;base/dubbo.yaml&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>解决好e2e测试的环境相关问题，我们就可以在Goland里添加自己想要的断点，来debug测试用例了。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="higress-core本地调试e2e测试">higress-core本地调试+e2e测试<a href="#higress-core本地调试e2e测试" class="hash-link" aria-label="higress-core本地调试+e2e测试的直接链接" title="higress-core本地调试+e2e测试的直接链接">​</a></h3><ul><li>首先在本地启动higress-core组件，需要修改其启动参数，与正常部署的启动参数保持一致，可参考如下配置Goland的启动参数：</li></ul><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug6-19e1a126b7ce35334a9c2d73da8a8b77.png" width="1018" height="814" class="img_ev3q"></p><ul><li>查找自己的本机非回环网卡的ip地址，例如我使用wlo0网卡，也就是192.168.0.189</li></ul><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug7-5aee459287eee78b4f81c389416b186c.png" width="1022" height="190" class="img_ev3q"></p><ul><li>修改xds协议地址，运行<code>kubectl edit cm higress-config -n higress-system</code>，将其修改本地的grpc服务地址，如图：</li></ul><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug8-de3b41a3f2a5259600b86fe1e3a7a638.png" width="706" height="161" class="img_ev3q"></p><p>将其中的127.0.0.1:15051修改为192.168.0.189:15051，保存退出。</p><ul><li>重启controller和gateway deployment，使其能够重新加载配置:</li></ul><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment higress-gateway -n higress-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment higress-controller -n higress-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug9-3a14da3112f41d230e6b7112658ba74e.png" width="1016" height="238" class="img_ev3q"></p><ul><li>重启成功后可以先运行一下简单的e2e测试，比如http route等，测试是否能正常连通gateway，关于ConfigMap部分，我这里给本地higress-core添加了一个global-option的配置，此时kind的core组件还没有该配置，按照前面步骤启动本地higress-core并修改xds地址重启负载之后，运行相关的e2e测试，可以看到测试通过，本地higress-core日志以及kind上的discovery日志如下：</li></ul><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug10-b495481ce79e3c61606be79a1baee0fb.png" width="1824" height="858" class="img_ev3q"></p><p>通过本地higress-core日志可以看到ads成功推送出去envoyfilter配置文件给discovery，而discovery日志则显示lds/rds/cds等成功将配置文件推送给gateway。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hgctl-code-debug的使用">hgctl code-debug的使用<a href="#hgctl-code-debug的使用" class="hash-link" aria-label="hgctl code-debug的使用的直接链接" title="hgctl code-debug的使用的直接链接">​</a></h2><p>hgctl已经推出code-debug的功能，会自动修改xds地址，使其能够与本地的higress-core进行交互。这里需要使用hgctl来安装higress，目前code-debug只支持local-k8s的profile。</p><ul><li>hgctl安装higress</li></ul><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hgctl </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> --set </span><span class="token assign-left variable" style="color:#36acaa">profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">local-k8s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等待安装完成后，手动查看一下是否启动成功。</p><ul><li>启动本地higress-core</li></ul><p>修改Goland启动参数为<code>serve --kubeconfig=/root/.kube/config</code>(改为自己的home目录)，然后启动higress-core，等待higress-core启动成功。</p><ul><li>开启code-debug</li></ul><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hgctl code-debug start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查看controller和gateway的pod是否重启成功，如果重启成功，说明code-debug已经生效。</p><ul><li>其他环境准备</li></ul><p>在后面的步骤上涉及到Ingress资源，这里需要准备一下Ingress资源，运行如下命令：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: higress-conformance-infra</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    higress-conformance: infra</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: higress-conformance-infra</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    app: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      port: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      targetPort: 3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: higress-conformance-infra</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    app: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  replicas: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      app: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        app: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      - name: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        # From https://github.com/kubernetes-sigs/ingress-controller-conformance/tree/master/images/echoserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        image: higress-registry.cn-hangzhou.cr.aliyuncs.com/higress/echoserver:v20221109-7ee2f3e</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - name: POD_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            fieldRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">              fieldPath: metadata.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - name: NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            fieldRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">              fieldPath: metadata.namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            cpu: 10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: higress-conformance-infra-configmap-global-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: higress-conformance-infra</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - host: &quot;foo.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          - pathType: Prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            path: &quot;/foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                name: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                port:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                  number: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>调试higress-core</li></ul><p>以ConfigMap的gzip(位于pkg/ingress/kube/configmap/gzip.go)为例，修改<code>NewDefaultGzip</code>方法，将<code>Enable</code>的默认值修改为true，然后重启higress-core。</p><p>在重启之前，先运行如下shell命令，启动envoy查看面板：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hgctl dashboard envoy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>访问http://localhost:15000/config_dump，使用Ctrl+F搜索<code>compression_level</code>，可以看到查找结果为空，说明gzip配置还没有生效。</p><p>接下来重启higress-core，等待higress-core重启成功，再次访问http://localhost:15000/config_dump，使用Ctrl+F搜索<code>compression_level</code>，可以看到查找结果不为空，说明gzip配置已经生效。</p><ul><li>关闭code-debug</li></ul><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hgctl code-debug stop</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><ol><li>本地调试和e2e测试是开发过程中必不可少的环节，通过本文的介绍，我们可以更加方便的进行本地调试和e2e测试，提高开发效率。</li><li>涉及到higress-core组件修改的时候，我们可以通过修改xds地址并本地启动higress-core，而不需要频繁地修改代码、重新构建镜像以运行e2e测试，并且还能调试higress-core组件的代码。</li><li>higress后续会推出一些新功能，实现e2e测试的拆分，主要会分为准备环境，运行测试以及清除环境等，灵活性更高。</li></ol></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/hring">Higress 团队招募小伙伴加入～</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-11-17T00:00:00.000Z" itemprop="datePublished">2023年11月17日</time> · <!-- -->阅读需 6 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">澄潭</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="加入higress的商业化team">加入Higress的商业化Team<a href="#加入higress的商业化team" class="hash-link" aria-label="加入Higress的商业化Team的直接链接" title="加入Higress的商业化Team的直接链接">​</a></h2><p>我们商业化Team有充足的HC，欢迎加入👏，联系方式：微信(nomadao)  邮箱(<a href="mailto:zty98751@alibaba-inc.com" target="_blank" rel="noopener noreferrer">zty98751@alibaba-inc.com</a>)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="团队介绍">团队介绍<a href="#团队介绍" class="hash-link" aria-label="团队介绍的直接链接" title="团队介绍的直接链接">​</a></h3><p>Higress团队属于阿里云云原生中间件团队。</p><p>阿里云云原生中间件团队负责分布式软件基础设施，为阿里云上万家企业提供如微服务引擎、分布式事务、EDAS等分布式基础服务，加速企业上云的进程和创新速度。同时，云原生中间件团队也服务着阿里集团众多核心业务和场景，是支撑双十一狂欢节的核心团队之一。</p><p>在这里，有非常优秀的中间件产品和场景以及企业互联网架构平台，服务上万家阿里云的企业，支持大规模电商交易业务场景。</p><p>在这里，你会参与到全球优秀开源项目（如 Apache Dubbo、RocketMQ、Nacos、Sentinel、Seata、Arthas、Tengine、Istio、Envoy、OpenSergo、Higress）和阿里云核心商业化产品（微服务引擎 MSE、企业级分布式应用服务 EDAS、应用实时监控服务ARMS）研发工作中，一同拓展技术的边界，既赋能阿里巴巴集团，更服务广泛的开发者用户。</p><p>在这里，你会参与到中间件、微服务、Serverless 等前沿的技术研发与探索中来；你也会与全球优秀开源产品创始人等组成的明星团队一起工作。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="负责工作">负责工作<a href="#负责工作" class="hash-link" aria-label="负责工作的直接链接" title="负责工作的直接链接">​</a></h3><ol><li>参与阿里云商业版Higress（MSE云原生网关）的产品研发</li><li>参与Higress开源的产品研发和社群运营</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="职位要求">职位要求<a href="#职位要求" class="hash-link" aria-label="职位要求的直接链接" title="职位要求的直接链接">​</a></h3><ol><li>3年以上产品研发工作经验，熟练使用Go或C++，有云原生相关产品研发经验者优先。</li><li>有Higress/Envoy/Istio/Nginx开源贡献和开发经验者优先。</li><li>具备出色的项目管理协调和业务规划能力，有团队合作精神，并能借助各方力量推动规则、制度等落地。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="加入higress的开源team">加入Higress的开源Team<a href="#加入higress的开源team" class="hash-link" aria-label="加入Higress的开源Team的直接链接" title="加入Higress的开源Team的直接链接">​</a></h2><p>Higress为参与贡献的同学设计了几个可认领的头衔，达到一定贡献要求，即可在Higress官网提<a href="https://github.com/higress-group/higress-group.github.io/blob/main/i18n/zh-cn/docusaurus-plugin-content-docs/current/developers/developers_dev.md" target="_blank" rel="noopener noreferrer">PR</a>的方式认领。</p><p><strong>头衔本身是一种荣誉象征，每一位参与Higress的贡献者在开源社区的地位都是平等的</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="member-头衔">Member 头衔<a href="#member-头衔" class="hash-link" aria-label="Member 头衔的直接链接" title="Member 头衔的直接链接">​</a></h3><p><strong>条件：</strong></p><ul><li>获得 8 个完成 issue 的积分（easy +1，normal +2，challenge +4）</li></ul><blockquote><p>Higress开源社区为每个可认领（help wanted标签）的issue都标记了难度标签：简单(level/easy)，普通(level/normal)，有挑战(level/challenge)，完成issue后可以获得对应积分</p></blockquote><ul><li>贡献代码（包含文档）DIFF 行数（包含增删）达到 500+</li></ul><blockquote><p>不仅只有贡献代码，在Higress<a href="https://github.com/higress-group/higress-group.github.io" target="_blank" rel="noopener noreferrer">官网仓库</a>贡献文档，也可以满足此要求</p></blockquote><ul><li>在社区周会进行 1 次主题分享</li></ul><blockquote><p>重点不是分享的内容，是通过分享让大家认识你</p></blockquote><p><strong>申请方式：</strong></p><p>直接提PR申请</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reviewer-头衔">Reviewer 头衔<a href="#reviewer-头衔" class="hash-link" aria-label="Reviewer 头衔的直接链接" title="Reviewer 头衔的直接链接">​</a></h3><p><strong>条件：</strong></p><ul><li>满足Member条件</li><li>在SIG的核心 <a href="https://github.com/alibaba/higress/issues/547" target="_blank" rel="noopener noreferrer">issue</a> 中做出贡献</li></ul><p><strong>申请方式：</strong></p><p>由Approvers/Maintainer提名后，提PR申请</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="approver-头衔">Approver 头衔<a href="#approver-头衔" class="hash-link" aria-label="Approver 头衔的直接链接" title="Approver 头衔的直接链接">​</a></h3><p><strong>条件：</strong></p><ul><li>满足Reviewer条件</li><li>主导一个SIG，组织并推进核心issue的tasklist完成</li></ul><p><strong>申请方式：</strong></p><p>由Maintainer提名后，提PR申请</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="maintainer-头衔">Maintainer 头衔<a href="#maintainer-头衔" class="hash-link" aria-label="Maintainer 头衔的直接链接" title="Maintainer 头衔的直接链接">​</a></h3><p>Maintainer是对Higress项目（包括Higress下的项目）的演进和发展做出显著贡献的个人。在社区中具有有目共睹的影响力，能够代表Higress参加重要的社区会议和活动。</p><p><strong>条件：</strong></p><ul><li>满足Approver条件</li><li>主导多个SIG，组织并推进核心issue的tasklist完成</li><li>积极参与开源社区的日常工作：引导新人开发，用户问题解答等</li></ul><p><strong>申请方式：</strong></p><p>由2名Maintainer提名后，提PR申请</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="已获得头衔名单">已获得头衔名单<a href="#已获得头衔名单" class="hash-link" aria-label="已获得头衔名单的直接链接" title="已获得头衔名单的直接链接">​</a></h3><p><strong>注：排名按 github id 首字母</strong></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="higress-maintainers">Higress Maintainers<a href="#higress-maintainers" class="hash-link" aria-label="Higress Maintainers的直接链接" title="Higress Maintainers的直接链接">​</a></h4><table><thead><tr><th>姓名</th><th>github</th><th>组织</th></tr></thead><tbody><tr><td>董艺荃</td><td><a href="https://github.com/CH3CHO" target="_blank" rel="noopener noreferrer">CH3CHO</a></td><td>Trip.com</td></tr><tr><td>耿蕾蕾</td><td><a href="https://github.com/gengleilei" target="_blank" rel="noopener noreferrer">gengleilei</a></td><td>Alibaba</td></tr><tr><td>张添翼</td><td><a href="https://github.com/johnlanni" target="_blank" rel="noopener noreferrer">johnlanni</a></td><td>Alibaba</td></tr><tr><td>范扬</td><td><a href="https://github.com/SpecialYang" target="_blank" rel="noopener noreferrer">SpecialYang</a></td><td>Alibaba</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="higress-approvers">Higress Approvers<a href="#higress-approvers" class="hash-link" aria-label="Higress Approvers的直接链接" title="Higress Approvers的直接链接">​</a></h4><table><thead><tr><th>姓名</th><th>github</th><th>组织</th></tr></thead><tbody><tr><td>吴新军</td><td><a href="https://github.com/2456868764" target="_blank" rel="noopener noreferrer">2456868764</a></td><td>-</td></tr><tr><td>刘训灼</td><td><a href="https://github.com/Xunzhuo" target="_blank" rel="noopener noreferrer">Xunzhuo</a></td><td>Tencent</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="higress-reviewers">Higress Reviewers<a href="#higress-reviewers" class="hash-link" aria-label="Higress Reviewers的直接链接" title="Higress Reviewers的直接链接">​</a></h4><table><thead><tr><th>姓名</th><th>github</th><th>组织</th></tr></thead><tbody><tr><td>凌轶群</td><td><a href="https://github.com/Lynskylate" target="_blank" rel="noopener noreferrer">Lynskylate</a></td><td>Pdd Holdings Inc</td></tr><tr><td>刘晓瑞</td><td><a href="https://github.com/rinfx" target="_blank" rel="noopener noreferrer">rinfx</a></td><td>Alibaba</td></tr><tr><td>赵炳堃</td><td><a href="https://github.com/sjtuzbk" target="_blank" rel="noopener noreferrer">sjtuzbk</a></td><td>Alibaba</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="higress-members">Higress Members<a href="#higress-members" class="hash-link" aria-label="Higress Members的直接链接" title="Higress Members的直接链接">​</a></h4><table><thead><tr><th>姓名</th><th>github</th><th>组织</th></tr></thead><tbody><tr><td>李强林</td><td><a href="https://github.com/Charlie17Li" target="_blank" rel="noopener noreferrer">Charlie17Li</a></td><td>ZJU-SEL</td></tr><tr><td>封宇腾</td><td><a href="https://github.com/Fkbqf" target="_blank" rel="noopener noreferrer">Ffyyt</a></td><td>XUPT</td></tr><tr><td>田亚涛</td><td><a href="https://github.com/Hinsteny" target="_blank" rel="noopener noreferrer">Hinsteny</a></td><td>Ant</td></tr><tr><td>宋鹏远</td><td><a href="https://github.com/songpengyuan" target="_blank" rel="noopener noreferrer">songpengyuan</a></td><td>Okki.com</td></tr><tr><td>赵伟基</td><td><a href="https://github.com/vikizhao156" target="_blank" rel="noopener noreferrer">vikizhao156</a></td><td>SJTU</td></tr><tr><td>韦鑫</td><td><a href="https://github.com/weixinx" target="_blank" rel="noopener noreferrer">WeixinX</a></td><td>NUAA</td></tr></tbody></table></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/release-1.3">Higress 开源一周年：新版本，新标准，新工具，新征程</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-11-04T00:00:00.000Z" itemprop="datePublished">2023年11月4日</time> · <!-- -->阅读需 19 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">澄潭</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="历程回顾">历程回顾<a href="#历程回顾" class="hash-link" aria-label="历程回顾的直接链接" title="历程回顾的直接链接">​</a></h2><p><img loading="lazy" src="https://github.com/johnlanni/higress-group.github.io/assets/6763318/b5f3ee1b-d53a-4fbb-8d4a-82427ebdfe40" alt="image" class="img_ev3q"></p><p>Higress 开源一年时间，一共发布了 18 个 release 版本，收获了 40 多位社区贡献者和 1800+ star，上图是这一年过来达成的一些关键的里程碑。</p><p>前面半年通过集成开源生态，打磨开源版本稳定性，并在发布 1.0 GA 版本后，社区又马不停蹄发布了 1.1 和 1.2 两个重要版本，实现了非 K8s 部署，Knative 适配等核心能力。</p><p>Higress 1.3 版本已经正式发布，除了增加的新功能，已有能力也在大量社区用户反馈的过程中不断完善改进，这个版本同时标志着 1.x 进入可以大规模生产使用的状态。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="新版本功能速览">新版本：功能速览<a href="#新版本功能速览" class="hash-link" aria-label="新版本：功能速览的直接链接" title="新版本：功能速览的直接链接">​</a></h2><p>自发布 1.2 版本过去了一个多月时间，1.3 版本正式发布，带来两个全新能力：</p><ul><li>新标准：支持最新版本 Gateway API 标准，并且具备从 Ingress 平滑渐进演进，以及对接多种服务发现机制的能力</li><li>新工具：正式 release 了 hgctl (Higress Crontroller) 这个 &quot;All in one&quot; 的新工具，不仅可以替代 Helm 实现更简易的安装，还提供了 WASM 插件开发工具包，以及网关配置检查等丰富功能</li></ul><p>除了这两个核心功能外，还有一些实用功能：</p><ol><li>提供了 Higress Admin Java SDK，可以统一对接 K8s 和非 K8s 环境，管理域名/路由等配置</li><li>提供了 OIDC 插件，支持对接 Keycloak/Okta 等第三方身份认证系统</li><li>Higress Console 的易用性和安全性提升，不再通过路由暴露，支持界面初始化/修改密码</li></ol><p>与此同时，Higress 开源社区已经开始准备踏上一段全新的开源征程...</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="新标准支持最新版-gateway-api">新标准：支持最新版 Gateway API<a href="#新标准支持最新版-gateway-api" class="hash-link" aria-label="新标准：支持最新版 Gateway API的直接链接" title="新标准：支持最新版 Gateway API的直接链接">​</a></h2><p>Gateway API 在 11 月 1 日正式发布了 1.0.0 版本，其中 GatewayClass, Gateway, HTTPRoute 这三个 API正式宣布 GA，发布了 v1 版本：gateway.networking.k8s.io/v1。</p><p>目前 Higress 已经可以支持这些最新版本的 API 配置，只需在安装/升级 Higress 时配置开启 Gateway API：</p><ul><li>使用 Helm ：通过参数 <code>--set global.enableGatewayAPI=true</code></li><li>使用 Hgctl ：通过命令行参数或者 install.yaml 中配置 <code>global.enableGatewayAPI=true</code></li></ul><p>首先创建 GatewayClass 资源：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gateway.networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GatewayClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">controllerName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;higress.io/gateway-controller&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接着在安装 Higress 的命名空间下，创建 Gateway 资源，通过 gatewayClassName 关联上面创建的 GatewayClass 资源，指定由 Higress 来管理此 Gateway 配置，下面为域名同时配置了 HTTP 和 HTTPS 入口，并为 HTTPS 入口配置了证书：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gateway.networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gatewayClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">listeners</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foobar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">hostname</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*.foobar.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">allowedRoutes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">namespaces</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> All</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foobar</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">hostname</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*.foobar.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTPS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">allowedRoutes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">namespaces</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> All</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">certificateRefs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> wildcard</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">foobar</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Terminate        </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>因为上面 Gateway 通过 allowedRoutes 配置了允许所有命名空间的路由来关联，所以这里在 default 命名空间下创建 HTTPRoute，关联上面创建的 Gateway，即可定义域名下的具体路由：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gateway.networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTPRoute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foobar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">parentRefs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hostnames</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;www.foobar.com&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">matches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PathPrefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /foo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">backendRefs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5678</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上就是 Gateway API 的一个简单用法示例，Gateway API 还有很多功能和玩法，后面 Higress 公众号/博客会出一个系列进行系统分享和介绍。</p><p>欢迎结合<a href="https://gateway-api.sigs.k8s.io/reference/spec/" target="_blank" rel="noopener noreferrer">官方 API 文档</a>，并使用 hgctl （获取方式见下文）在自己电脑上安装一个 local-k8s 模式的 Higress，来开启对这一新标准的探索：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 一键安装, 交互式命令选择第一种安装模式 local-k8s，将默认安装 Gateway API CRD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hgctl </span><span class="token function" style="color:#d73a49">install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="多种服务发现能力">多种服务发现能力<a href="#多种服务发现能力" class="hash-link" aria-label="多种服务发现能力的直接链接" title="多种服务发现能力的直接链接">​</a></h3><p>在 Ingress API 标准下，Higress 对接多种服务发现能力是独树一帜的，在 Gateway API 标准下， Higress 仍就保持了这一能力优势：</p><p>首先通过 McpBridge 资源，可以定义多种服务发现机制：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.higress.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> McpBridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nacosGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> DEFAULT_GROUP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nacos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8848</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nacos2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2181</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zookeeper      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">eureka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8761</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eureka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">consulDatacenter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dc1      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> consul</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>创建一个 HTTPRoute 资源，可以同时对接 K8s 服务，和注册中心的服务，并实现灰度路由能力：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gateway.networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTPRoute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">parentRefs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">matches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PathPrefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">backendRefs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">provider.DEFAULT</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">GROUP.public.nacos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">group</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.higress.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">weight</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">90</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5678</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">weight</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>和 K8s 服务不同的是，这里 group 为 <code>networking.higress.io</code> 的服务并不需要提前创建 CRD 资源，这更符合传统微服务用户的习惯，即服务模型不需要提前创建，是通过服务节点注册自动生成。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ingress-api-和-gateway-api-之间如何选择">Ingress API 和 Gateway API 之间如何选择<a href="#ingress-api-和-gateway-api-之间如何选择" class="hash-link" aria-label="Ingress API 和 Gateway API 之间如何选择的直接链接" title="Ingress API 和 Gateway API 之间如何选择的直接链接">​</a></h3><p>有了 Gateway API，是否应该立即抛弃 Ingress API？</p><p>只有最合适的，没有最好的。Gateway API 虽然为更多网关能力做了标准化，但 CRD 的种类和复杂度也增加了，相比之下对于大部分简单用例场景，Ingress API 更加简单易用。</p><p>对于以下场景，采用 Gateway API 替代 Ingress API 会带来很大帮助：</p><ul><li>大型团队划分了 SRE 角色和业务研发角色，由 SRE 通过 Gateway 资源统一管理站点域名和证书，由业务研发通过 HTTPRoute 资源管理业务路由，实现职责划分，权限收敛</li><li>创建的路由和 Service 有不在一个命名空间的需求，可以借助 ReferenceGrant 资源实现</li><li>有大量证书需要集中式管理，不希望将证书 Secret 同步到 Ingress 所在命名空间，带来安全风险</li></ul><p>Gateway API 的另一个好处是对于更多功能的标准化定义，我们建议遇到实际需要再转换到这个新的标准，而不必盲目跟随。</p><p>Higress 支持 Gateway API 和 Ingress API 混合使用，Gateway API 下的域名路由将比 Ingress API 优先匹配，和 Ingress 相同资源名称的 HTTPRoute 还会继承 WASM 插件配置，这样用户可以按需采用 Gateway API，平滑地完成从 Ingress API 向 Gateway API 的演进，无需焦虑 API 标准升级过程中产生业务损失。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="新工具all-in-one-的-hgctl">新工具：All in one 的 hgctl<a href="#新工具all-in-one-的-hgctl" class="hash-link" aria-label="新工具：All in one 的 hgctl的直接链接" title="新工具：All in one 的 hgctl的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="替代-helm-用于安装升级">替代 Helm 用于安装/升级<a href="#替代-helm-用于安装升级" class="hash-link" aria-label="替代 Helm 用于安装/升级的直接链接" title="替代 Helm 用于安装/升级的直接链接">​</a></h3><p>在 K8s 下用 Helm 安装/升级组件很方便，但在 Higress 的场景下仍然存在一些问题：</p><ol><li>无法支持非 K8s 场景下的安装/升级</li><li>Higress 有很多安装参数，进行升级等操作时不好维护，使用<code>reuse-values</code> 有一些副作用，且容易误操作</li><li>无法管理 CRD 跟随版本更新，需要手动更新</li></ol><p>Higress 借鉴了 istio 的 istioctl，提供了 hgctl 这个命令行工具解决了上述问题，通过以下命令即可安装 hgctl</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 下载最新版 Hgctl：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -Ls https://raw.githubusercontent.com/alibaba/higress/main/tools/hack/get-hgctl.sh </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">VERSION</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">latest </span><span class="token function" style="color:#d73a49">bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>hgctl 集成了三种 Higress 安装模式，并统一了升级/运维操作：</p><ol><li>本地 K8s 环境（例如kind/k3s）模式</li><li>正式 K8s 环境模式</li><li>不依赖 K8s 的纯 Docker 环境模式</li></ol><p>直接执行 <code>hgctl install</code> 命令即可选择任意模式进行安装</p><p>安装配置文件将存至 <code>~/.hgctl/profiles/install.yaml</code> 目录下，查看该文件内容如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">charts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">higress</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 安装文件的 helm repo 地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//higress.io/helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">charts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 执行 hgctl upgrade 时将自动更新至最新版本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">console</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 开启可观测组件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">o11YEnabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 控制台实例数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">controller</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 控制面组件实例数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">gateway</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 数据面组件实例数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">global</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 开启 Gateway API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enableGatewayAPI</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 开启 Istio API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enableIstioAPI</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 设置监听的 ingress class</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ingressClass</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 安装模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">install</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">k8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 安装命名空间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 配置传递给 helm 的 values 参数 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">profile</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">k8s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>修改上面文件的内容后，执行<code>hgctl upgarde</code>即可实现参数变更生效，如果只想修改参数，不想触发版本升级，可以将 version 参数固定为当前版本。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="wasm-插件开发工具包">WASM 插件开发工具包<a href="#wasm-插件开发工具包" class="hash-link" aria-label="WASM 插件开发工具包的直接链接" title="WASM 插件开发工具包的直接链接">​</a></h3><p>为了标准化并简化 WASM 插件的开发/编译/测试/发布，Higress 提供了 <code>hgctl plugin</code> 这一子命令，使用方式为：</p><ol><li><code>hgctl plugin init</code>: 初始化 Golang WASM 插件项目，包括三个文件；</li><li>用户编写 WASM 插件逻辑；</li><li><code>hgctl plugin build --output-type files</code>: 构建 WASM 插件，在本地输出构建产物；</li><li><code>hgctl plugin test: 使用 docker compose</code> 在本地测试 WASM 插件，如需修改插件逻辑，则返回第 2 步；</li><li><code>hgctl plugin build --output-type image</code>: 构建 WASM 插件作为 OCI 镜像上传至镜像仓库；</li><li><code>hgctl plugin install</code>: 安装 WASM 插件，可以通过本地的 yaml 文件或插件项目进行安装。</li></ol><p>另外，若需要查看已安装的插件，则使用 <code>hgctl plugin ls</code>；若需要操作插件配置，则使用 <code>hgctl plugin config</code></p><p>通过这个工具，可以在构建 WASM 插件的同时，根据配置代码自动生成插件的配置说明文档，以及包含插件配置约束的元信息文件，这些内容都将和 WASM 文件一起放入 OCI 镜像制品中，通过镜像方式进行版本管理和分发。这一机制是后续 Higress 建设 WASM 插件市场的基石。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="其他功能">其他功能<a href="#其他功能" class="hash-link" aria-label="其他功能的直接链接" title="其他功能的直接链接">​</a></h3><p>另外介绍两个实用的子命令：</p><ol><li><code>hgctl dashboard</code>: 用于呼出 UI 界面，例如 Higress 控制台，直接通过 <code>hgctl dashboard console</code> 即可打开</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  $ hgctl dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Access to Higress web UIs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hgctl dashboard </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hgctl dashboard </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">command</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Aliases:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dashboard, dash, d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Available Commands:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console     Open Console web UI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    controller  Open Controller debug web UI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    envoy       Open Envoy admin web UI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    grafana     Open Grafana web UI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prometheus  Open Prometheus web UI</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li><code>hgctl gateway-config</code>: 用于查看数据面的 envoy 配置，可以快速验证配置是否正确下发</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  $ hgctl gateway-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Retrieve information about Higress Gateway Configuration.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hgctl gateway-config </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">command</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Aliases:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gateway-config, gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Available Commands:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    all         Retrieves all Envoy xDS resources from the specified Higress Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bootstrap   Retrieves bootstrap Envoy xDS resources from the specified Higress Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster     Retrieves cluster Envoy xDS resources from the specified Higress Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endpoint    Retrieves endpoint Envoy xDS resources from the specified Higress Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listener    Retrieves listener Envoy xDS resources from the specified Higress Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route       Retrieves route Envoy xDS resources from the specified Higress Gateway</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="新征程api-gateway">新征程：API Gateway<a href="#新征程api-gateway" class="hash-link" aria-label="新征程：API Gateway的直接链接" title="新征程：API Gateway的直接链接">​</a></h2><p>上面说了 Gateway API，接着我们聊聊 API Gateway 😄，API Gateway 有两层定义：</p><ol><li>狭义上：满足统一接入，将路由转发到不同服务的运维需求，即可称为 API Gateway；这里 API 的定义是服务的路由</li><li>广义上：在实现服务转发的基础上，需要识别带业务语义的接口，将业务能力 API 化管理，统一对外提供服务；这里 API 的定义是业务功能接口</li></ol><p>Higress 已经实现了狭义上的 API Gateway 能力，并且是基于 Gateway/Ingress API 这些通用路由标准来实现的。而与服务路由标准不同，业务功能接口的标准是 Swagger/OAS3/RPC IDL 等，做为 API Gateway 需要提供以下关键能力：</p><ol><li>支持通过上传 Swagger 等接口定义文件的方式导入 API</li><li>对 API 实现精细化策略管理，例如根据出入参定义实现参数映射/转换</li><li>实现以 API 方式开放能力时的认证/鉴权，调用量控制/审计能力</li></ol><p>Higress 新的开源征程将向具备业务 API 管理能力的 API Gateway 形态进发。在实现方式上，我们将基于 WASM 插件去扩展这一部分能力，这可以降低我们对上游 Envoy 社区的侵入性改造，同时让对 API 的精细化策略管理具备自定义扩展能力。
目前社区已经有一些 Proposal ，欢迎了解：</p><p><a href="https://github.com/alibaba/higress/issues/535" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress/issues/535</a></p><p><a href="https://github.com/alibaba/higress/issues/601" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress/issues/601</a></p><p>欢迎有更多小伙伴加入，和我们一起踏上新的征程，有兴趣的小伙伴可以联系我(微信：nomadao)，加入 API Gateway 的 SIG（兴趣小组）。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="社区致谢">社区致谢<a href="#社区致谢" class="hash-link" aria-label="社区致谢的直接链接" title="社区致谢的直接链接">​</a></h2><p>首先要感谢 Envoy 和 Istio 社区，Higress 站在这两个软件的肩膀上演进能力，得以：</p><ol><li>通过 WASM 机制扩展 Envoy 数据面能力，持续不断地扩大网关插件生态</li><li>通过专注在网关领域，在 Istio 优秀的控制面基础上，进一步做抽象和简化，降低上手和运维门槛</li></ol><p>还要感谢参与 Higress 开源贡献的开发者们，这里重点感谢下为 1.3 版本做出核心贡献的开发者：</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="maintainer董艺荃ch3cho">Maintainer：董艺荃(CH3CHO)<a href="#maintainer董艺荃ch3cho" class="hash-link" aria-label="Maintainer：董艺荃(CH3CHO)的直接链接" title="Maintainer：董艺荃(CH3CHO)的直接链接">​</a></h3><p>人如其名“艺全”，十八般武艺样样精通，不管是控制台 TS 前端，Java 后台，还是 Higress 的 GO 控制面，以及 Standalone 安装 Shell 脚本和各种 CICD 流程，通通手到擒来。</p><p>在 1.3 版本中主要负责了 Higress 支持 Gateway API 的能力，以及实现了 Higress Admin Java SDK 可以提供外部集成用于管理 Higress 配置，并改进了 Higress Console 的安全性和易用性。</p><p>除了开发贡献之外，他还对社区用户充满善意和热情，无论是在 GitHub 的 Issues/Discussions，或是社区交流微信/钉钉群，随处可见他帮助用户解决问题的身影。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="approver吴新军jun刘训灼xunzhuo">Approver：吴新军(Jun)，刘训灼(Xunzhuo)<a href="#approver吴新军jun刘训灼xunzhuo" class="hash-link" aria-label="Approver：吴新军(Jun)，刘训灼(Xunzhuo)的直接链接" title="Approver：吴新军(Jun)，刘训灼(Xunzhuo)的直接链接">​</a></h3><p>两位都在多个 Higress 版本为社区做出了贡献，Jun 的主要贡献有：在多注册中心的服务发现支持，全局配置管理架构抽象；Xunzhuo 的主要贡献有：Higress E2E 测试流程的搭建，GitHub CI 流程的建设，hgctl 的整体架构设计。</p><p>在 1.3 版本中二位协作完成了 hgctl 的多样化能力建设，帮助 Higress 的易用性又上到了一个新的台阶。</p><p>两位同学作为 Approver 积极参与社区贡献 PR 的 Review，目前分别是 Higress Tools SIG 和 Higress GatewayAPI SIG 的领导者。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="member韦鑫weixinx封宇腾fkbqf">Member：韦鑫(WeixinX)，封宇腾(Fkbqf)<a href="#member韦鑫weixinx封宇腾fkbqf" class="hash-link" aria-label="Member：韦鑫(WeixinX)，封宇腾(Fkbqf)的直接链接" title="Member：韦鑫(WeixinX)，封宇腾(Fkbqf)的直接链接">​</a></h3><p>两位都是通过中科院开源之夏（OSPP 2023）项目开始参与 Higress 贡献，WeixinX 是一名研二的学生，Fkbqf 是一名大三的学生。</p><p>在 1.3 版本中，WeixinX 实现了 hgctl plugin 子命令的能力，同时贡献了 Go 实现的 Basic Auth 插件，以及对标 Spring Cloud Gateway 请求响应转换能力的 Transformer 插件；Fkbqf 则实现了更为复杂的 OIDC 插件，具备比 Envoy 自带 OAuth2 Filter 更强大的功能，并且具备良好的扩展性。</p><p>两位同学除了开发贡献以外，用课余时间积极参与 Higress 社区周会，一起探讨和学习技术，不亦乐乎。能够成为你们人生学业进阶路上的阶梯，Higress 荣幸之至。</p><p>Higress 社区后续整体的 Roadmap 规划如下：</p><p><img loading="lazy" src="https://github.com/johnlanni/higress-group.github.io/assets/6763318/f646d9ad-d2d0-4496-b164-2884851e9e0c" alt="image" class="img_ev3q"></p><p>欢迎更多小伙伴一起加入我们：</p><p><img loading="lazy" src="https://github.com/johnlanni/higress-group.github.io/assets/6763318/d8e09712-0b3b-4c5a-b478-c84da139cf2f" alt="higress-comm" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/plugin-transformer">通过 Higress Wasm 插件 3 倍性能实现 Spring-cloud-gateway 功能</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-27T00:00:00.000Z" itemprop="datePublished">2023年10月27日</time> · <!-- -->阅读需 11 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">WeixinX</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><blockquote><p>导读: 本文将和大家一同回顾 Spring Cloud Gateway 是如何满足 HTTP 请求/响应转换需求场景的，并为大家介绍在这种场景下使用 Higress 云原生网关的解决方案，同时还对比了两者的性能差异。</p></blockquote><h1>1. SCG 修改请求/响应</h1><p>在 <a href="https://cloud.spring.io/spring-cloud-gateway/reference/html/" target="_blank" rel="noopener noreferrer">Spring Cloud Gateway</a> (以下简称为 SCG) 中，当我们需要对 HTTP 请求或响应进行修改时，SCG 提供了许多内置的 <a href="https://cloud.spring.io/spring-cloud-gateway/reference/html/#gatewayfilter-factories" target="_blank" rel="noopener noreferrer">GatewayFilter</a> 来满足我们对这种应用场景的需求，例如 AddRequestHeader,AddRequestParameter, DedupeResponseHeader,MapRequestHeader, ModifyRequestBody 等。</p><p>考虑以下简单用例：</p><ul><li>添加请求头部 X-First，值从请求路径中获取，例如从 /response-headers?testKey=testValue 中获取 &quot;response-headers&quot;；</li><li>将请求头部 X-First 的值映射给 X-Second；</li><li>添加请求查询参数 k1=v1；</li><li>剔除重复的响应头部 X-Dedupe。</li></ul><p>在 SCG 中使用 GatewayFilter 我们可以这样配置：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># application.yaml:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cloud</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gateway</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">routes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test_route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> lb</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//httpbin</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">predicates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> Path=/</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/</span><span class="token important">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">filters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> AddRequestHeader=X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">First</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> MapRequestHeader=X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">First</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Second</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> AddRequestParameter=k1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> DedupeResponseHeader=X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dedupe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> RETAIN_FIRST</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>相信拥有 SCG 使用经验的同学对上述配置一定不陌生，那么本文将重点给出另一种能够<strong>满足上述需求并且性能更加优越的解决方案——使用 Higress 云原生网关的 Transformer 插件</strong>。</p><h1>2. Higress 插件与 SCG 性能比较</h1><p>我们在同一吞吐量水平（QPS）上，开启/关闭 <a href="https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions/transformer" target="_blank" rel="noopener noreferrer">Higress Transformer 插件</a> 和 SCG 相应 GatewayFilters，统计两者在 CPU 和内存资源上的开销。</p><p>经过<a href="https://gist.github.com/WeixinX/c24f4ded37832dd7e753b2d27470f0fc" target="_blank" rel="noopener noreferrer">测试</a>，我们得到的结论是：</p><ul><li>在 Higress 未启用 Transformer 插件，SCG 未启用 GatewayFilters 的条件下，SCG 的 CPU, 内存资源开销分别约为 Higress的 3.30, 4.88倍；</li><li>在 Higress 启用 Transformer 插件，SCG 启用相应 GatewayFilters 的条件下，SCG 的 CPU,内存资源开销分别约为 Higress 的 2.98, 3.19倍。</li></ul><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/61d3ec0b-b708-41e6-9f28-96108b4b55c6" alt="相同 QPS 下的 CPU 开销" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/a60415d5-bed6-47cf-a976-b8e55a818e14" alt="相同 QPS 下的内存开销" class="img_ev3q"></p><p><strong>可见 Higress Transformer 相比于 SCG GatewayFilter 有着相当不错的性能表现！</strong></p><p>接下来我们将进一步为大家介绍 Higress 云原生网关以及上述提到的 Higress Transformer 插件。</p><h1>3. Higress 简介</h1><p><a href="https://higress.io/zh-cn/" target="_blank" rel="noopener noreferrer">Higress</a> 是基于阿里内部的 Envoy Gateway 实践沉淀、以开源 Istio + Envoy 为核心构建的下一代云原生网关，实现了流量网关+微服务网关+安全网关三合一的高集成能力，深度集成 Dubbo、Nacos、Sentinel 等微服务技术栈，能够帮助用户极大地降低网关的部署及运维成本且能力不打折；在标准上全面支持 Ingress 与 Gateway API，积极拥抱云原生下的标准 API 规范；同时，Higress Controller 也支持 Nginx Ingress 平滑迁移，帮助用户零成本快速迁移到 Higress。
Higress 提供了一套 <a href="https://github.com/alibaba/higress/tree/main/plugins" target="_blank" rel="noopener noreferrer">Wasm (WebAssembly) SDK</a>，使得开发者能够轻松使用 C++，Golang，Rust 开发 Wasm 插件增强网关能力。下面将为大家介绍 Higress Transformer 插件的基本功能，最后简单说明 Transformer 插件的核心代码逻辑。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/c93bc55d-8cca-47ac-8b63-64168626f9a9" alt="Higress Architecture" class="img_ev3q"></p><h1>4. Transformer 插件介绍</h1><p>Higress Transformer 插件可以对请求/响应头部、请求查询参数、请求/响应体参数进行转换，支持的转换操作类型包括删除（remove）、重命名（rename）、更新（replace）、添加（add）、追加（append）、映射（map）和去重（dedupe）。</p><p>接下来我们复现最开始提到的 SCG GatewayFilter 简单用例，来演示如何使用该插件（以下使用 Higress 控制台可以很方便地部署插件，当然也可以使用 <a href="https://github.com/higress-group/higress-demo/tree/main/wasm-demo/wasm-plugin-transformer" target="_blank" rel="noopener noreferrer">K8s YAML Manifests 的方式</a>）：</p><ol><li>首先根据<a href="https://higress.io/zh-cn/docs/user/quickstart" target="_blank" rel="noopener noreferrer">官方文档</a> 快速安装 Higress，结果如下：</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n higress-system get deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console-grafana      </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console-prometheus   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-controller           </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-gateway              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>通过 Higress 控制台添加域名（foo.bar.com）、路由配置（foo），将流量转发至后端的 <a href="https://httpbin.org/" target="_blank" rel="noopener noreferrer">httpbin</a> 服务：</li></ol><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/4a6b2ed0-f42b-4ffa-8b36-99f7444a9e5f" alt="image" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/151442fd-b43a-40e3-8fcf-7afa49f69af9" alt="image" class="img_ev3q"></p><ol start="3"><li>为 foo 路由添加 Transformer 插件（当前未推送插件至官方镜像仓库，可以先使用 docker.io/weixinx/transformer:v0.1.0，或到代码仓库自行构建）：</li></ol><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/fb522095-ee88-4f77-89c2-8a8547a3a96f" alt="image" class="img_ev3q"></p><p>注：为了能够同时完成请求和响应转换的需求，我们需要为 foo 路由再添加一个 Transformer 插件，命名为 transformer-resp，用于处理响应方向。</p><ol start="4"><li>添加 Transformer 配置并开启该插件：</li></ol><ul><li>添加请求头部 X-First，值从请求路径中获取，例如从 /response-headers?testKey=testValue 中获取 &quot;response-headers&quot;；</li><li>将请求头部 X-First 的值映射给 X-Second；</li><li>添加请求查询参数 k1=v1；</li><li>剔除重复的响应头部 X-Dedupe。</li></ul><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># transformer:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> request  </span><span class="token comment" style="color:#999988;font-style:italic"># 指定 Transformer 类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># 指定转换规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">operate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> add </span><span class="token comment" style="color:#999988;font-style:italic"># 指定转换操作类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">headers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># 指定头部转换规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">First</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $1  </span><span class="token comment" style="color:#999988;font-style:italic"># 正则表达式捕获组 $1，支持 RE2 语法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path_pattern</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ^\/(\w+)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">\</span><span class="token punctuation" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">.</span><span class="token important">*$</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">querys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 指定查询参数转换规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">operate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">headers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">First</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Second</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># transformer-resp:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">operate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dedupe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">headers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dedupe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> RETAIN_FIRST</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="5"><li>发送请求进行测试：</li></ol><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 验证请求方向转换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">$ curl -v -H &quot;host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo.bar.com&quot; &quot;127.0.0.1/get&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">&quot;args&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 添加了查询参数 k1=v1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&quot;k1&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">&quot;headers&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&quot;X-First&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;get&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 添加了请求头部 X-First，值 &quot;get&quot; 来自请求路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&quot;X-Second&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;get&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 映射了请求头部 X-Second</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 添加了查询参数 k1=v1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">&quot;url&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://foo.bar.com/get?k1=v1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 验证响应方向转换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">$ curl -v -H &quot;host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo.bar.com&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;127.0.0.1/response</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dedupe=1</span><span class="token important">&amp;X-Dedupe=2&amp;X-Dedupe=3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">&lt; x-dedupe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 保留了响应头部 X-Dedupe 的第一个值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 通过查询参数传给 httpbin 的自定义响应头部</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">&quot;X-Dedupe&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>❗️需要注意的是：</p><ul><li>与上述例子相同，若有同时处理请求和响应转换的需求，则需要为相应路由添加两个 Transformer 插件，分别处理请求方向和响应方向（正在优化）；</li><li>请求体支持的 Content-Type 有：application/json, application/x-www-form-urlencoded, multipart/form-data；而响应体仅支持 application/json；</li><li>更多说明详见<a href="https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions/transformer" target="_blank" rel="noopener noreferrer">插件文档</a>。</li></ul><h1>5. Transformer 逻辑</h1><p>本节将简单说明 Higress Transformer 插件的核心代码逻辑，希望可以为有兴趣优化该插件或进行二次开发的同学提供一些帮助。</p><p>首先该插件代码位于Higress 仓库的 plugins/wasm-go/extensions/transformer 目录下，使用 Higress 提供的 <a href="https://github.com/alibaba/higress/tree/main/plugins" target="_blank" rel="noopener noreferrer">Wasm SDK</a> 进行开发（关于如何开发 Wasm 插件详见<a href="https://higress.io/zh-cn/docs/user/wasm-go" target="_blank" rel="noopener noreferrer">官方文档</a>）。</p><p>插件的配置模型 TransformerConfig：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 模型以插件配置的形式暴露给用户</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> TransformerConfig </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  typ   </span><span class="token builtin">string</span><span class="token plain">          # Transformer 类型，</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">TransformRule # 转换规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  trans Transformer # Transformer 实例，不对用户暴露配置，用于实际的转换操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> TransformRule </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  operate </span><span class="token builtin">string</span><span class="token plain">   # 转换操作类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  headers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">Param  # header 参数 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  querys  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">Param  # query 参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  body    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">Param  # body 参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Param </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key         </span><span class="token builtin">string</span><span class="token plain"> # 表示字段的 key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       </span><span class="token builtin">string</span><span class="token plain"> # 表示字段的 value 或 key </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> 或 strategy </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dedupe</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  valueType   </span><span class="token builtin">string</span><span class="token plain"> # 为 application</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">json body 指定 value 的数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hostPattern </span><span class="token builtin">string</span><span class="token plain"> # host 正则匹配模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pathPattern </span><span class="token builtin">string</span><span class="token plain"> # path 正则匹配模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中 Transformer 作为接口分别有请求和响应两个实现（requestTransformer, responseTransformer），主要实现了 3 个接口方法 TransformHeaders,TransformerQuerys 和 TransformBody：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Transformer </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">TransformHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hs </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">TransformQuerys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> qs </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">TransformBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> body </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> Transformer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">requestTransformer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> Transformer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">responseTransformer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由于头部（Headers）和查询参数（Querys）都是以 key-value 的形式存在，因此通过 kvHandler 对两者采用统一的处理逻辑；而 Body 由于请求、响应支持不同的 Content-Type，因此分别通过 requestBodyHandler (kvHandler, jsonHandler 组合)和 responseBodyHandler (jsonHandler) 进行处理。综上，在修改该插件逻辑时，主要对 kvHandler 和 jsonHandler 进行修改即可，其中 jsonHandler 依赖 <a href="https://github.com/tidwall/gjson" target="_blank" rel="noopener noreferrer">GJSON</a> 和 <a href="https://github.com/tidwall/sjson" target="_blank" rel="noopener noreferrer">SJSON</a> 工具库。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/fc08ff0c-12ec-4dfd-b946-4e83f8431174" alt="image" class="img_ev3q"></p><p>目前 handler 中的转换顺序是被硬编码的（remove -&gt; rename -&gt; replace -&gt; add -&gt; append -&gt; map -&gt; dedupe），我们对此有优化的打算，也欢迎感兴趣的同学参与进来 ~</p><h1>6. 总结</h1><p>本文带大家了解了 Higress Transformer 插件，并与 Spring Cloud Gateway 进行了性能比较，在文章的最后还说明了该插件的核心代码逻辑，希望能够为大家从 Spring Cloud Gateway 迁移至 Higress 提供帮助！</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/c2a47afd-5f29-4cfc-b5c5-571d2265ec19" alt="image" class="img_ev3q"></p><p>如果您觉得 Higress 对您有帮助，欢迎前往 <a href="https://github.com/alibaba/higress" target="_blank" rel="noopener noreferrer">Github: Higress</a> 为我们 star⭐️ 一下！期待与您在 Higress 社区相遇 ~</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/2023-kubecon">Higress在2023 KubeCon China的分享</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-28T00:00:00.000Z" itemprop="datePublished">2023年9月28日</time> · <!-- -->阅读需 9 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">澄潭</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="分享简介">分享简介<a href="#分享简介" class="hash-link" aria-label="分享简介的直接链接" title="分享简介的直接链接">​</a></h2><p>在9月26日的2023 KubeCon阿里云云原生开放日，Higress的分享内容分为两部分：</p><p>Part 1. 由上海费芮网络科技系统运维副总监戴喜军，带来费芮在选型企业版Higress作为K8s Ingress替代Nginx Ingress的介绍</p><p>Part 2. 由Higress开源社区负责人澄潭，带来Higress开源项目的介绍</p><p>开源版和企业版是Higress的一体两面，通过本次分享，相信大家会对Higress有更全面的了解。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-1-费芮互动使用higress作为kubernetes-ingress实现稳定性和性能提升">Part 1. 费芮互动使用Higress作为Kubernetes Ingress实现稳定性和性能提升<a href="#part-1-费芮互动使用higress作为kubernetes-ingress实现稳定性和性能提升" class="hash-link" aria-label="Part 1. 费芮互动使用Higress作为Kubernetes Ingress实现稳定性和性能提升的直接链接" title="Part 1. 费芮互动使用Higress作为Kubernetes Ingress实现稳定性和性能提升的直接链接">​</a></h2><p>费芮通过Higress解决了原本Nginx Ingress网关的诸多痛点，性能提升90%，响应时间下降50%，并大幅提升业务入口的稳定及安全性，高效支撑每日1亿+粉丝交互， 4万+线下门店、每月3000万+笔的移动支付需求。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="费芮业务场景">费芮业务场景<a href="#费芮业务场景" class="hash-link" aria-label="费芮业务场景的直接链接" title="费芮业务场景的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/0d4f761d-1471-49b6-a03c-38b11304262d" alt="image" class="img_ev3q">
<img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/dba8ae2a-93c8-4368-af3d-739f97090d39" alt="image" class="img_ev3q"></p><p>费芮专注于移动营销、O2O、社交媒体、移动电商领域的创新与研发。费芮互动自主研发的自媒体平台运维超过2亿粉丝 ； 有超过4万家线下门店采用费芮O2O解决方案。费芮的主要客户包括优衣库，必胜客，肯德基，星巴克，SPG，欧莱雅，Innisfree，迪卡侬，顶新集团等。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/61791bae-b40c-4b90-bc4d-c23bc052911c" alt="image" class="img_ev3q"></p><p>费芮内部业务系统的日均发布次数达到100次之多，会涉及到400多条Ingress路由规则的日常更新，且网关每天需要承载的PV流量达到了1个亿。Ingress网关的性能和稳定性至关重要。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nginx-ingress-痛点">Nginx Ingress 痛点<a href="#nginx-ingress-痛点" class="hash-link" aria-label="Nginx Ingress 痛点的直接链接" title="Nginx Ingress 痛点的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/1d8a178e-05de-4114-96b3-7d4e11240374" alt="image" class="img_ev3q"></p><p>配置变更频繁，导致Nginx进程频繁重启，大量连接瞬时断开后并发重连会导致后端服务产生压力，严重时造成大量请求失败。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/52e6ff5a-7374-4fe9-b001-ff6d3ac97744" alt="image" class="img_ev3q"></p><p>Nginx Ingress的Controller组件和Nginx组件运行在同一个POD中，控制面资源使用还会影响到数据面的性能。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/b09a3db4-465b-46b8-8e35-bd274388f143" alt="image" class="img_ev3q"></p><p>Nginx Ingress还缺少面向服务限流的能力，只能实现面向单个来源IP限流，对于后端服务保护来说没有意义。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="higress-收益">Higress 收益<a href="#higress-收益" class="hash-link" aria-label="Higress 收益的直接链接" title="Higress 收益的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/48388f01-7796-4f7d-b7d1-fb7bd1522925" alt="image" class="img_ev3q"></p><p>Higress企业版采用了全托管架构，与业务集群分离，无需自己运维，稳定性有更好保障。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/5e689364-fb08-4ec1-9d71-49539da561b8" alt="image" class="img_ev3q"></p><p>配置更新都是动态加载，无需重启数据面，保障业务平稳发布，websocket连接的业务收益也特别明显，长连接可以始终保持不会断开。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/29ae8168-e84d-41fb-bb4f-a258c4200a7e" alt="image" class="img_ev3q"></p><p>开启了TLS硬件加速，TLS握手时延直接减半，QPS吞吐提升86%。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/4ace2996-5b5a-4331-90cb-8448c65042d5" alt="image" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/8664f436-c058-42bc-82c9-7355d24592ad" alt="image" class="img_ev3q"></p><p>开启WAF对吞吐影响还是比较明显的，下降了30%，但相比Ingress Nginx直接下降了90%，性能提升还是很明显，而且更大的优势是基于阿里云WAF产品，防护规则是实时更新的，而非Modsecurity的静态规则。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/10fca63d-a0bb-45a1-82ee-de115bf577e7" alt="image" class="img_ev3q"></p><p>Higress集成了Sentinel限流的能力，可以直接面向服务的QPS吞吐上限/并发数上线进行限流，并且相比Nginx只能配置单机限制阈值，需要关注网关节点数量，Higress这里的配置是全局阈值，不受网关扩缩容影响。</p><p>触发限流后可以自定义响应内容或者重定向到指定地址，都是很实用的能力。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-2-higress开源之路扎根开源生态定义云原生网关">Part 2. Higress开源之路：扎根开源生态，定义云原生网关<a href="#part-2-higress开源之路扎根开源生态定义云原生网关" class="hash-link" aria-label="Part 2. Higress开源之路：扎根开源生态，定义云原生网关的直接链接" title="Part 2. Higress开源之路：扎根开源生态，定义云原生网关的直接链接">​</a></h2><p>开源是云原生生态的基石，Higress也是借助了开源生态的力量，站在Istio/Envoy的肩膀上开发出了更多实用的功能，我们选择将MSE Higress（企业版）中的核心能力全部开源，决心扎根在开源生态中，让Higress变得更普惠，有更多人使用，从而让Higress更加强大。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="简介">简介<a href="#简介" class="hash-link" aria-label="简介的直接链接" title="简介的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/438dcf9a-96fa-4d0d-89ed-e810746c61ab" alt="image" class="img_ev3q"></p><p>Higress实际上有三次诞生过程：第一次是在阿里集团内部业务需求驱动下诞生；第二次是随着内部使用逐渐成熟沉淀为阿里云上的MSE Higress云原生网关产品；第三次是随着云产品成熟，2022年11月在云栖大会上正式宣布开源。2023年5月Release了第一个GA版本，意味着开源版本也走入成熟阶段。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/783b96cc-b628-4784-a6cf-c2cf10e11f3f" alt="image" class="img_ev3q"></p><p>从配置流转的过程来看Higress的架构：</p><ol><li>首先用户可以通过UI控制台/命令行工具多种方式来下发配置</li><li>到了控制面，如果是K8s下，配置持久化基于CRD，如果不是K8s，配置持久化基于Nacos</li><li>除了用户下发的路由配置，实现服务路由还需要的服务IP地址信息，支持从K8s service/Nacos/Eureka/Consul/ZooKeeper/DNS/固定IP等多种方式获取</li><li>Higress数据面是基于Envoy，配置通过xDS下发，这里复用了Istio的配置下发机制，因为是内置了这个机制，无需单独部署Istio</li><li>最终配置下发到数据面生效，Higress基于Envoy扩展了很多能力，而且基于Wasm扩展机制，可以很方便开发自定义插件，且具备全局/域名/路由维度的生效粒度</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="核心能力">核心能力<a href="#核心能力" class="hash-link" aria-label="核心能力的直接链接" title="核心能力的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/be02b599-f82f-42be-a8e5-82f69b9196b8" alt="image" class="img_ev3q">
<img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/4dc3cc2b-d6fe-4717-a53a-3e75c5f826ca" alt="image" class="img_ev3q"></p><p>高集成：同时集成经典微服务生态和K8s开源生态能力，可以帮助业务从传统架构迁移到云原生架构，基于流量灰度等能力，可以保障这一过程的平滑</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/87f8eacd-39b6-4a26-a7a1-b78f6a5abb4f" alt="image" class="img_ev3q"></p><p>标准化：兼容Nginx Ingress常用注解，基于统一的Ingress标准可以轻松实现Nginx到Higress这一技术鸿沟的跨越，Higress也已经支持Gateway API，路由标准本身也能借助Higress实现平滑升级</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/33776d12-baf3-4d09-ae42-a5cadb655bef" alt="image" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/b9e4a718-c985-4ac4-9b7b-46a427ccb987" alt="image" class="img_ev3q"></p><p>易扩展：借助Higress的Wasm SDK，很少的业务代码就可以开发一个灵活的插件；并且支持基于OCI镜像标准分发，可以让插件的文档，配置约束等跟随插件本身一起被分发和共享；和传统Nginx类网关最大的差别，在于插件的分发集成阶段，实现了插件版本更新跟网关自身版本更新的解耦。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/d037bd1d-89c1-4f9c-b489-857b46de31ca" alt="image" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/65f71cee-09d9-4e7b-aa6e-bd4c9a60de83" alt="image" class="img_ev3q"></p><p>热更新：Envoy相比Nginx更合理的配置系统抽象，让Higress具备了Nginx Ingress无法实现的配置热更新能力</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="回顾与展望">回顾与展望<a href="#回顾与展望" class="hash-link" aria-label="回顾与展望的直接链接" title="回顾与展望的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/f46c4d68-8e31-44bb-afc6-c02c9fccb105" alt="image" class="img_ev3q"></p><p>Higress开源的前半年，专注于开源生态的打通和易用性的提升，并基于Github Action构建了开源的集成测试体系，来保障项目质量，在今年5月份发布第一个GA稳定版本后，在多个核心社区开发者的努力下，我们又很快发布了1.1和1.2两个大版本，推出了非K8s部署/Knative支持等重量级功能。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/3ba10a71-b3f0-4ede-a150-c64e0b1003c4" alt="image" class="img_ev3q"></p><p>未来的RoadMap，Higress会聚焦在Gateway API/插件生态/API管理三个方向上，随着社区开发团队的不断壮大，Higress已经建立了多个不同方向的<a href="https://github.com/alibaba/higress/issues/547" target="_blank" rel="noopener noreferrer">SIG</a> 并行推进核心功能演进，未来将不断有重量级功能推出，尽请期待。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="直播回看">直播回看<a href="#直播回看" class="hash-link" aria-label="直播回看的直接链接" title="直播回看的直接链接">​</a></h2><p><a href="https://www.aliyun.com/activity/middleware/CloudNative_Meetup" target="_blank" rel="noopener noreferrer">https://www.aliyun.com/activity/middleware/CloudNative_Meetup</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/config-with-file">基于文件配置实现 Higress 极简独立部署</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-08-25T00:00:00.000Z" itemprop="datePublished">2023年8月25日</time> · <!-- -->阅读需 4 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">CH3CHO</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前置准备">前置准备<a href="#前置准备" class="hash-link" aria-label="前置准备的直接链接" title="前置准备的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="安装-docker-compose">安装 Docker Compose<a href="#安装-docker-compose" class="hash-link" aria-label="安装 Docker Compose的直接链接" title="安装 Docker Compose的直接链接">​</a></h3><p>请参考 Docker 官方文档来安装 Docker Engine，其中已经内置了 Docker Compose 组件：<a href="https://docs.docker.com/engine/install/" target="_blank" rel="noopener noreferrer">https://docs.docker.com/engine/install/</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="环境验证">环境验证<a href="#环境验证" class="hash-link" aria-label="环境验证的直接链接" title="环境验证的直接链接">​</a></h3><ol><li>启动终端；</li><li>执行 <code>docker compose version</code> 命令，确认可以正常输出 Docker Compose 的版本。<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Docker Compose version v2.20.2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="安装-higrees">安装 Higrees<a href="#安装-higrees" class="hash-link" aria-label="安装 Higrees的直接链接" title="安装 Higrees的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="确定配置目录">确定配置目录<a href="#确定配置目录" class="hash-link" aria-label="确定配置目录的直接链接" title="确定配置目录的直接链接">​</a></h3><p>由于这次我们准备使用文件来管理 Higress 的配置数据，所以需要先确定保存配置文件的目录。下面我们将以 <code>~/higress/conf</code> 目录为例进行介绍。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="执行安装">执行安装<a href="#执行安装" class="hash-link" aria-label="执行安装的直接链接" title="执行安装的直接链接">​</a></h3><p>启动终端，并执行以下命令：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -fsSL https://higress.io/standalone/get-higress.sh | bash -s -- -c file://~/higress/conf -p &lt;你的密码&gt; -a</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>请耐心等待安装过程执行完毕。Higress 的执行文件将被安装在当前目录下的 <code>higress</code> 子目录内。配置数据则将被写入 <code>~/higress/conf</code> 目录内。</p><p>在安装完成后，脚本会自动启动 Higress。当终端输出如下信息时，则说明 Higress 已安装完成并成功启动。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Higress is now started. You can check out its status by executing /home/ch3cho/higress/bin/status.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Higress Gateway is listening on:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  http://0.0.0.0:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  https://0.0.0.0:443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Visit Higress Console: http://localhost:8080/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="higress-路由配置">Higress 路由配置<a href="#higress-路由配置" class="hash-link" aria-label="Higress 路由配置的直接链接" title="Higress 路由配置的直接链接">​</a></h3><p>为了着重说明基于文件的路由配置方式，这里将不再展开介绍使用 Higress 控制台来进行配置的具体步骤。如有需要，大家可以查阅其他文档。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="创建服务来源">创建服务来源<a href="#创建服务来源" class="hash-link" aria-label="创建服务来源的直接链接" title="创建服务来源的直接链接">​</a></h4><p>使用文本编辑器将以下内容写入 <code>~/higress/conf/mcpbridges/default.yaml</code> 文件中：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.higress.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> McpBridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> httpbin.org</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> httpbin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dns</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="创建域名配置">创建域名配置<a href="#创建域名配置" class="hash-link" aria-label="创建域名配置的直接链接" title="创建域名配置的直接链接">​</a></h4><p>使用文本编辑器将以下内容写入 <code>~/higress/conf/configmaps/domain-foo.bar.com.yaml</code> 文件中：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> domain</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">foo.bar.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo.bar.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">enableHttps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;off&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="创建服务路由">创建服务路由<a href="#创建服务路由" class="hash-link" aria-label="创建服务路由的直接链接" title="创建服务路由的直接链接">​</a></h4><p>使用文本编辑器将以下内容写入 <code>~/higress/conf/ingresses/route-foo-bar.yaml</code> 文件中：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">higress.io/destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> httpbin.dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">higress.io/ignore-path-case</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;false&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> route</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">foo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ingressClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo.bar.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.higress.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> McpBridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">pathType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Prefix</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="请求验证">请求验证<a href="#请求验证" class="hash-link" aria-label="请求验证的直接链接" title="请求验证的直接链接">​</a></h3><p>在终端中执行以下命令：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://localhost/get?foo</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">bar -H </span><span class="token string" style="color:#e3116c">&#x27;Host: foo.bar.com&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>请求应返回一段包含请求信息的 JSON 数据：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;args&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;foo&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bar&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;headers&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;Accept&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*/*&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;Host&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;foo.bar.com&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;Original-Host&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;foo.bar.com&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;Req-Start-Time&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1693049173053&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;User-Agent&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;curl/8.1.2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;X-Amzn-Trace-Id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Root=1-11111111-111111111111111111111111&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;X-B3-Sampled&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;X-B3-Spanid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2222222222222222&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;X-B3-Traceid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;33333333333333333333333333333333&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;X-Envoy-Attempt-Count&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;X-Envoy-Decorator-Operation&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;httpbin.dns:80/*&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;X-Envoy-Internal&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;origin&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;192.168.16.1, 123.123.123.123&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;url&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://foo.bar.com/get?foo=bar&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="已知问题">已知问题<a href="#已知问题" class="hash-link" aria-label="已知问题的直接链接" title="已知问题的直接链接">​</a></h2><p>在 Windows 操作系统中，直接修改挂载到 Docker 容器中的本地文件后，容器内的进程无法收到通知（详情请查看 <a href="https://github.com/fsnotify/fsnotify/issues/292" target="_blank" rel="noopener noreferrer">fsnotify/fsnotify #292</a>）。如果要使用文件来保存配置数据的话，在直接修改配置文件后，Higress 无法立即加载到新的配置。如果需要在 Windows 上独立部署 Higress 网关，可以考虑通过 Higress Console 来管理配置信息，或使用 Nacos 保存网关配置。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考文档">参考文档<a href="#参考文档" class="hash-link" aria-label="参考文档的直接链接" title="参考文档的直接链接">​</a></h2><p>更多相关信息与 Higress 的其他部署方式可查阅以下文档：</p><ul><li><a href="/docs/user/quickstart">快速开始</a></li><li><a href="/docs/ops/deploy-by-helm">使用 Helm 进行云原生部署</a></li><li><a href="/docs/ops/deploy-by-docker-compose">基于 Docker Compose 进行独立部署</a></li></ul></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/DeployOnWindows">Windows 下 Higress 部署实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-07-28T00:00:00.000Z" itemprop="datePublished">2023年7月28日</time> · <!-- -->阅读需 4 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">Fkbqf</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前置准备">前置准备<a href="#前置准备" class="hash-link" aria-label="前置准备的直接链接" title="前置准备的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置-wsl2">配置 WSL2<a href="#配置-wsl2" class="hash-link" aria-label="配置 WSL2的直接链接" title="配置 WSL2的直接链接">​</a></h3><p>详情参看步骤1-5,顺便在微软商店中下载Terminal。</p><p><a href="https://learn.microsoft.com/zh-cn/windows/wsl/install-manual" target="_blank" rel="noopener noreferrer">WSL手动安装步骤</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="下载-docker-desktop">下载 Docker Desktop<a href="#下载-docker-desktop" class="hash-link" aria-label="下载 Docker Desktop的直接链接" title="下载 Docker Desktop的直接链接">​</a></h3><ol><li><p><strong>访问 Docker Desktop 官方下载页面</strong></p><p>在浏览器中打开 <a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener noreferrer">Docker Desktop 的官方下载页面</a></p></li><li><p><strong>下载 Docker Desktop</strong></p><p>在下载页面，找到适用于 Windows 的 Docker Desktop 版本，然后点击下载。</p></li><li><p><strong>运行安装程序</strong></p><p>下载完成后，找到下载的安装程序（通常在你的 &quot;下载&quot; 文件夹中），然后双击运行。</p></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="安装-cygwin">安装 Cygwin<a href="#安装-cygwin" class="hash-link" aria-label="安装 Cygwin的直接链接" title="安装 Cygwin的直接链接">​</a></h3><p><a href="http://www.cygwin.com/" target="_blank" rel="noopener noreferrer">cygwin官网</a></p><p>选择setup-x86_64.exe，等待安装完成。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="验证-cygwin-安装是否成功">验证 Cygwin 安装是否成功<a href="#验证-cygwin-安装是否成功" class="hash-link" aria-label="验证 Cygwin 安装是否成功的直接链接" title="验证 Cygwin 安装是否成功的直接链接">​</a></h4><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cygcheck -c cygwin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="7.png" src="/zh-cn/assets/images/7-f31de94adfaa4fac24dbf1d410079a70.png" width="595" height="377" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="为-cygwin-配置环境变量">为 Cygwin 配置环境变量<a href="#为-cygwin-配置环境变量" class="hash-link" aria-label="为 Cygwin 配置环境变量的直接链接" title="为 Cygwin 配置环境变量的直接链接">​</a></h4><p><img loading="lazy" alt="8.png" src="/zh-cn/assets/images/8-0edaba7a8d7beee2abf67ed25756fe11.png" width="776" height="627" class="img_ev3q"></p><p><img loading="lazy" alt="9.png" src="/zh-cn/assets/images/9-e13e9c70896872ee5ba92afcdb4e5c34.png" width="493" height="605" class="img_ev3q"></p><p><img loading="lazy" alt="10.png" src="/zh-cn/assets/images/10-f7ca28c3f9f21b743a80b5d989dd74ae.png" width="632" height="666" class="img_ev3q"></p><p><img loading="lazy" alt="11.png" src="/zh-cn/assets/images/11-70aebeb53894ffb9cfffd3bfade7d8ee.png" width="541" height="570" class="img_ev3q"></p><p>点击确定即可添加成功</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="安装-higrees">安装 Higrees<a href="#安装-higrees" class="hash-link" aria-label="安装 Higrees的直接链接" title="安装 Higrees的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="准备-nacos">准备 Nacos<a href="#准备-nacos" class="hash-link" aria-label="准备 Nacos的直接链接" title="准备 Nacos的直接链接">​</a></h3><p><a href="https://nacos.io/zh-cn/docs/v2/quickstart/quick-start-docker.html" target="_blank" rel="noopener noreferrer">nacos官网手册</a></p><p>我们这里选择nacos-docker的模式安装</p><p><img loading="lazy" alt="A.png" src="/zh-cn/assets/images/A-321115aaea59ff9a6e4a07b9393b9207.png" width="1076" height="564" class="img_ev3q"></p><p>下载解压zip文件,进入 nacos-docker-master 文件夹右键选择终端打开，执行命令，我们这里选择单机模式部署</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    docker-compose -f example/standalone-derby.yaml up</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等待出现界面，即安装成功</p><p><img loading="lazy" alt="B.png" src="/zh-cn/assets/images/B-f819ffcf4f15baa1010207f2726bb032.png" width="1731" height="1195" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用-higrees-对接-nacos">使用 Higrees 对接 Nacos<a href="#使用-higrees-对接-nacos" class="hash-link" aria-label="使用 Higrees 对接 Nacos的直接链接" title="使用 Higrees 对接 Nacos的直接链接">​</a></h3><p><strong>安装命令：使用独立部署的 Nacos</strong></p><p>当访问docker容器互相访问时候本地回环地址并不是真正的地址，所以需要在cygwin中执行获取本地网卡地址</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ipconfig</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="C.png" src="/zh-cn/assets/images/C-c0ee57511e3244545ceebb126834c3d3.png" width="1993" height="1209" class="img_ev3q"></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -fsSL https://higress.io/standalone/get-higress.sh | bash -s -- -c nacos://192.168.0.1:8848 --nacos-username=nacos --nacos-password=nacos</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>请将 <code>192.168.0.1</code> 替换为 Nacos 服务器的 IP（如果 Nacos 部署在本机，请不要使用如 <code>localhost</code> 或 <code>127.0.0.1</code> 的 Loopback 地址），并按需调整 <code>--nacos-username</code> 和 <code>--nacos-password</code> 的取值。如果 Nacos 服务未开启认证功能，则可以移除这两个参数。</p><p>在这里未开启授权服务，直接使用WLANIP替换对应的IP</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -fsSL https://higress.io/standalone/get-higress.sh </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bash</span><span class="token plain"> -s -- -c nacos://10.30.0.225:8848</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>输入命令等待部署，即可看到生成的用户名与密码</p><p><img loading="lazy" alt="D.png" src="/zh-cn/assets/images/D-42927806049c82e382d903d50a93841b.png" width="606" height="662" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="higress-控制台配置">Higress 控制台配置<a href="#higress-控制台配置" class="hash-link" aria-label="Higress 控制台配置的直接链接" title="Higress 控制台配置的直接链接">​</a></h3><p><strong>访问 <code>http://localhost:8080/</code>, 登录 Higress 控制台。首次访问时需要先设置用户名密码</strong></p><p><img loading="lazy" alt="13.png" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAhgAAAFKCAYAAABfKiZxAAAgAElEQVR4nO3dfXSU1bn+8WsYQ1IkQwokBkgiIMVJKDWGChhtjW9terSQUivVikUtFi1ITj1WpLZVawOec9pfPL5Ra5VKS2urGF+OHcViPLVDwBpi1SQCBgwhCQHiZAI0Qxye3x8zGfIyExPYdDLJ97MWy+SZ/TyzzVqSy3vfe4/NsixLAAAABg2L9gQAAMDgQ8AAAADGETAAAIBxBAwAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAgAg67Pn4EDAAAIrDZbNGeQswiYAAAAOMIGAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBgAAMA4AgYAADCOgAEAAIwjYAAAAOMIGAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBgAAMA4AgYAADCOgAEAAIwjYAAAAOMIGAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAJ0nCVClxpvTnv4Z//Yhf+vJvLE2939Kqv1qh620+qeQlaeMbkmVZ4W8GgAGOgAGcJP42qf1Q72N8fsn3cddrTz0rfeMG6cvfkF4ptZ28CQLASUTAAAYYz+FjXx/8KHrzAIATcUq0JwCgq4VXWpJsShohXXZZtGcDAMeHgAEMMKNG2rTs+mjPAgBODAEDOElOGyvt90nbtktFVZY+2h24PvaoTTd80dL5020abrdJ6trI2eaTPtgV+PqMiVJC/LHX/H6/Pqyt0+7aPfr4qF+TJmYoPW28mpr2qc13RGPGfFpJo0ZJkpr27VNr6yElJp4qSXrn3WqNPDVeZ5wxRWPHjA49b099g2p379E/Dx9UymmpmjB+XOj1zjree+euWjU3f6SJp6dr0qTTw45taNyrD2p2qaFhr8aNO02TTk/X+PHjZLPRUwIMFQQM4CT50oXSOpf0s99Li26x6bHKQJBo+MjSskdtOsUr/fw/LP1XW9f73G8GGjwlqaJUmnZm4GvLsnTLrT/UljfLQ7tLbDabUlNP06kjPqUPanbpxhsWaNH1CyRJ9z/4K73yaqlSU09Tc/NH8vl8kqT5V8zVbd9fIkk9nidJ8fHxKrprhS64ILfLvH58z3165dXSHmMf/p/7dNb0aaFra9b+QY88ukZ+vz90zW6367prv6nFixYe748TQIyhyRM4SVLOCvzzny3S63+WbrnQplsutGlOTuD/4ts+lm7+kU3/9qm+/V/9vSt/oc1b3pJlWfp8Tra++51rdd65M9XYuFc7PtgZdkurZVlqaGiU3W7XrJkzFB8fr69/7auyLEs//EmRNm95S5J0fu4sfee6b+n0jDT5fD794M57VFVVHXrO5i1b9MqrpRo2bJgK5nxFS266QVPOmCSfz6el/75CDY17Q2PXrvuT/H6/PvvZTBUu/a5mzZwhv9+vx574nd5wbz7eHyeAGEMFAzhJyj62tOhbNv1mg/SPKqlyr5Q8wdKENOnWa21a8zup8ZD00nppzf/0HjIOHjyoDRv/T5J0zdXf0NKbbpDdbpff79fadX/SQ6sfj3hmxogRI/Tr1f9Pn5kyWZ6WFiWNGqWGxr0q/T+3JOlbV12hwiU3SpIWXP0NLV5ym6re365nnntJd2Y6JUn/ePd9WZalpKRRuuXmRXI4ElUw5ytavOQ2SdK7776rcamnydPSopYWr2w2m1be80ONSz1NV135NRXdV6z3qt7Xu+9V6fzcWUZ+vgAGNgIGcJLs/Ejyj7V067dt+u1L0gG/tL9F8gyTag5Zuv82m675nrStUvLUSsqI/KyNpW/o8OHDGjNmdCgMSIGlh4ULvqkX/vdlfVhbF/benOzp+syUyZIU6s/4oGZXaMlk3779unfVL0LjTz010LOxteKd0LXsz31WdrtdBw4061vX3azL8i/WjLPP0oPFqzRm9KdDvRVJo0ZpzJjROnCgWfOvuVFfuuQCfeHc2frO9dcoJXms7HZ7/3+QAGISAQM4iWpbpfO/ZuknC22qb5He2X2sUpE6Rpo0XtrmkUr/Ll10fuTnvL9thyQpZeyYsK+npp4WMWCMHduzCXN3XX3o65c3vBb2vsa9+0Jfn/P5s3XTjQv14CO/VkNDox574nd67InfSZLmXp6vO+/4fihk3PuT5Sq87Uc6fPiwSp7/s0qe/7Mk6fSMNP36l8WhkANgcCNgAP8i40cF/nRo73SCp/9Q4OyLSBITR0qSDv/zn2Ffb/tnW9jrkZw64lOSAssnjz7887Bj7MO6tmgtXPBN/Vv+xWpobNI771bp5Vc2qur97XruRZfS0ydo4YJvSgqEkZdf+IN2767T9g92aWPpG/rbpi36sLZOd/30v1T83/f2a64AYhNNnkAMOHf2OZICVYWanR92ea2hca+2f7CzX8/LdE6V3W7X4cOH1eptlXPqlNAfn8+nv76xSZvfLJcUaBT90zPPa/Wv1qhs81v63GezdM1VV2jNYw8o88zPSJIq3n5XkrTh1b9o9a/W6IWXNigz06k5l+er+L/v1Q+Cu1Y2bf77Cf0cAMQOKhhADDhr+jSdnpGmD2vrtHDRLSq6Z4Uy0ido7959uvPuVTp8+PAnP6ST8eNSlZKSrIaGRt2z8he6+87va+zYZNXu3qPbf/hT+Xw+Fcz5iqTAVtiKf7yrlze8JrvdLm/rQU3/bKY8zS3atqNGkjRm9KclScPsw/XrNetkWZa2bduhr152ifx+yfXKRklSSkqywZ8KgIGMgAHEiB98/yYt+fc7dfjwYRX+x51dXuvYUdJXp546Qr9e/Qt9dd4CNTQ06sbv/aDH85bcdEPo+3t+fLv+Xv62DhxoVvEDv+wy1maz6Yqvz5EkXXzhFzTznBxt3vKWXnjpFb3w0itdxi667lt9niOA2MYSCXCSXDAx8GdsL+dcXDBTuniWNPWMY2NGJ0lfuiTwZ0TisbGzZs7UM394XLNmzgg1VH4+J1u/f/KXysyc2uPZn5kyWbNmztAZkyeFfe+U5GT9ad1jmn/F3NC1ESNG6LvfuVYvv/hUl2ZMu92u3615RLcW3qwRI0aErs29PF8lf1wTWiqRpJ+vukv3/ezHGhM84dNms+ms6dP06EP/qa9e9uXefmQABhGbFWnzPIAB5dChQ7IsSyNHjuxykqckLbjuZlW9v123Ft6sq678Wr+f3VH9GDZs2Cce521Zlo4ePdqvsWxPBYYeKhhAjJj3zet18Veu0Ouvu2Wz2UK/3H0+n+qDJ2lmhalk9IXdbpfdbu/TZ4XYbLZ+jwUw9BAwgBiReeZn5Pf79aOf3qftO2rU1tYmr7dVy269Uy0tXo0ZM7rLZ4IAQDSxRALEiNrddbruxmVqafHKbrcrPj5efr8/dCLnj1fcqjmX50d5lgAQQMAAYsiePfV67Infyb357zp48JDsdruynFN1zdVX8BkfAAYUAgYAADCOHgwAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYR8AAAADGETAAAIBxBAwAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYd0q0JzBU+Xw+1dfXq729PdpTAYABIS4uTmlpaYqLi4v2VGCAzbIsK9qTGIp27typMWPGyuFIjPZUAGBA8HpbdeDAfk2aNCnaU4EBLJFESXt7O+ECADpxOBKp6g4iBAwAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYR8CIYZu3bFFBQYHOPPNMnXnmmSooKNDmLVuiPS0AAAgYsWrDq3/RtQsWaPz48XrwoYf14EMPa/z48bp2wQJtePUvUZxZrcpLS1Veezy3luv1192q9BifFADgX4xPU42Sbdu2aerUqcd1r9fbqosuulDz5s3TihUrurxWVFSk9evXa+PG1/rwYWq1Ki+tkbc/bz48Rdm5WUrqZYin0q2390nJZ+Uqq7eBXW+Su6JJSslWbp9vAjDYnMjfjRhYTon2BNB/VdVVam1t1ZIlS3u8tmTJUv3mN79RVXWVZs2c2afnOSbnKSej04XacpXWJfQIEp5Ktyq6VBc8qnRXqOlI+Oc2VZSqqdu14eECRDBcHAncpNLuNwXZbMP7F1oAAFFDwIhB1VVVkhS2QtFxrbqq7wHjRPUIKGEFwkiP1Y+OcOGYrLxID+mobiRnES4AIEbQgxGDZs6cJUlhGzo7rnWMGcg8lW6VBpdF8sbuV2mYxo2OMQmT81g6AYAYQgUjBmVmOuV0OrWyqEgPPfSwJkwYL0nas6deK4uK5HQ6lZnp7PPzvDWlKq3pcVUV4dYqhh//vLuoLVdFU4Im5+UqQ5LHM1YpdTUqdR8MLs109Ic4QmMAALGDgBGjVq26TwsWXKO5c+coKytLklRZWSlJWrv2t/161vH3YJyAjBzldXrPpKQMJeU6JHdFKNgMT8lWHlULAIhJBIwY5PW26tln16u1tVWJiYnqvBGotTXw2oQJS/uwi8TQfMJWQMKLXADptKOlt34MAEBMIGDEGK+3Vddeu0B1dXVauXKl5s2b1+X19evXq6ioSFu2bNGTT67tQ8gYrgTHcc9GbUdOrMnTU+lWRfdtKN4alYZNLA5NzsthuQQAYgABI8YUFf1MdXV1Wrv2t2H7LObNm6fMzCwtWHCNiop+plWrVkV+mOeg2nRE3jDbSfveg9HXgJKkrNy80He15aWq8QaWQbJTKlXRltZ71cJTKXdFW1/eCAAwABAwYkhVVbWeffZZrVy5stcmzsxMp1asWKE77rhDS5feEmoC7cHbpiPhqgJ97cHwHFSbEjT2ONokMnLyQu/pqez//QCAgY1tqjHk1Vc3aMKECT2WRcKZN2+eJkyYoPXrn4k4pna/VxqeoONdIfHUe3TkBO4HAAxeBIwYsmXLFk2YMKHP4ydMmKCq4KFcPXgqVeeVHGm9H/vdQ8LI4HiP6j1HNDxpfP/uBwAMCSyRxJC1a9caG++p9+iIY7JyP6FjsnsTpmNy8IbaGjUdcWiyqW2kERs7O6NWAgCxgoAxRCVl5Sov0oudz6jIylVeVs8htfu9ckzOM7ej45O2ptLkCQAxhU9TjRI+MRAAeuLvxsGDHgwAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQSMKImLi5PX2xrtaQDAgOH1tiouLi7a04AhnOQZJT6fT/X19Wpvb4/2VABgQIiLi1NaWhohY5AgYAAAAONYIgEAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYR8AAAADGETAAAIBxBAwAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYR8AAAADGETAAAIBxBAwAAGDcKdGewFDl8/lUX1+v9vb2aE8FAAaEuLg4paWlKS4uLtpTgQE2y7KsaE9iKNq5c6fGjBkrhyMx2lMBgAHB623VgQP7NWnSpGhPBQawRBIl7e3thAsA6MThSKSqO4gQMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYR8AAAADGETAAAIBxfBZJDPN6W1VVXdXlWqYzkxNCAQBRR8CIUTfffLP+8pe/hH3t4osv1sMPP/wvnhEABPh8Pj333HPKu/BCpSQnR3s6iBICRgxav369tmzZogcferhHtcLrbdUdy2/X+vXrNW/evON4eq3KS2vUlpKt3KwkMxMGMKj4fD69V1mppr175fV6JUnx8fGaMmWK0tMz9NxzJWppaYnyLBFtBIwYtGfPHmVmZurSSy4O+/qTmZnas2fPcT49Q5NT6lTRVKParBxlRBpWW67SGm+Py8NHT1bSwRo1HQl/m2NynnIiPhTAQFe+das2ud2yLEvp6elKT0+XJLW0tOi1116Tz+dTfHy8rpw/n+rFEEfAGKo8lXJXNClCDpB0RDWlparpdtVmG67ks3KVlZGjvAxJ8qjSXaG2tM7BIUNZPd9Qle5KyWFo/gD+5Vwul9577z3l5uYqJydH8fHx8npbJUnx8cO1b98+tbS0aM7cAn2wYwcBY4gjYAxpDk3O61al8FTKXTtSuZ8LV2aoVXlpXddLnnp5jjiU1nm4p1LuijaldXm2V21HEjSWVRcgJpVv3aodO3YoPz9f06ZNk8/n09q1a9XU1CRJSkhIkGVZunL+fEmS2+1WfEKCcs4+O5rTRhSxTXWoSspSbt5kHXSXqrS8Vp5Kt0rLayV/utIS9qu0tFy1kgKVh8AYKUM5ebnq3JrhqffoiGNsj6UU/4iErsWK2v3yDk+ggAHEIK+3VZvcbuWed56mTZsmSXruueeUnJysRYtuVEpKSihcpCQnKyU5WRdedJE2ud2hCgeGHioYMaSqqlorVxZpz549amlp0bXXXhthXJXq6+v15ptv6o47Vigz0xn+gbU12tc+XClZGVJ9sDIxJlEZY3KUkVIpd3CJxDE5T3kZHm1750NNnX565weopklKye4WL7xt8n+c0OWS52CblDBWFDCA2ON2/00OhyNUjWjat0+7d+/WkiVL9Mc//lEtLS26cv58vexyacGCBZKknLPP1nvvviu3+2/Kz8+P5vQRJQSMGOJt9Wrz5s1asmRJr+POOeccSdKDDz4ob2vPRsyAWpXXeBWXkq2sJMlTL9k/PqhKd6majgR7LbLzlJUk1ZaXyr0/RQltTSp1H1J2bpaSJNWW18gryVtRqkCRNLDk4ugRJjyq9xyRI43uTmAwGOUI1CI7hwtJoeUSQCJgxKSlS5d2+b6jBNl9y+qDDz7Yy1MylJOXoUBfRYUCMaRJTY7JysvtHARqtd8rJUzOUk5GlmrLS1VZOV65I2sU2EQS7OMI9l0cm1SNSku7tYjWlKq0hp0kQKzJzT1PTz75G5Vv3RqqYiQkJHQJF6WvvaYZM2aE7infujXw+pVXRmXOiD4CxiDwve/dLElau3Zt328K7iJpD1YqcoKVippwwWB4ijpWQTJy8pQhqbbcK8eoUfK2WD0enZSVq7ye20jUccYGgNjicCQq97zz9NrGjUpMHKWyTX+TZVmaM7dAL7tcampq0pQpU3TuuedKkt577z29tnGjLrzoIsXHx0d59ogWAsYgkJmZ2e97apvalJWX16UnoiM89EVGTp4yastV2p+zdDwH1abhSqLTE4g5OWefraa9e/X8c892Oedi7twCxccPV3x8vHw+nzZt2iS3260ZM2awg2SII2AMAhdfckm/78mYmhPxtdryUtUlHOdJntvKVVrfs+/DZhuu5Em0eAKxyufzad++fYqPj9ecuQXa5HYrPj5eo0aNkhTov6irq5NlWaGtrBjaCBgxaPOWLf26Hlm4Q7IiqC1XaY16npvR3dQc5U2N9HaVcvdzhgCiz+fzdWnoHOVwaMqUKdqxY4d2794tSXI4HDo3N1fTsrJYFoEkAkZMuja4DWxg8HY68bP3tQ9PvUdHlKCRFDKAmBIfH6/09HR9OT8/dDrntGnTqFKgVwSMGDJr5kyVlDzXy9bTrhyJjshnYHTiDe7u6HqxQqU9dpyFCxARdpEEBRpHj30/PCWrz30eAAaOvLy8aE8BMcZmWVbPbQA46bZt26apUyOtJQxAfV0iAYATEHN/NyIiKhjom9CHmwEA8Mn4LBIAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQSMKImLi5PX2xrtaQDAgOH1tiouLi7a04AhHBUeJe3t7aqrq1N7e3u0pwIAA0JcXJzS0tIIGYMEAQMAABjHEgkAADCOgAEAAIwjYAAAAOMIGAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBgAAMA4AgYAADCOgAEAAIwjYAAAAOMIGAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBgAAMA4AgYAADCOgAEAAIw7JdoTGKp8Pp/q6+vV3t7er/vi4uKUlpamuLi4kzQzAABOnM2yLCvakxiKdu7cqTFjxsrhSOzXfV5vqw4c2K9JkyadpJkBAHDiqGBESXt7e7/DhSQ5HIlqbGw4rvesXuNUgUpUvdB5XPdLkjwuFd4l3VWcr6SuT9caZ4FWdRu+vKRMqatnq3FxtRY6JVWvkXN1qsq63B/+3h6Wn+DcgUHugful9KulguTIY0oel9Kvl2ZIUqU0bkMvD0yU3r5eSunlWTc5pIYrIgwI9/xEabmkVa09h+dPl564qJf5IKYQMAaz6jVyFnT/tV0gZ5jf5MtLggFAHrkKZ6vQ1WPAJ/xyd2phdbUWdnlvKdeZpKmLl8tZ4AwEiPxild19bu/3Rvp3KettAICll0rjXpByewkFBbOlcfdLLy6TZmRJDVkRBlZK48o6fR0piLQGntfdikulpR3P3ydd94J0X6d5Les2vmmj9FRqL/9yiDkEjMEuv7hbtaC7QKBoDH2fpPzialX39308LhXOLlR2SbUWKhBslpdUa6okOReqZPkqrU4tU3F+UmCsMzi2t1DT3fKS/s4KGJTeelq6fE/k188K8ws/VI3Ikt5ulG7f2M9qQZhqxgNPS0s7qhf7pOvWSXOvltJfl9ydxjW9I2lip3vDBA73Lil9ej/mgwGPgIG+6VYNcXUqZuQXl6k4P1/F1WVyFTrldEl33HGHVnZULUJmK3Dbcj1fHQwfkvoUaqhgACEzrpAaFAga7qxApaA/Ui6SnujPDVlSQ7J03f2BALF7nTTrKml+VtfqxYvLpN2PS7u/Ki3ttEzz1DuB+3qzu1XK7WVpB7GHgDHYuQo1uw9tC8sXf8IA50JVVy/s0UNRvcap1cEh1Wtmq9C1XM9XL9RUSd/+9re7PSRYqVBq6P9aPK5Czf7E0kWnaaxSH6oyAMIpeVy6Kdj78OKyQB9G00bprHci3NCpTeyBdZKmB/o7HpBkT5Ge+n3gtUeulgoUCCA3XSU9sk5SsBekaaNUlCi93Tk87JNcjk4hp1IqmhAITRg8CBiDXX+XSML2bQQsL4nUJ9EiV+FsufLLVFZ8l2Y7e080+csbdZfTKVd+scqKi1UdpnThcRVqduNimjoBgwquDwSBB7otoYRtruzcgyFp6bJAxSRUsQj2cTR0Gu9KlO5LkZ64VBr3ulRwgXR7MLx0LNusuFSa3yhpT8/ejXH3H+vdQOwjYKCrjkpFhN0iHleFlL04eM2jXRVS9uLTlV9crXxJHlfHkkn4SONxFeouFai4ulNUCbuzRNKqMm1b6AwtpQTuvSvis4GhqGhD4E9vjmt3RqcG0I6ejxWXBneMBJs+L+8WEFZcGuypCN771tNSzgTJpcB9JY9LuxVYomkIM5+O1zE4EDAGu+NcIqkuKVT24uoelY/GRpfyU+8yNj1JknOhyvILNdvpUnFZsY7lh1V62FWg4vykwBbbimKVGH5rIJZ19GJ0KHlc2j3bfAWg+/uot90n3e5L3ygVNZudD2IDAWOw6/cuEkkel1ZXFOuuhepWXahW2ap85Zf1XkFwFXY0c0aaUs+UkJRfrOoylwpLXFKFS43ZkpYXK981W85CBbbJFrNcAnRo2iid1Rz4RT+uMlAhKLg+EDKuawxWLII7O5YE+y36LbhM8vb1UkqYZzVtlG5X1+rIJ4acRum6DYGqRmf506WcMGdjIHYRMNBDdYlL+XcVK8njUmGwH6Okulqzywq0anmJqkP5olGNLkmdqh9J+cWqLlkjZ9nsbv0TwSDTceBW2PctlGuVlF1SrYJdhVrVOFH5xSVa7ixQn8owwFCxL9Db8MjVga876+izkAKNmZefFVjKeDFMyHhmvTR+jCX5bWHfpqlRkiPymRrHJTXycs0D70jp7CQZNAgYg11/l0g8Lq1e5ZJrlTNQ/aiuVrHHpcLZTq3Scj1f3f1h+UrtfjiOc6FKypxyFnZUT4K7R7JL1ON2BU8YXRXo3agOphfPrtDDtDC0/fXYDhVgKCt5QaEdHd0DRkhlcPdGntSQIo17uuuJm5ffHwgoZ7xjkyvCEsbuZil/dNdr3fsuJGlct10oK7oP6NTQ2eO1DvukcknpkV5HzCFgDHb9XSJJyldx920dSROVrXzllwV+uXfZWppfrLKkYyGhq27hxtXtFNH8Yj2ZXah1qR3BolprnLNDZ2csLynumEDgnAyPS4Wh3SdsU8XQ1blKoSxpxYbIp2l2brqUdCx4dBxyNV3KXxf+fiVKb3eEkmTpie7Hb4YRtlFzQtcmz84euF8q6jTuCSoYgwYfdhYlfNgZAGAwI2BECR/XDgAYzAgYAADAuGHRngAAABh8CBgAAMA4AgYAADCOgAEAAIwjYAAAAOMIGAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBgAAMA4AgYAADCOgAEAAIwjYAAAAOMIGAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBgAAMC4U6I9gaGqvkW67Gmp8WC0ZwIAA0PqSOl/r5DGj4r2TGCCzbIsK9qTGIrO/jXhAgC6Sx0pbb0h2rOACSyRRAnhAgB64u/GwYOAAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBgAAMA4AgYAADCOgAEAAIwjYAAAAOMIGMAg5m/e1eV7y7crwkgAMItPUwViWpv8zY1hrn9a9tGj9MbdE2WrlL64IRA2Hlg2UTmNge97Y/k8OnrI07cpJE6UPa7fE584qvoAAASZSURBVAcwyBEwgFiWnaDtF0xUuE+33vS6pa3NNs0/rVX+5qN64+6Jmtos/XjfUfm97bI74iM+dtFVSfppelLf5tAsjVt7fNMHMHjxce1RMu7+aM8Ag0Ob/F5bp7DQpuIFCZp/6lH9+JFh+tXZUvUF0ihJ2yulL25ok3+qtP0rCXIVS4W2E3v378yTfnoqAQNmNSyL9gxgAhUMIJZlJ2j7rDb9588tPT7Sp6NfjNP80dJTxcP0K5ukCsk1XZpvteoLL/p1dHqCtn8lQar7pHARaemlK+vjDNHKBSAcAgYQ4973JujeFZacr8Rrztk2uV/dpaUfHXt96f0Opa8YrfdvtjRqpC1YyfiEh/ay9NJD8wlMHsCgxRJJlLBEAlMs3y4tumqifpoe6LuwZtuU2629oqVO2psm6Z0PdX5Jaq/9F/3BEglOBpZIBgcqGEAM8zc3q2TFROXqqO78Sa0elaSNkUY7VLLidDX94KjuLNqlR8Pu/ujb0kgH6+MMyTokf/MBdexcAQCJCkbUUMGACa8vU2Abqiw1ZH1yx6ZlWVr/uk2X5Emjwu3+yD7WFHo8Nr1uaV7FCXaOYsijgjE4UMEAYtgFHUH1Ukm+4M6RSL/fs6XqC2z6uEJyvh1hTIXkrAgsuxw9FLzWUenoCB+d3ic0LlQNIVwACCBgAIOFdURHP2qUP9Lrh1MlJfTpUfd/Z6Lmjw5+0yylPrZLNk2UJG1pGaZrLv5Qq5+29MCy4DjOwgDQDQEDGCwSEnTv3RN1r4FHvffOUY2rGBY8atyhkhUTNe5A4LWd66T0m05X092B5tFxayVlS4ssRa6eABhyCBjAYLDBpnEbAj0ZW3scoNWmG+YM121xw+R8Rn1YxWjT6o2N0injAqd/KnBIV+4+qXp8YMTXV0vPLJam+Zvlb7bLXjGKcAGgC07IAQaRrc3S/MVtWtSpdfto5jDdNqmv/6m36WjmMG2/e6KafhSvA69bSvnJLp331C75D7d1Gfn11ZIrcbSa7h6lZ6btkt/rM/cvAiDmsYskSthFAhO6NGNKCixnjNbYbR/q/Ket0PfTGpv1mce9XW8Ot0310sBulNBukG67SlrqFKiCdPPMYik3XnrKwPHjALtIBgcCRpQQMGBCxy/24xEpLADRRsAYHOjBAGLY11dHewYAEB49GAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBhRkpzAAaoA0B1/Nw4eBIwo+e3lh/kPCQA6SU6w9NvLD0d7GjCEzyKJkra2Nvn9/mhPAwAGFLvdroSEhGhPAwZQwYiSuLg42e32aE8DAAYMu92uuLjuH/GLWEUFAwAwIFiWJZvNFu1pwBAqGACAAYFwMbgQMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYR8AAAADGETAAAIBxBAwAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYR8AAAADGETAAAIBxBAwAAGAcAQMAABhHwAAAAMb9f89fh/kzukK1AAAAAElFTkSuQmCC" width="536" height="330" class="img_ev3q"></p><p><strong>点击左侧“服务来源”导航栏，然后点击页面右侧的“创建服务来源”按钮。按照下图所示内容填写表单并点击“确定”按钮。</strong></p><p><img loading="lazy" alt="14.png" src="/zh-cn/assets/images/14-38328e899b78267f27be2e99f8f7cb72.png" width="970" height="435" class="img_ev3q"></p><p><strong>点击左侧“域名管理”导航栏，然后点击页面右侧的“创建域名”按钮。按照下图所示内容填写表单并点击“确定”按钮。</strong></p><p><img loading="lazy" alt="15.png" src="/zh-cn/assets/images/15-a79679960f6542a80ae4626bb5741ce4.png" width="957" height="467" class="img_ev3q"></p><p><strong>点击左侧“路由管理”导航栏，然后点击页面右侧的“创建路由”按钮。按照下图片所示内容填写表单并点击“确定”按钮。</strong></p><p><img loading="lazy" alt="16.png" src="/zh-cn/assets/images/16-f68a4a744e7c6ef008ef7d0b44e03ce0.png" width="979" height="935" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="请求验证">请求验证<a href="#请求验证" class="hash-link" aria-label="请求验证的直接链接" title="请求验证的直接链接">​</a></h3><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># should output a JSON object containing request data </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://localhost/get?foo</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">bar -H </span><span class="token string" style="color:#e3116c">&#x27;host: foo.bar.com&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="E.png" src="/zh-cn/assets/images/E-bef754877d8c43a714b121f04b4e3071.png" width="465" height="307" class="img_ev3q"></p><p>更多详情与部署方案可参考 <a href="https://higress.io/zh-cn/docs/user/quickstart" target="_blank" rel="noopener noreferrer">quick start</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/configmap">Higress 全局配置控制面原理分析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-07-23T00:00:00.000Z" itemprop="datePublished">2023年7月23日</time> · <!-- -->阅读需 12 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">Jun</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Higress 有个全局配置 ConfigMap 对象 higress-config，参考配置如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">higress</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tracing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">sampling</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">skywalking</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> skywalking</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">oap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server.op</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11800</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>具体配置说明请参考 <a href="https://higress.io/zh-cn/docs/user/configmap" target="_blank" rel="noopener noreferrer">Higress 全局配置说明文档</a>，
本文介绍以 Tracing 为例，详细说明 Tracing 全局配置是如何转成 EnvoyFilter 和如何同时实现实时下发到 Higress Gateway过程。</p><p>本文涉及整体架构流程、初始化过程和启动、higress-config 变更和处理流程、通知 XDSUpdater、构建 EnvoyFilter 和下发以及如何扩展全局配置等内容。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="整体架构流程">整体架构流程<a href="#整体架构流程" class="hash-link" aria-label="整体架构流程的直接链接" title="整体架构流程的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-整体架构">1. 整体架构<a href="#1-整体架构" class="hash-link" aria-label="1. 整体架构的直接链接" title="1. 整体架构的直接链接">​</a></h3><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/configmap1-f2447fa1bd9826e78e29bcdf1f38a4ca.png" width="2704" height="1196" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-核心组件">2. 核心组件<a href="#2-核心组件" class="hash-link" aria-label="2. 核心组件的直接链接" title="2. 核心组件的直接链接">​</a></h3><ul><li>IngressConfig</li></ul><p>IngressConfig 是 Higress 一个核心结构体, 负责监控 Ingress， McpBridge, Http2Rpc, WasmPlugin 等 k8s 资源， 同时集成 ConfigStore Interface，通过 List 接口下发 VirtualService, DestinationRule, EnvoyFilter, ServiceEntry, WasmPlugin 等 CR 资源。</p><ul><li>ConfigmapMgr</li></ul><p>ConfigmapMgr 结构体负责整个核心流程，包括通过 Informer List/Watch 机制监控 higress-config 的变更，同时遍历 ItemControllers 下发变更通知，提供构建 EnvoyFilter 列表等功能。</p><ul><li>TracingController</li></ul><p>TracingController 结构体负责具体的 Tracing 数据校验，构建 Tracing EnvoyFilter, 以及通过 ItemEventHandler 下发变更通知等。</p><ul><li>HigressConfig</li></ul><p>HigressConfig 是 higress-config Configmap 所对应数据的结构体。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-核心流程">3. 核心流程<a href="#3-核心流程" class="hash-link" aria-label="3. 核心流程的直接链接" title="3. 核心流程的直接链接">​</a></h3><ul><li>用 Informer List/Watch 机制监控 higress-config 变更，校验变更，同时保存变更后数据。</li><li>用变更数据构建 EnvoyFilter。</li><li>通知 XDSUpdater，EnvoyFilter 有变更，重新拉取新的 EnvoyFilter 列表。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="初始化过程">初始化过程<a href="#初始化过程" class="hash-link" aria-label="初始化过程的直接链接" title="初始化过程的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-初始化入口">1. 初始化入口<a href="#1-初始化入口" class="hash-link" aria-label="1. 初始化入口的直接链接" title="1. 初始化入口的直接链接">​</a></h3><p>初始化过程入口在 NewIngressConfig， 初始化 IngressConfig 时同时构建 HigressConfigController 和 ConfigmapMgr。</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/config/ingress_config.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewIngressConfig(localKubeClient kube.Client, XDSUpdater model.XDSUpdater, namespace, clusterId string) *IngressConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 构建 controller 和 configmapMgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higressConfigController := configmap.NewController(localKubeClient, clusterId, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.configmapMgr = configmap.NewConfigmapMgr(XDSUpdater, namespace, higressConfigController, higressConfigController.Lister())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-higressconfigcontroller-初始化">2. HigressConfigController 初始化<a href="#2-higressconfigcontroller-初始化" class="hash-link" aria-label="2. HigressConfigController 初始化的直接链接" title="2. HigressConfigController 初始化的直接链接">​</a></h3><p>通过 Higress 提供 NewCommonController 初始化 HigressConfigController 用于监听 higress-system 命名空间下 Configmap 的变化。</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/controller.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type HigressConfigController controller.Controller[listersv1.ConfigMapNamespaceLister]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewController(client kubeclient.Client, clusterId string, namespace string) HigressConfigController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    informer := client.KubeInformer().Core().V1().ConfigMaps().Informer()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return controller.NewCommonController(&quot;higressConfig&quot;, client.KubeInformer().Core().V1().ConfigMaps().Lister().ConfigMaps(namespace),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        informer, GetConfigmap, clusterId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func GetConfigmap(lister listersv1.ConfigMapNamespaceLister, namespacedName types.NamespacedName) (controllers.Object, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return lister.Get(namespacedName.Name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-configmapmgr-初始化">3. ConfigmapMgr 初始化<a href="#3-configmapmgr-初始化" class="hash-link" aria-label="3. ConfigmapMgr 初始化的直接链接" title="3. ConfigmapMgr 初始化的直接链接">​</a></h3><p>ConfigmapMgr 初始化具体步骤如下：</p><ul><li>构建 ConfigmapMgr</li><li>设置 HigressConfigController configmap 新增或者更新回调函数为 configmapMgr.AddOrUpdateHigressConfig</li><li>设置 HigressConfig 结构体默认值</li><li>初始化 TracingController</li><li>把 tracingController 添加到 configmapMgr itemControllers 数组里</li><li>初始化 ItemEventHandler， 同时遍历 itemControllers，设置 ItemEventHandler</li></ul><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/controller.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewConfigmapMgr(XDSUpdater model.XDSUpdater, namespace string, higressConfigController HigressConfigController, higressConfigLister listersv1.ConfigMapNamespaceLister) *ConfigmapMgr {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  构建 ConfigmapMgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr := &amp;ConfigmapMgr{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        XDSUpdater:              XDSUpdater,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Namespace:               namespace,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HigressConfigController: higressConfigController,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HigressConfigLister:     higressConfigLister,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        higressConfig:           atomic.Value{},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 设置 HigressConfigController configmap 新增或者更新回调函数 configmapMgr.AddOrUpdateHigressConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr.HigressConfigController.AddEventHandler(configmapMgr.AddOrUpdateHigressConfig)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 设置 HigressConfig 结构体默认值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr.SetHigressConfig(NewDefaultHigressConfig())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 初始化 TracingController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tracingController := NewTracingController(namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 把 tracingController 添加到 configmapMgr itemControllers 里</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr.AddItemControllers(tracingController)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 初始化 itemEventHandler， 同时遍历 itemControllers，设置 itemEventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr.initEventHandlers()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 返回 configmapMgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return configmapMgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="启动">启动<a href="#启动" class="hash-link" aria-label="启动的直接链接" title="启动的直接链接">​</a></h2><p>在 IngressConfig 添加 HigressConfigController Run() 和 HasSynced() 控制流程。</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/config/ingress_config.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (m *IngressConfig) Run(stop &lt;-chan struct{}) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 启动 HigressConfigController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    go m.configmapMgr.HigressConfigController.Run(stop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (m *IngressConfig) HasSynced() bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if !m.configmapMgr.HigressConfigController.HasSynced() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higress-config-变更和处理流程">higress-config 变更和处理流程<a href="#higress-config-变更和处理流程" class="hash-link" aria-label="higress-config 变更和处理流程的直接链接" title="higress-config 变更和处理流程的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-configmapmgr-变更处理">1. configmapMgr 变更处理<a href="#1-configmapmgr-变更处理" class="hash-link" aria-label="1. configmapMgr 变更处理的直接链接" title="1. configmapMgr 变更处理的直接链接">​</a></h3><p>ConfigmapMgr 通过收到 HigressConfigController 通知来处理变更请求。</p><p>具体变更流程如下：</p><ul><li>判断是否 higress-system 命名空间下 name 为 higress-config Configmap 发生了变化，如果不是就返回。</li><li>获取 higress-config 内容。</li><li>遍历 ItemControllers, 校验 higress-config 配置是否合法，如果有一个返回不合法，就返回。</li><li>和上次保存在本地 higressConfig 比对, 检查这次数据是否有变化，如果没有变化就返回。</li><li>如果数据有变化，就遍历 ItemControllers 通知每个 itemController 数据有变化，同时保存这次变化到本地 higressConfig。</li></ul><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/controller.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (c *ConfigmapMgr) AddOrUpdateHigressConfig(name util.ClusterNamespacedName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 只监听 higress-system 命名空间下 name 为 higress-config Configmap 的变化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if name.Namespace != c.Namespace || name.Name != HigressConfigMapName {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取 higress-config 内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higressConfigmap, err := c.HigressConfigLister.Get(HigressConfigMapName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 通过 yaml.Unmarshal 转成 HigressConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newHigressConfig := NewDefaultHigressConfig()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err = yaml.Unmarshal([]byte(higressConfigmap.Data[HigressConfigMapKey]), newHigressConfig); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IngressLog.Errorf(&quot;data:%s,  convert to higress config error, error: %+v&quot;, higressConfigmap.Data[HigressConfigMapKey], err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 遍历 ItemControllers, 校验配置是否合法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for _, itemController := range c.ItemControllers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if itemErr := itemController.ValidHigressConfig(newHigressConfig); itemErr != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Errorf(&quot;configmap %s controller valid higress config error, error: %+v&quot;, itemController.GetName(), itemErr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 和上次比对这次数据是否有变更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    oldHigressConfig := c.GetHigressConfig()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result, _ := c.CompareHigressConfig(oldHigressConfig, newHigressConfig)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果数据有变更，就遍历 ItemControllers 通知每个 itemController 数据有变更，同时保存这次变更到本地。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if result == ResultReplace || result == ResultDelete {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for _, itemController := range c.ItemControllers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Infof(&quot;configmap %s controller AddOrUpdateHigressConfig&quot;, itemController.GetName())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if itemErr := itemController.AddOrUpdateHigressConfig(name, oldHigressConfig, newHigressConfig); itemErr != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                IngressLog.Errorf(&quot;configmap %s controller AddOrUpdateHigressConfig error, error: %+v&quot;, itemController.GetName(), itemErr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 保存这次变更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c.SetHigressConfig(newHigressConfig)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-tracingcontroller-变更处理">2. TracingController 变更处理<a href="#2-tracingcontroller-变更处理" class="hash-link" aria-label="2. TracingController 变更处理的直接链接" title="2. TracingController 变更处理的直接链接">​</a></h3><p>TracingController 变更处理就比较简单：</p><ul><li>检查 Tracing 这部分数据是否有变更。</li><li>如果有变更，DeepCopy 一份 Tracing 数据保存到本地，同时通过 eventHandler 下发变更通知。</li></ul><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/tracing.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (t *TracingController) AddOrUpdateHigressConfig(name util.ClusterNamespacedName, old *HigressConfig, new *HigressConfig) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 检查 Tracing 部分数据是否有变更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result, _ := compareTracing(old.Tracing, new.Tracing)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果有变更，DeepCopy 一份 Tracing 数据保存到本地，同时通过 eventHandler 下发变更通知</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    switch result {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case ResultReplace:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if newTracing, err := deepCopyTracing(new.Tracing); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Infof(&quot;tracing deepcopy error:%v&quot;, err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.SetTracing(newTracing)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Infof(&quot;AddOrUpdate Higress config tracing&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.eventHandler(higressTracingEnvoyFilterName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Infof(&quot;send event with filter name:%s&quot;, higressTracingEnvoyFilterName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case ResultDelete:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t.SetTracing(NewDefaultTracing())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IngressLog.Infof(&quot;Delete Higress config tracing&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t.eventHandler(higressTracingEnvoyFilterName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IngressLog.Infof(&quot;send event with filter name:%s&quot;, higressTracingEnvoyFilterName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="通知-xdsupdater">通知 XDSUpdater<a href="#通知-xdsupdater" class="hash-link" aria-label="通知 XDSUpdater的直接链接" title="通知 XDSUpdater的直接链接">​</a></h2><p>在 ConfigmapMgr 初始化时候调用 configmapMgr.initEventHandlers()， 这个 func 会创建 ItemEventHandler, 同时遍历 ItemControllers 设置 ItemEventHandler。</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/config.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type ItemEventHandler = func(name string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/controller.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (c *ConfigmapMgr) initEventHandlers() error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    itemEventHandler := func(name string) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c.XDSUpdater.ConfigUpdate(&amp;model.PushRequest{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Full: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigsUpdated: map[model.ConfigKey]struct{}{{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Kind:      gvk.EnvoyFilter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name:      name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Namespace: c.Namespace,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }: {}},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Reason: []model.TriggerReason{ModelUpdatedReason},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for _, itemController := range c.ItemControllers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        itemController.RegisterItemEventHandler(itemEventHandler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里 XDSUpdater 是从 IngressConfig 初始化传入， XDSUpdater.ConfigUpdate() 用于更新通知下发。</p><p>进一步跟踪可以发现在 Higress controller server 启动时执行 s.initXdsServer 函数创建 s.xdsServer，具体逻辑不在本文讨论范围, 有兴趣可以进一步阅读源码。</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/bootstrap/server.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewServer(args *ServerArgs) (*Server, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s := &amp;Server{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerArgs:      args,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        httpMux:         http.NewServeMux(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        environment:     e,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        readinessProbes: make(map[string]readinessProbe),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        server:          server.New(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s.environment.Watcher = mesh.NewFixedWatcher(&amp;v1alpha1.MeshConfig{})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s.environment.Init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initFuncList := []func() error{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s.initKubeClient,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s.initXdsServer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s.initHttpServer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s.initConfigController,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s.initRegistryEventHandlers,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s.initAuthenticators,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for _, f := range initFuncList {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if err := f(); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return nil, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return s, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/bootstrap/server.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (s *Server) initXdsServer() error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log.Info(&quot;init xds server&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s.xdsServer = xds.NewDiscoveryServer(s.environment, nil, PodName, PodNamespace, s.RegistryOptions.KubeOptions.ClusterAliases)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return s.initGrpcServer()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="构建和下发-envoyfilters">构建和下发 EnvoyFilters<a href="#构建和下发-envoyfilters" class="hash-link" aria-label="构建和下发 EnvoyFilters的直接链接" title="构建和下发 EnvoyFilters的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-ingressconfig-list-下发-envoyfilters-列表">1. IngressConfig List 下发 EnvoyFilters 列表<a href="#1-ingressconfig-list-下发-envoyfilters-列表" class="hash-link" aria-label="1. IngressConfig List 下发 EnvoyFilters 列表的直接链接" title="1. IngressConfig List 下发 EnvoyFilters 列表的直接链接">​</a></h3><p>IngressConfig List 用于 VirtualService, DestinationRule, EnvoyFilter, ServiceEntry, WasmPlugin 等 CR 资源下发， 这里主要关注 EnvoyFilter CR 资源下发。</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/config/ingress_config.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (m *IngressConfig) List(typ config.GroupVersionKind, namespace string) ([]config.Config, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if typ != gvk.Gateway &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        typ != gvk.VirtualService &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        typ != gvk.DestinationRule &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        typ != gvk.EnvoyFilter &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        typ != gvk.ServiceEntry &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        typ != gvk.WasmPlugin {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nil, common.ErrUnsupportedOp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if typ == gvk.EnvoyFilter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        m.mutex.RLock()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        defer m.mutex.RUnlock()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var envoyFilters []config.Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 调用 ConfigmapMgr ConstructEnvoyFilters 获取需要下发 EnvoyFilter 列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configmapEnvoyFilters, err := m.configmapMgr.ConstructEnvoyFilters()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Errorf(&quot;Construct configmap EnvoyFilters error %v&quot;, err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for _, envoyFilter := range configmapEnvoyFilters {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                envoyFilters = append(envoyFilters, *envoyFilter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Infof(&quot;Append %d configmap EnvoyFilters&quot;, len(configmapEnvoyFilters))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if len(envoyFilters) == 0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Infof(&quot;resource type %s, configs number %d&quot;, typ, len(m.cachedEnvoyFilters))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return m.cachedEnvoyFilters, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 需要下发 configmap EnvoyFilter 列表 和 m.cachedEnvoyFilters 列表聚合一下下发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        envoyFilters = append(envoyFilters, m.cachedEnvoyFilters...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IngressLog.Infof(&quot;resource type %s, configs number %d&quot;, typ, len(envoyFilters))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return envoyFilters, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}   </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>调用 ConfigmapMgr ConstructEnvoyFilters 获取需要下发 EnvoyFilter 列表， 同时和 m.cachedEnvoyFilters 列表聚合一下再下发。</p><p>这里 m.cachedEnvoyFilters 是在构建 VirtualService 时生成，有兴趣可以进一步阅读 IngressConfig 源码。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-configmapmgr-构建-envoyfilter-列表">2. ConfigmapMgr 构建 EnvoyFilter 列表<a href="#2-configmapmgr-构建-envoyfilter-列表" class="hash-link" aria-label="2. ConfigmapMgr 构建 EnvoyFilter 列表的直接链接" title="2. ConfigmapMgr 构建 EnvoyFilter 列表的直接链接">​</a></h3><p>这里比较简单，遍历一下 ItemControllers，聚合每个 itemController 返回的 EnvoyFilters.</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// /pkg/ingress/kube/configmap/controller.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (c *ConfigmapMgr) ConstructEnvoyFilters() ([]*config.Config, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configs := make([]*config.Config, 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for _, itemController := range c.ItemControllers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IngressLog.Infof(&quot;controller %s ConstructEnvoyFilters&quot;, itemController.GetName())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if itemConfigs, err := itemController.ConstructEnvoyFilters(); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Errorf(&quot;controller %s ConstructEnvoyFilters error, error: %+v&quot;, itemController.GetName(), err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            configs = append(configs, itemConfigs...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return configs, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-tracingcontroller-构建-envoyfilters">3. TracingController 构建 EnvoyFilters<a href="#3-tracingcontroller-构建-envoyfilters" class="hash-link" aria-label="3. TracingController 构建 EnvoyFilters的直接链接" title="3. TracingController 构建 EnvoyFilters的直接链接">​</a></h3><p>这里就比较简单，根据保存的 Tracing 数据构建对应的 EnvoyFilter</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/tracing.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (t *TracingController) ConstructEnvoyFilters() ([]*config.Config, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tracingConfig := t.constructTracingTracer(tracing, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if len(tracingConfig) == 0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return configs, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config := &amp;config.Config{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Meta: config.Meta{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            GroupVersionKind: gvk.EnvoyFilter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name:             higressTracingEnvoyFilterName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Namespace:        namespace,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Spec: &amp;networking.EnvoyFilter{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigPatches: []*networking.EnvoyFilter_EnvoyConfigObjectPatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ApplyTo: networking.EnvoyFilter_NETWORK_FILTER,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Match: &amp;networking.EnvoyFilter_EnvoyConfigObjectMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Context: networking.EnvoyFilter_GATEWAY,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ObjectTypes: &amp;networking.EnvoyFilter_EnvoyConfigObjectMatch_Listener{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            Listener: &amp;networking.EnvoyFilter_ListenerMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                FilterChain: &amp;networking.EnvoyFilter_ListenerMatch_FilterChainMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    Filter: &amp;networking.EnvoyFilter_ListenerMatch_FilterMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        Name: &quot;envoy.filters.network.http_connection_manager&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Patch: &amp;networking.EnvoyFilter_Patch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Operation: networking.EnvoyFilter_Patch_MERGE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Value:     util.BuildPatchStruct(tracingConfig),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ApplyTo: networking.EnvoyFilter_HTTP_FILTER,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Match: &amp;networking.EnvoyFilter_EnvoyConfigObjectMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Context: networking.EnvoyFilter_GATEWAY,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ObjectTypes: &amp;networking.EnvoyFilter_EnvoyConfigObjectMatch_Listener{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            Listener: &amp;networking.EnvoyFilter_ListenerMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                FilterChain: &amp;networking.EnvoyFilter_ListenerMatch_FilterChainMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    Filter: &amp;networking.EnvoyFilter_ListenerMatch_FilterMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        Name: &quot;envoy.filters.network.http_connection_manager&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        SubFilter: &amp;networking.EnvoyFilter_ListenerMatch_SubFilterMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            Name: &quot;envoy.filters.http.router&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Patch: &amp;networking.EnvoyFilter_Patch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Operation: networking.EnvoyFilter_Patch_MERGE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Value: util.BuildPatchStruct(`{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;name&quot;:&quot;envoy.filters.http.router&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;typed_config&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                &quot;@type&quot;: &quot;type.googleapis.com/envoy.extensions.filters.http.router.v3.Router&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                &quot;start_child_span&quot;: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configs = append(configs, config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return configs, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何扩展全局配置">如何扩展全局配置<a href="#如何扩展全局配置" class="hash-link" aria-label="如何扩展全局配置的直接链接" title="如何扩展全局配置的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-higressconfig-结构体添加对应的扩展配置">1. HigressConfig 结构体添加对应的扩展配置<a href="#1-higressconfig-结构体添加对应的扩展配置" class="hash-link" aria-label="1. HigressConfig 结构体添加对应的扩展配置的直接链接" title="1. HigressConfig 结构体添加对应的扩展配置的直接链接">​</a></h3><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type HigressConfig struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Tracing *Tracing `json:&quot;tracing,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 在这里添加对应的数据结构来扩展配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-增加扩展配置默认值">2. 增加扩展配置默认值<a href="#2-增加扩展配置默认值" class="hash-link" aria-label="2. 增加扩展配置默认值的直接链接" title="2. 增加扩展配置默认值的直接链接">​</a></h3><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/config.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewDefaultHigressConfig() *HigressConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higressConfig := &amp;HigressConfig{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Tracing: NewDefaultTracing(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 在这里增加扩展配置默认值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return higressConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-实现-itemcontroller-interface">3. 实现 ItemController interface<a href="#3-实现-itemcontroller-interface" class="hash-link" aria-label="3. 实现 ItemController interface的直接链接" title="3. 实现 ItemController interface的直接链接">​</a></h3><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type ItemController interface {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GetName() string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AddOrUpdateHigressConfig(name util.ClusterNamespacedName, old *HigressConfig, new *HigressConfig) error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValidHigressConfig(higressConfig *HigressConfig) error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConstructEnvoyFilters() ([]*config.Config, error)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RegisterItemEventHandler(eventHandler ItemEventHandler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-初始化扩展配置同时添加到-itemcontrollers">4. 初始化扩展配置，同时添加到 ItemControllers<a href="#4-初始化扩展配置同时添加到-itemcontrollers" class="hash-link" aria-label="4. 初始化扩展配置，同时添加到 ItemControllers的直接链接" title="4. 初始化扩展配置，同时添加到 ItemControllers的直接链接">​</a></h3><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func NewConfigmapMgr(XDSUpdater model.XDSUpdater, namespace string, higressConfigController HigressConfigController, higressConfigLister listersv1.ConfigMapNamespaceLister) *ConfigmapMgr {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tracingController := NewTracingController(namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr.AddItemControllers(tracingController)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 在这里初始化扩展配置，同时添加到 ItemControllers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr.initEventHandlers()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return configmapMgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="参与社区贡献">参与社区贡献<a href="#参与社区贡献" class="hash-link" aria-label="参与社区贡献的直接链接" title="参与社区贡献的直接链接">​</a></h2><p>Higress 开源贡献小组正在火热招募贡献者。早期参与开源更容易成为项目 Committer，并有更多机会成为 Higress PMC(Project Management Committee) 的一员，参与主导 Higress 社区的前进方向。
欢迎加入 Higress 社区群：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN0166Gkdt1cRTVjJ2skL_!!6000000003597-2-tps-720-405.png" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg"></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/blog/page/2"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">愿景</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/">为用户提供一站式云原生网关解决方案.</a></li></ul></div><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/docs/overview/what-is-higress">Higress是什么?</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-cn/docs/user/quickstart">快速开始</a></li><li class="footer__item"><a href="https://github.com/higress-group/higress-group.github.io/issues/new" target="_blank" rel="noopener noreferrer" class="footer__link-item">报告文档问题<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/higress-group/higress-group.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">在GitHub上编辑此文档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">资源</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/blog">博客</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-cn/community">社区</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="//img.alicdn.com/imgextra/i2/O1CN01oNTGgE1lfW7oEPIzP_!!6000000004846-2-tps-960-290.png" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="120" height="36"><img src="//img.alicdn.com/imgextra/i2/O1CN01oNTGgE1lfW7oEPIzP_!!6000000004846-2-tps-960-290.png" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="120" height="36"></div><div class="footer__copyright">Copyright © 2023 Higress<br>浙公网安备 33011002016922号 浙ICP备12022327号-1119</div></div></div></footer></div>
<script src="/zh-cn/assets/js/runtime~main.72d24805.js"></script>
<script src="/zh-cn/assets/js/main.3644cddb.js"></script>
</body>
</html>