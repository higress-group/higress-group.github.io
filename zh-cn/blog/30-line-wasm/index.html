<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">30行代码写一个Wasm Go插件 | Higress</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://higress.io/zh-cn/img/higress_logo_small.png"><meta data-rh="true" name="twitter:image" content="https://higress.io/zh-cn/img/higress_logo_small.png"><meta data-rh="true" property="og:url" content="https://higress.io/zh-cn/blog/30-line-wasm"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="30行代码写一个Wasm Go插件 | Higress"><meta data-rh="true" name="description" content="对《Higress 开源背后的发展历程和上手 Demo 演示》直播演示 demo 的详细说明"><meta data-rh="true" property="og:description" content="对《Higress 开源背后的发展历程和上手 Demo 演示》直播演示 demo 的详细说明"><meta data-rh="true" name="keywords" content="higress,wasm"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-11-22T00:00:00.000Z"><link data-rh="true" rel="icon" href="/zh-cn/img/higress_logo_small.png"><link data-rh="true" rel="canonical" href="https://higress.io/zh-cn/blog/30-line-wasm"><link data-rh="true" rel="alternate" href="https://higress.io/en-us/blog/30-line-wasm" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://higress.io/zh-cn/blog/30-line-wasm" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://higress.io/blog/30-line-wasm" hreflang="default"><link data-rh="true" rel="alternate" href="https://higress.io/blog/30-line-wasm" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Higress RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Higress Atom Feed">





<link rel="stylesheet" href="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.js"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-YHS75WKFBR" async></script><link rel="stylesheet" href="/zh-cn/assets/css/styles.e4fbdaa0.css">
<link rel="preload" href="/zh-cn/assets/js/runtime~main.b4f096e2.js" as="script">
<link rel="preload" href="/zh-cn/assets/js/main.2c422536.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="//img.alicdn.com/imgextra/i1/O1CN01I7WjVs1K33EQjInid_!!6000000001107-2-tps-960-290.png" alt="Higress logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="//img.alicdn.com/imgextra/i1/O1CN01I7WjVs1K33EQjInid_!!6000000001107-2-tps-960-290.png" alt="Higress logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><a class="navbar__item navbar__link" href="/zh-cn/docs/overview/what-is-higress">文档</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Higress 企业版</a><ul class="dropdown__menu"><li><a href="https://www.aliyun.com/product/aliware/mse?spm=higress-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">企业版说明</a></li><li><a href="https://free.aliyun.com/?searchKey=云原生网关&amp;spm=higress-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">免费试用</a></li></ul></div><a href="https://survey.aliyun.com/apps/zhiliao/SmDQwdihe" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">案例征集</a><a class="navbar__item navbar__link" href="/zh-cn/docs/developers/developers_dev">开发者</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a href="https://github.com/alibaba/higress/releases" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">下载</a><a href="http://demo.higress.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">控制台样例</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/en-us/blog/30-line-wasm" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/blog/30-line-wasm" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/console-dev">教程：如何在本地开发和调试 Higress 控制台</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/admin-sdk-intro">如何使用 Higress Admin SDK 进行配置管理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/higress-code">higress-core源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/e2e-debug">教程：如何在本地进行higress调试和端到端测试</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/hring">Higress 团队招募小伙伴加入～</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/release-1.3">Higress 开源一周年：新版本，新标准，新工具，新征程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/plugin-transformer">通过 Higress Wasm 插件 3 倍性能实现 Spring-cloud-gateway 功能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2023-kubecon">Higress在2023 KubeCon China的分享</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/config-with-file">基于文件配置实现 Higress 极简独立部署</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/DeployOnWindows">Windows 下 Higress 部署实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/configmap">Higress 全局配置控制面原理分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/ai_plugin">Higress助力AI大模型企业级应用落地</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/user-mq">美洽智能客服使用 Higress 统一网关落地实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/skywalking">Higress 集成 Skywalking 可观测性探索</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/ospp-2023">Higress 开源之夏项目报名</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/release-100">上线控制台，降低使用门槛 ｜ Higress 1.0.0 RC 版本发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/user-uu">UU跑腿基于Higress的云原生网关实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/release-070">Higress 0.7.0 版本发布：GA 进入倒计时</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos">Higress + Nacos 微服务网关最佳实践</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/zh-cn/blog/30-line-wasm">30行代码写一个Wasm Go插件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/first-meetup">欢迎报名Higress首次线下Meetup</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/higress">阿里巴巴重磅开源云原生网关</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="对《Higress 开源背后的发展历程和上手 Demo 演示》直播演示 demo 的详细说明"><meta itemprop="keywords" content="higress,wasm"><header><h1 class="title_f1Hy" itemprop="headline">30行代码写一个Wasm Go插件</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-11-22T00:00:00.000Z" itemprop="datePublished">2022年11月22日</time> · <!-- -->阅读需 14 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">澄潭</span></div></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2><p>在11月15号的直播 《Higress 开源背后的发展历程和上手 Demo 演示》中，为大家演示了 Higress 的 Wasm 插件如何面向 Ingress 资源进行配置生效，本文对当天的 Demo 进行一个回顾，并说明背后的原理机制。</p><p>本文中 Demo 运行的前提，需要在 K8s 集群中安装了 Higress，并生效了下面这份 quickstart 配置：
<a href="https://higress.io/samples/quickstart.yaml" target="_blank" rel="noopener noreferrer">https://higress.io/samples/quickstart.yaml</a>
这个 Demo 要实现的功能是一个 Mock 应答的功能，需要实现根据配置的内容，返回 HTTP 应答。
本文会按以下方式进行介绍：</p><ul><li>编写代码：代码逻辑解析</li><li>生效插件：说明代码如何进行编译打包并部署生效</li><li>测试插件功能：说明全局粒度，路由/域名级粒度如何生效</li><li>插件生效原理：对整体流程进行回顾，说明插件生效的原理</li><li>三个革命性的特性：介绍 Wasm 插件机制为网关插件开发带来的变革</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="编写代码">编写代码<a href="#编写代码" class="hash-link" aria-label="编写代码的直接链接" title="编写代码的直接链接">​</a></h2><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    . &quot;github.com/alibaba/higress/plugins/wasm-go/pkg/wrapper&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm/types&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;github.com/tidwall/gjson&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SetCtx(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;my-plugin&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ParseConfigBy(parseConfig),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ProcessRequestHeadersBy(onHttpRequestHeaders),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type MyConfig struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func parseConfig(json gjson.Result, config *MyConfig, log Log) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.content = json.Get(&quot;content&quot;).String()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func onHttpRequestHeaders(ctx HttpContext, config MyConfig, log Log) types.Action {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxywasm.SendHttpResponse(200, nil, []byte(config.content), -1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return types.ActionContinue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面代码中可以看到三个函数：</p><ul><li><p>main：插件通过 main 函数定义插件上下文，包括插件名称，用于解析配置的函数，以及用于处理请求/应答的函数</p></li><li><p>parseConfig：这个函数通过在 SetCtx 中指定的 ParseConfigBy 被挂载到插件配置解析阶段，传入的三个参数分别是：</p><ul><li>json：传入插件的配置，将统一序列化为一个 json 字典对象，提供 parseConfig 进行解析</li><li>config：parseConfig 将解析后的插件配置输出到这个 MyConfig 对象</li><li>log：提供日志输出接口</li></ul></li><li><p>onHttpRequestHeaders：函数中调用的 proxywasm.SendHttpResponse，用于实现直接返回 HTTP 应答，这个函数通过在 SetCtx 中指定的 ProcessRequestHeadersBy 被挂载到解析请求 Header 的执行阶段，其他的挂载方式还有：</p><ul><li><p>ProcessRequestBodyBy：挂载到解析请求 Body 的执行阶段</p></li><li><p>ProcessResponseHeadersBy：挂载到构造应答 Header 的执行阶段</p></li><li><p>ProcessResponseBodyBy：挂载到构造应答 Body 的执行阶段</p><p> 传入的三个参数分别是：</p></li><li><p>ctx：用于获取请求上下文，如 scheme/method/path 等，通过 ctx 可以设置自定义上下文，能跨执行阶段访问</p></li><li><p>config：提供 parseConfig 解析好的自定义配置</p></li><li><p>log：提供日志输出接口</p></li></ul></li></ul><p>这个 30 行代码实现的插件功能比较简单，这里有一些功能相对复杂的例子：<a href="https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions</a>
这里有插件 sdk 的详细使用文档：
<a href="https://higress.io/zh-cn/docs/user/wasm-go.html" target="_blank" rel="noopener noreferrer">https://higress.io/zh-cn/docs/user/wasm-go.html</a>
这个插件 sdk 是基于 Tetrate 社区的 proxy-wasm-go-sdk 实现的，如果关注更底层的细节，可以查看：
<a href="https://github.com/tetratelabs/proxy-wasm-go-sdk" target="_blank" rel="noopener noreferrer">https://github.com/tetratelabs/proxy-wasm-go-sdk</a>
<a href="https://github.com/alibaba/higress/blob/main/plugins/wasm-go/pkg/wrapper/plugin_wrapper.go" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress/blob/main/plugins/wasm-go/pkg/wrapper</a>
可以看到，Higress 的 wasm-go sdk 是通过 Go 1.18 引入的泛型特性封装了插件上下文处理细节，从而降低插件开发所需代码量，开发者只用关心配置解析和请求应答处理的逻辑。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="生效插件">生效插件<a href="#生效插件" class="hash-link" aria-label="生效插件的直接链接" title="生效插件的直接链接">​</a></h2><p>编写完成代码后，一共有三个步骤，实现插件逻辑的生效：</p><ol><li>编译：将 go 代码编译成 Wasm 格式文件</li><li>镜像推送：将 Wasm 文件打包成 docker 镜像，并推送至镜像仓库</li><li>下发配置：在 K8s 上创建 WasmPlugin 资源</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="编译">编译<a href="#编译" class="hash-link" aria-label="编译的直接链接" title="编译的直接链接">​</a></h3><p>将上面的 Go 文件 main.go 编译成 plugin.wasm</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tinygo build -o plugin.wasm -scheduler</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">none -target</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">wasi main.go</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="镜像推送">镜像推送<a href="#镜像推送" class="hash-link" aria-label="镜像推送的直接链接" title="镜像推送的直接链接">​</a></h3><p>编写 Dockerfile</p><div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM scratch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY plugin.wasm ./</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>构建并推送 Docker 镜像 （这里示例用的是 Higress 的官方镜像仓库）</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> build -t higress-registry.cn-hangzhou.cr.aliyuncs.com/plugins/demo:1.0.0 </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> push higress-registry.cn-hangzhou.cr.aliyuncs.com/plugins/demo:1.0.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="下发配置">下发配置<a href="#下发配置" class="hash-link" aria-label="下发配置的直接链接" title="下发配置的直接链接">​</a></h3><p>编写 wasmplugin.yaml，配置说明：</p><ul><li>selector： 选中了默认安装在 higress-system 命名空间下的 higress-gateway 生效这份插件</li><li>pluginConfig：插件配置，最终会被转换成上面代码中的 MyConfig 对象</li><li>url：填写镜像地址，需要以&quot;oci://&quot;开头</li></ul><p>除了这些配置外，还可以定义插件的执行阶段和优先级等进阶配置，可以参考 Istio API 官方文档：<a href="https://istio.io/latest/docs/reference/config/proxy_extensions/wasm-plugin/" target="_blank" rel="noopener noreferrer">https://istio.io/latest/docs/reference/config/proxy_extensions/wasm-plugin/</a></p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># wasmplugin.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> extensions.higress.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WasmPlugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">defaultConfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">block_urls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;swagger.html&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> oci</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry.cn</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hangzhou.cr.aliyuncs.com/plugins/demo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">1.0.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过 kubectl 创建这个资源</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f wasmplugin.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试插件功能">测试插件功能<a href="#测试插件功能" class="hash-link" aria-label="测试插件功能的直接链接" title="测试插件功能的直接链接">​</a></h2><p>基于之前生效的 quickstart.yaml，目前集群中的 Ingress 访问拓扑如下所示：</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ing-topopng"><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN0178hYAV1sBTSczmfAf_!!6000000005728-2-tps-646-605.png" alt="ing-topo.png" class="img_ev3q"><a href="#ing-topopng" class="hash-link" aria-label="ing-topopng的直接链接" title="ing-topopng的直接链接">​</a></h3><p>未生效插件的情况下：</p><ul><li>请求<code>/foo</code> 将返回 HTTP 应答 <code>&quot;foo&quot;</code></li><li>请求<code>/bar</code> 将返回 HTTP 应答 <code>&quot;bar&quot;</code></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="全局生效">全局生效<a href="#全局生效" class="hash-link" aria-label="全局生效的直接链接" title="全局生效的直接链接">​</a></h3><p>基于上文生效插件阶段，下发的 wasmplugin.yaml，生效插件后效果如下：</p><ul><li>请求<code>/foo</code> 将返回 HTTP 应答 <code>&quot;hello higress&quot;</code></li><li>请求<code>/bar</code> 将返回 HTTP 应答 <code>&quot;hello higress&quot;</code></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="域名路由级生效">域名&amp;路由级生效<a href="#域名路由级生效" class="hash-link" aria-label="域名&amp;路由级生效的直接链接" title="域名&amp;路由级生效的直接链接">​</a></h3><p>将 wasmplugin.yaml 配置修改如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># wasmplugin.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> extensions.higress.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WasmPlugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">defaultConfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 跟上面例子一样，这个配置会全局生效，但如果被下面规则匹配到，则会改为执行命中规则的配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">block_urls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;swagger.html&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">matchRules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 路由级生效配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">ingress</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> default/foo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># default 命名空间下名为 foo 的 ingress 会执行下面这个配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">block_bodies</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">ingress</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> default/bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># default 命名空间下名为 bar 的 ingress 会执行下面这个配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">block_bodies</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bar&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 域名级生效配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*.example.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 若请求匹配了上面的域名, 会执行下面这个配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">block_bodies</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bar&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> oci</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry.cn</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hangzhou.cr.aliyuncs.com/plugins/demo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">1.0.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 pluginConfig 中增加了 <code>_rules_</code>  规则列表，规则中可以指定匹配方式，并填写对应生效的配置:</p><ul><li><em>match_route</em>：匹配 Ingress 生效，匹配格式为：Ingress 所在命名空间 + &quot;/&quot; + Ingress 名称</li><li><em>match_domain</em>：匹配域名生效，填写域名即可，支持通配符</li></ul><p>生效这份修改后的配置：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f wasmplugin.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到效果如下：</p><ul><li>请求<code>/foo</code> 将返回 HTTP 应答 <code>&quot;hello foo&quot;</code> (匹配到第一条 rule)</li><li>请求<code>/bar</code> 将返回 HTTP 应答 <code>&quot;hello bar&quot;</code> (匹配到第二条 rule)</li><li>请求<code>www.example.com</code> 将返回 HTTP 应答 <code>&quot;hello world&quot;</code> （匹配到第三条 rule）</li><li>请求<code>www.abc.com</code> 将返回 HTTP 应答 <code>&quot;hello higress&quot;</code> （没有匹配的 rule，使用全局配置）</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="插件生效原理">插件生效原理<a href="#插件生效原理" class="hash-link" aria-label="插件生效原理的直接链接" title="插件生效原理的直接链接">​</a></h2><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN01PO4HYC1h7qYHonHHZ_!!6000000004231-2-tps-1100-537.png" alt="wasm.png" class="img_ev3q"></p><p>这里对插件的生效机制简单做个说明：</p><ol><li>用户将代码编译成 wasm 文件</li><li>用户将 wasm 文件构建成 docker 镜像</li><li>用户将 docker 镜像推送至镜像仓库</li><li>用户创建 WasmPlugin 资源</li><li>Istio watch 到 WasmPlugin 资源的变化</li><li>Higress Gateway 中的 xDS proxy 进程从 Istio 获取到配置，发现插件的镜像地址</li><li>xDS proxy 从镜像仓库拉取镜像</li><li>xDS proxy 从镜像中提取出 wasm 文件</li><li>Higress Gateway 中的 envoy 进程从 xDS proxy 获取到配置，发现 wasm 文件的本地路径</li><li>envoy 从本地文件中加载 wasm 文件</li></ol><p>这里 envoy 获取配置并加载 wasm 文件使用到了 ECDS (Extension Config Discovery Service)的机制，实现了 wasm 文件更新，直接热加载，不会导致任何连接中断，业务流量完全无损。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三个革命性的特性">三个革命性的特性<a href="#三个革命性的特性" class="hash-link" aria-label="三个革命性的特性的直接链接" title="三个革命性的特性的直接链接">​</a></h2><p>上面的 Wasm 插件机制为网关自定义插件开发带来了三个革命性的特性。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="特性一插件生命周期和网关解耦">特性一：插件生命周期和网关解耦<a href="#特性一插件生命周期和网关解耦" class="hash-link" aria-label="特性一：插件生命周期和网关解耦的直接链接" title="特性一：插件生命周期和网关解耦的直接链接">​</a></h3><p>这个特性主要得益于 Istio 的 WasmPlugin 机制设计。可以和 K8s Nginx Ingress 的插件机制做个对比：</p><blockquote><p>reference: <a href="https://github.com/kubernetes/ingress-nginx/blob/main/rootfs/etc/nginx/lua/plugins/README.md" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/ingress-nginx/blob/main/rootfs/etc/nginx/lua/plugins/README.md</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="installing-a-plugin">Installing a plugin<a href="#installing-a-plugin" class="hash-link" aria-label="Installing a plugin的直接链接" title="Installing a plugin的直接链接">​</a></h3><p>There are two options:</p><ul><li>mount your plugin into /etc/nginx/lua/plugins/<your></your> in the ingress-nginx pod</li><li>build your own ingress-nginx image like it is done in the <a href="https://github.com/ElvinEfendi/ingress-nginx-openidc/tree/master/rootfs/etc/nginx/lua/plugins/openidc" target="_blank" rel="noopener noreferrer">example</a> and install your plugin during image build</li></ul></blockquote><p>可以看到 Nginx Ingress 加载自定义插件，需要将 lua 文件挂载进 pod，或者在构建镜像时装入。这样就将插件的生命周期跟网关绑定在一起，插件逻辑更新，需要发布新版本，网关也需要发布新版本或者重新部署。
使用 WasmPlugin 的机制，插件需要发布新版本，只需构建插件自身的镜像并进行下发生效，而且可以基于镜像的 tag 进行插件的版本管理。这样插件变更，不仅无需重新部署网关，结合 Envoy 的 ECDS 机制对流量也是完全无损。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="特性二高性能的多语言支持">特性二：高性能的多语言支持<a href="#特性二高性能的多语言支持" class="hash-link" aria-label="特性二：高性能的多语言支持的直接链接" title="特性二：高性能的多语言支持的直接链接">​</a></h3><p>基于 Wasm 的能力，可以用多种语言编写插件，对开发人员更加友好。实现多语言开发插件的另一种方式是基于 RPC 和网关进程通信的外置进程/服务插件，这种模式会有额外的 IO 开销，并且附加的进程/服务也带来额外的运维复杂度。目前大家对 Wasm 插件的性能比较关心，从我们的测试数据来看，指令执行性能相比原生的 C++ 语言确实有差距，但性能和 Lua 持平，且远好于外置插件。
对于一段逻辑：<code>循环执行20次请求头设置，循环执行20次请求头获取，循环执行20次请求头移除。</code>我们对比了分别用 Lua 和不同语言实现的 Wasm 的处理性能，下面是对单个请求延时的影响对比：</p><table><thead><tr><th><strong>实现语言</strong></th><th><strong>请求延时增加</strong></th></tr></thead><tbody><tr><td>Lua</td><td>0.20毫秒</td></tr><tr><td>Wasm (C++)</td><td>0.19毫秒</td></tr><tr><td>Wasm (Go)</td><td>0.20毫秒</td></tr><tr><td>Wasm (Rust)</td><td>0.21毫秒</td></tr><tr><td>Wasm (AssemblyScript)</td><td>0.21毫秒</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="特性三安全沙箱">特性三：安全沙箱<a href="#特性三安全沙箱" class="hash-link" aria-label="特性三：安全沙箱的直接链接" title="特性三：安全沙箱的直接链接">​</a></h3><p>Envoy 目前支持多种 Wasm 的运行时，例如 V8，WAMR，wasmtime 等等，这些运行时均提供了安全沙箱能力，即 Wasm 插件中出现了访问空指针、异常未捕获等逻辑，也不会令 Envoy 宿主进程 Crash。并且可以通过配置，在插件逻辑出现异常后进行 Fail Open 处理，跳过插件的执行逻辑，将对业务的影响降至最低。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="开源社区">开源社区<a href="#开源社区" class="hash-link" aria-label="开源社区的直接链接" title="开源社区的直接链接">​</a></h2><p>特别感谢 Istio/Envoy 社区的前置工作，让 Higress 可以实现对 Ingress 资源启用 WasmPlugin ，增强了 Ingress Controller 的自定义扩展能力。
特别感谢 Tetrate 社区实现的 proxy-wasm-go-sdk，Higress 在这个基础上封装了 wasm-go sdk，降低了开发插件的上手门槛。
Higress 对 Istio/Envoy 的 Wasm 能力做了一些 Bugfix 的工作，目前已经都合并进了上游社区。后续的一些 Feature 能力，也会持续反哺上游社区。
同时欢迎大家一起为 Higress 的插件以及其他社区生态添砖加瓦，为 Higress 贡献请参考文档：
<a href="https://higress.io/zh-cn/docs/developers/guide_dev.html" target="_blank" rel="noopener noreferrer">https://higress.io/zh-cn/docs/developers/guide_dev.html</a></p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col margin-top--sm"><a href="https://github.com/higress-group/higress-group.github.io/blob/main/i18n/zh-cn/docusaurus-plugin-content-blog/30-line-wasm.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh-cn/blog/nacos"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">Higress + Nacos 微服务网关最佳实践</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/blog/first-meetup"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">欢迎报名Higress首次线下Meetup</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#编写代码" class="table-of-contents__link toc-highlight">编写代码</a></li><li><a href="#生效插件" class="table-of-contents__link toc-highlight">生效插件</a><ul><li><a href="#编译" class="table-of-contents__link toc-highlight">编译</a></li><li><a href="#镜像推送" class="table-of-contents__link toc-highlight">镜像推送</a></li><li><a href="#下发配置" class="table-of-contents__link toc-highlight">下发配置</a></li></ul></li><li><a href="#测试插件功能" class="table-of-contents__link toc-highlight">测试插件功能</a><ul><li><a href="#ing-topopng" class="table-of-contents__link toc-highlight">ing-topo.png</a></li><li><a href="#全局生效" class="table-of-contents__link toc-highlight">全局生效</a></li><li><a href="#域名路由级生效" class="table-of-contents__link toc-highlight">域名&amp;路由级生效</a></li></ul></li><li><a href="#插件生效原理" class="table-of-contents__link toc-highlight">插件生效原理</a></li><li><a href="#三个革命性的特性" class="table-of-contents__link toc-highlight">三个革命性的特性</a><ul><li><a href="#特性一插件生命周期和网关解耦" class="table-of-contents__link toc-highlight">特性一：插件生命周期和网关解耦</a></li><li><a href="#特性二高性能的多语言支持" class="table-of-contents__link toc-highlight">特性二：高性能的多语言支持</a></li><li><a href="#特性三安全沙箱" class="table-of-contents__link toc-highlight">特性三：安全沙箱</a></li></ul></li><li><a href="#开源社区" class="table-of-contents__link toc-highlight">开源社区</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">愿景</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/">为用户提供一站式云原生网关解决方案.</a></li></ul></div><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/docs/overview/what-is-higress">Higress是什么?</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-cn/docs/user/quickstart">快速开始</a></li><li class="footer__item"><a href="https://github.com/higress-group/higress-group.github.io/issues/new" target="_blank" rel="noopener noreferrer" class="footer__link-item">报告文档问题<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/higress-group/higress-group.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">在GitHub上编辑此文档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">资源</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/blog">博客</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-cn/community">社区</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="//img.alicdn.com/imgextra/i2/O1CN01oNTGgE1lfW7oEPIzP_!!6000000004846-2-tps-960-290.png" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="120" height="36"><img src="//img.alicdn.com/imgextra/i2/O1CN01oNTGgE1lfW7oEPIzP_!!6000000004846-2-tps-960-290.png" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="120" height="36"></div><div class="footer__copyright">Copyright © 2023 Higress<br>浙公网安备 33011002016922号 浙ICP备12022327号-1119</div></div></div></footer></div>
<script src="/zh-cn/assets/js/runtime~main.b4f096e2.js"></script>
<script src="/zh-cn/assets/js/main.2c422536.js"></script>
</body>
</html>