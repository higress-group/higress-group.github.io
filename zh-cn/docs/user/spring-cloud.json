{
  "filename": "spring-cloud.md",
  "__html": "<h1>实现 SpringCloud 服务发现和路由</h1>\n<h2>使用 Nacos 做注册中心</h2>\n<p>应用配置具体参考<a href=\"https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html\">Nacos Spring Cloud 快速开始</a>进行应用配置</p>\n<h3>不指定命名空间</h3>\n<p>如果 <code>application.properties</code> 中没有指定 Nacos 命名空间，例如：</p>\n<pre><code class=\"language-text\">server.port=8080\nspring.application.name=my-service\n\nspring.cloud.nacos.discovery.server-addr=127.0.0.1:8848\n</code></pre>\n<p>则 Higress 的 <a href=\"./mcp-bridge.md\">McpBridge</a> 中亦无需指定命名空间：</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">networking.higress.io/v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">McpBridge</span>\n<span class=\"hljs-attr\">metadata:</span>\n<span class=\"hljs-attr\">  name:</span> <span class=\"hljs-string\">default</span>\n<span class=\"hljs-attr\">  namespace:</span> <span class=\"hljs-string\">higress-system</span>\n<span class=\"hljs-attr\">spec:</span>\n<span class=\"hljs-attr\">  registries:</span>\n    <span class=\"hljs-comment\"># 定义一个名为 my-nacos  的服务来源</span>\n<span class=\"hljs-attr\">  - name:</span> <span class=\"hljs-string\">my-nacos</span>\n    <span class=\"hljs-comment\"># 注册中心类型是 Nacos 2.x，支持 gRPC 协议</span>\n<span class=\"hljs-attr\">    type:</span> <span class=\"hljs-string\">nacos2</span>\n    <span class=\"hljs-comment\"># 注册中心的访问地址，可以是域名或者IP</span>\n<span class=\"hljs-attr\">    domain:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>\n    <span class=\"hljs-comment\"># 注册中心的访问端口，Nacos 默认都是 8848</span>\n<span class=\"hljs-attr\">    port:</span> <span class=\"hljs-number\">8848</span>\n    <span class=\"hljs-comment\"># Nacos 服务分组</span>\n<span class=\"hljs-attr\">    nacosGroups:</span>\n<span class=\"hljs-bullet\">    -</span> <span class=\"hljs-string\">DEFAULT_GROUP</span>\n</code></pre>\n<p>配置 Ingress 转发到这个服务(假设/api前缀的路由都转发给这个服务)需要做如下配置：</p>\n<pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    higress.io/destination: my-service.DEFAULT-GROUP.public.nacos\n  name: demo\n  namespace: default\nspec:\n  rules:\n  - http:\n      paths:\n      - backend:\n          resource:\n            apiGroup: networking.higress.io\n            kind: McpBridge\n            name: default\n        path: /api\n        pathType: Prefix\n</code></pre>\n<p>注意这里通过注解<code>higress.io/destination</code>指定路由最终要转发到的目标服务。</p>\n<p>对于 Nacos 来源的服务，这里的目标服务格式为：“服务名称.服务分组.命名空间ID.nacos”，注意这里需要遵循 DNS 域名格式，因此服务分组中的下划线'_'被转换成了横杠'-'。命名空间未指定时，这里默认值为&quot;public&quot;。</p>\n<h3>指定命名空间、服务分组等信息</h3>\n<p>如果 <code>application.properties</code> 中指定了 Nacos 命名空间，服务分组等信息，例如：</p>\n<pre><code class=\"language-text\">server.port=8080\nspring.application.name=my-service\n\nspring.cloud.nacos.discovery.server-addr=127.0.0.1:8848\nspring.cloud.nacos.discovery.namespace=d8ac64f3-xxxx-xxxx-xxxx-47a814ecf358\nspring.cloud.nacos.discovery.group=custom-group\n</code></pre>\n<p>则 Higress 的 McpBridge 做相应配置即可</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">networking.higress.io/v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">McpBridge</span>\n<span class=\"hljs-attr\">metadata:</span>\n<span class=\"hljs-attr\">  name:</span> <span class=\"hljs-string\">default</span>\n<span class=\"hljs-attr\">  namespace:</span> <span class=\"hljs-string\">higress-system</span>\n<span class=\"hljs-attr\">spec:</span>\n<span class=\"hljs-attr\">  registries:</span>\n    <span class=\"hljs-comment\"># 定义一个名为 my-nacos  的服务来源</span>\n<span class=\"hljs-attr\">  - name:</span> <span class=\"hljs-string\">my-nacos</span>\n    <span class=\"hljs-comment\"># 注册中心类型是 Nacos 2.x，支持 gRPC 协议</span>\n<span class=\"hljs-attr\">    type:</span> <span class=\"hljs-string\">nacos2</span>\n    <span class=\"hljs-comment\"># 注册中心的访问地址，可以是域名或者IP</span>\n<span class=\"hljs-attr\">    domain:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>\n    <span class=\"hljs-comment\"># 注册中心的访问端口，Nacos 默认都是 8848</span>\n<span class=\"hljs-attr\">    port:</span> <span class=\"hljs-number\">8848</span>\n    <span class=\"hljs-comment\"># Nacos 命名空间 ID</span>\n<span class=\"hljs-attr\">    nacosNamespaceId:</span> <span class=\"hljs-string\">d8ac64f3-xxxx-xxxx-xxxx-47a814ecf358</span>\n    <span class=\"hljs-comment\"># Nacos 服务分组</span>\n<span class=\"hljs-attr\">    nacosGroups:</span>\n<span class=\"hljs-bullet\">    -</span> <span class=\"hljs-string\">custom-group</span>\n</code></pre>\n<p>配置 Ingress 转发到这个服务(假设/api前缀的路由都转发给这个服务)需要做如下配置：</p>\n<pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    higress.io/destination: my-service.custom-group.d8ac64f3-xxxx-xxxx-xxxx-47a814ecf358.nacos\n  name: demo\n  namespace: default\nspec:\n  rules:\n  - http:\n      paths:\n      - backend:\n          resource:\n            apiGroup: networking.higress.io\n            kind: McpBridge\n            name: default\n        path: /api\n        pathType: Prefix\n</code></pre>\n<h2>使用 ZooKeeper 做注册中心</h2>\n<p>使用 Zookeeper 做注册中心时，注意必须配置<code>spring.cloud.zookeeper.discovery.preferIpAddress=true</code>，否则注册到注册中心中到地址为主机名称，而不是IP。</p>\n<h3>不指定注册根路径</h3>\n<p>如果 <code>application.properties</code> 中未指定注册根路径信息，例如：</p>\n<pre><code class=\"language-text\">spring.application.name=my-service\nspring.cloud.zookeeper.connect-string=127.0.0.1:2181\nspring.cloud.zookeeper.discovery.preferIpAddress=true\nspring.cloud.zookeeper.discovery.enabled=true\nspring.cloud.zookeeper.discovery.register=true\n</code></pre>\n<p>则 Higress 的 <a href=\"./mcp-bridge.md\">McpBridge</a> 中亦无需指定zkServicePath：</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">networking.higress.io/v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">McpBridge</span>\n<span class=\"hljs-attr\">metadata:</span>\n<span class=\"hljs-attr\">  name:</span> <span class=\"hljs-string\">default</span>\n<span class=\"hljs-attr\">  namespace:</span> <span class=\"hljs-string\">higress-system</span>\n<span class=\"hljs-attr\">spec:</span>\n<span class=\"hljs-attr\">  registries:</span>\n    <span class=\"hljs-comment\"># 定义一个名为 my-zk  的服务来源</span>\n<span class=\"hljs-attr\">  - name:</span> <span class=\"hljs-string\">my-zk</span>\n    <span class=\"hljs-comment\"># 注册中心类型是 ZooKeeper</span>\n<span class=\"hljs-attr\">    type:</span> <span class=\"hljs-string\">zookeeper</span>\n    <span class=\"hljs-comment\"># 注册中心的访问地址，可以是域名或者IP</span>\n<span class=\"hljs-attr\">    domain:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>\n    <span class=\"hljs-comment\"># 注册中心的访问端口</span>\n<span class=\"hljs-attr\">    port:</span> <span class=\"hljs-number\">2181</span>\n</code></pre>\n<p>配置 Ingress 转发到这个服务(假设/api前缀的路由都转发给这个服务)需要做如下配置：</p>\n<pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    higress.io/destination: my-service.services.zookeeper\n  name: demo\n  namespace: default\nspec:\n  rules:\n  - http:\n      paths:\n      - backend:\n          resource:\n            apiGroup: networking.higress.io\n            kind: McpBridge\n            name: default\n        path: /api\n        pathType: Prefix\n</code></pre>\n<p>注意对于 ZooKeeper 来源的服务，这里的目标服务格式为：&quot;服务名称.服务注册根路径.zookeeper&quot;，SpringCloud 在未指定服务注册根路径的情况下，根路径默认是&quot;services&quot;</p>\n<h3>指定注册根路径</h3>\n<p>如果 <code>application.properties</code> 中指定了注册根路径信息，例如：</p>\n<pre><code class=\"language-text\">spring.application.name=my-service\nspring.cloud.zookeeper.connect-string=127.0.0.1:2181\nspring.cloud.zookeeper.discovery.preferIpAddress=true\nspring.cloud.zookeeper.discovery.enabled=true\nspring.cloud.zookeeper.discovery.register=true\nspring.cloud.zookeeper.discovery.root=my-services-root\n</code></pre>\n<p>则 Higress 的 <a href=\"./mcp-bridge.md\">McpBridge</a> 中亦需指定zkServicePath：</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">networking.higress.io/v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">McpBridge</span>\n<span class=\"hljs-attr\">metadata:</span>\n<span class=\"hljs-attr\">  name:</span> <span class=\"hljs-string\">default</span>\n<span class=\"hljs-attr\">  namespace:</span> <span class=\"hljs-string\">higress-system</span>\n<span class=\"hljs-attr\">spec:</span>\n<span class=\"hljs-attr\">  registries:</span>\n    <span class=\"hljs-comment\"># 定义一个名为 my-zk  的服务来源</span>\n<span class=\"hljs-attr\">  - name:</span> <span class=\"hljs-string\">my-zk</span>\n    <span class=\"hljs-comment\"># 注册中心类型是 ZooKeeper</span>\n<span class=\"hljs-attr\">    type:</span> <span class=\"hljs-string\">zookeeper</span>\n    <span class=\"hljs-comment\"># 注册中心的访问地址，可以是域名或者IP</span>\n<span class=\"hljs-attr\">    domain:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>\n    <span class=\"hljs-comment\"># 注册中心的访问端口</span>\n<span class=\"hljs-attr\">    port:</span> <span class=\"hljs-number\">2181</span>\n    <span class=\"hljs-comment\"># 对应 spring.cloud.zookeeper.discovery.root 配置字段</span>\n<span class=\"hljs-attr\">    zkServicePath:</span>\n<span class=\"hljs-bullet\">    -</span> <span class=\"hljs-string\">my-services-root</span>\n</code></pre>\n<p>配置 Ingress 转发到这个服务(假设/api前缀的路由都转发给这个服务)需要做如下配置：</p>\n<pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    higress.io/destination: my-service.my-services-root.zookeeper\n  name: demo\n  namespace: default\nspec:\n  rules:\n  - http:\n      paths:\n      - backend:\n          resource:\n            apiGroup: networking.higress.io\n            kind: McpBridge\n            name: default\n        path: /api\n        pathType: Prefix\n</code></pre>\n<p>注意如果 spring.cloud.zookeeper.discovery.root 中包含了下划线，需要被替换为横杠，因为目标服务整体格式需要满足 DNS 域名规范</p>\n",
  "link": "/zh-cn/docs/user/spring-cloud.html",
  "meta": {
    "title": "实现 SpringCloud 服务发现和路由",
    "keywords": "SpringCloud,discovery",
    "description": "实现 SpringCloud 服务发现和路由."
  }
}