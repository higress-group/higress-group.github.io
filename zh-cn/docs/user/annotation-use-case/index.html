<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-user/annotation-use-case">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">通过Ingress Annotation实现高阶流量治理 | Higress</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://higress.io/zh-cn/img/higress_logo_small.png"><meta data-rh="true" name="twitter:image" content="https://higress.io/zh-cn/img/higress_logo_small.png"><meta data-rh="true" property="og:url" content="https://higress.io/zh-cn/docs/user/annotation-use-case"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="通过Ingress Annotation实现高阶流量治理 | Higress"><meta data-rh="true" name="description" content="在Higress上使用Ingress并借助Annotation实现高阶流量治理。"><meta data-rh="true" property="og:description" content="在Higress上使用Ingress并借助Annotation实现高阶流量治理。"><meta data-rh="true" name="keywords" content="Ingress Annotation"><link data-rh="true" rel="icon" href="/zh-cn/img/higress_logo_small.png"><link data-rh="true" rel="canonical" href="https://higress.io/zh-cn/docs/user/annotation-use-case"><link data-rh="true" rel="alternate" href="https://higress.io/en-us/docs/user/annotation-use-case" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://higress.io/zh-cn/docs/user/annotation-use-case" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://higress.io/docs/user/annotation-use-case" hreflang="default"><link data-rh="true" rel="alternate" href="https://higress.io/docs/user/annotation-use-case" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Higress RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Higress Atom Feed">




<link rel="stylesheet" href="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.js"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-YHS75WKFBR" async></script><link rel="stylesheet" href="/zh-cn/assets/css/styles.43bb74b6.css">
<link rel="preload" href="/zh-cn/assets/js/runtime~main.41931863.js" as="script">
<link rel="preload" href="/zh-cn/assets/js/main.5b8e82fe.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="//img.alicdn.com/imgextra/i1/O1CN01I7WjVs1K33EQjInid_!!6000000001107-2-tps-960-290.png" alt="Higress logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="//img.alicdn.com/imgextra/i1/O1CN01I7WjVs1K33EQjInid_!!6000000001107-2-tps-960-290.png" alt="Higress logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/docs/overview/what-is-higress">文档</a><a class="navbar__item navbar__link" href="/zh-cn/docs/developers/developers_dev">开发者</a><a class="navbar__item navbar__link" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a href="https://github.com/alibaba/higress/releases" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">下载</a><a href="http://demo.higress.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">控制台样例</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/en-us/docs/user/annotation-use-case" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/docs/user/annotation-use-case" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">概述</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/overview/what-is-higress">Higress是什么</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/overview/roadmap">Roadmap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/overview/faq">FAQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/overview/terminology">术语表</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">用户指南</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/user/quickstart">快速开始</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/zh-cn/docs/user/annotation">参考手册</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/user/annotation">Ingress Annotation 配置说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/zh-cn/docs/user/annotation-use-case">通过Ingress Annotation实现高阶流量治理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/user/configurations">运维参数配置说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/user/mcp-bridge">Mcp Bridge 配置说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/user/dubbo-envoyfilter">HTTP转Dubbo 配置说明</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/zh-cn/docs/plugins/intro">插件使用文档</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/zh-cn/docs/user/wasm-go">最佳实践示例</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">运维指南</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/ops/deploy-by-helm">安装部署</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/ops/upgrade">版本升级</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/ops/log">日志说明</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">开发者指南</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/dev/code">源码阅读指引</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/dev/architecture">组件编译说明</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/zh-cn/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">用户指南</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">参考手册</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">通过Ingress Annotation实现高阶流量治理</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>通过Ingress Annotation实现高阶流量治理</h1></header><p>本篇文档介绍如何在Higress上使用Ingress并借助Annotation实现高阶流量治理。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前提条件">前提条件<a href="#前提条件" class="hash-link" aria-label="前提条件的直接链接" title="前提条件的直接链接">​</a></h2><ul><li><a href="/zh-cn/docs/user/quickstart">安装Higress</a></li><li>已拥有一个Kubernetes集群，且配置了kubectl命令行工具</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="灰度发布">灰度发布<a href="#灰度发布" class="hash-link" aria-label="灰度发布的直接链接" title="灰度发布的直接链接">​</a></h2><p>Higress提供复杂的路由处理能力，支持基于Header、Cookie以及权重的灰度发布功能。灰度发布功能可以通过设置注解来实现，为了启用灰度发布功能，需要设置注解<code>higress.io/canary: &quot;true&quot;</code>。通过不同注解可以实现不同的灰度发布功能。</p><blockquote><p>说明：当多种方式同时配置时，灰度方式选择优先级为：基于Header &gt; 基于Cookie &gt; 基于权重（从高到低）。</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基于header灰度发布">基于Header灰度发布<a href="#基于header灰度发布" class="hash-link" aria-label="基于Header灰度发布的直接链接" title="基于Header灰度发布的直接链接">​</a></h3><ul><li>只配置<code>higress.io/canary-by-header</code>：基于Request Header的名称进行流量切分。当请求包含该Header并其值为always时，请求流量会被分配到灰度服务入口；其他情况时，请求流量不会分配到灰度服务。</li><li>同时配置<code>higress.io/canary-by-header</code>和<code>higress.io/canary-by-header-value</code>：基于Request Header的名称和值进行流量切分。当请求中的header的名称和header的值与该配置匹配时，请求流量会被分配到灰度服务；其他情况时，请求流量不会分配到灰度服务。<blockquote><p>Higress灰度发布时支持多个版本服务（无上限）。</p></blockquote></li></ul><ol><li>请求Header为<code>higress：always</code>时将访问灰度服务demo-service-canary；其他情况将访问正式服务demo-service，配置如下：</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary-by-header: &quot;higress&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo-canary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service-canary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact   </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>请求Header为<code>higress：v1</code>时将访问灰度服务demo-service-canary-v1；请求Header为<code>higress：v2</code>时将访问灰度服务demo-service-canary-v2；其他情况将访问正式服务demo-service，配置如下：</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary-by-header: &quot;higress&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary-by-header-value: &quot;v1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo-canary-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service-canary-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary-by-header: &quot;higress&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary-by-header-value: &quot;v2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo-canary-v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service-canary-v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基于cookie灰度发布">基于Cookie灰度发布<a href="#基于cookie灰度发布" class="hash-link" aria-label="基于Cookie灰度发布的直接链接" title="基于Cookie灰度发布的直接链接">​</a></h3><ul><li>higress.io/canary-by-cookie：基于Cookie的Key进行流量切分。当请求的Cookie中含有该Key且其值为always时，请求流量将被分配到灰度服务；其他情况时，请求流量将不会分配到灰度服务。<blockquote><p>说明：基于Cookie的灰度发布不支持自定义设置Key对应的值，只能是always。</p></blockquote></li></ul><p>请求的Cookie为<code>demo=always</code>时将访问灰度服务demo-service-canary；其他情况将访问正式服务demo-service。配置如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary-by-cookie: &quot;demo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo-canary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service-canary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基于权重灰度发布">基于权重灰度发布<a href="#基于权重灰度发布" class="hash-link" aria-label="基于权重灰度发布的直接链接" title="基于权重灰度发布的直接链接">​</a></h3><ul><li>higress.io/canary-weight：设置请求到指定服务的百分比（值为0~100的整数）</li><li>higress.io/canary-weight-totatl：设置权重总和，默认为100</li></ul><p>配置灰度服务demo-service-canary-v1的权重为30%，配置灰度服务demo-service-canary-v2的权重为20%，配置正式服务demo-service的权重为50%。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary-by-weight: &quot;30&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo-canary-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service-canary-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary-by-weight: &quot;20&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo-canary-v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service-canary-v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="跨域">跨域<a href="#跨域" class="hash-link" aria-label="跨域的直接链接" title="跨域的直接链接">​</a></h2><p>跨域资源共享CORS（Cross-Origin Resource Sharing）是指允许Web应用服务器进行跨域访问控制，从而实现跨域数据安全传输。</p><ul><li>higress.io/enable-cors：&quot;true&quot; or &quot;false&quot;。开启或关闭跨域。</li><li>higress.io/cors-allow-origin：允许的第三方站点，支持泛域名，逗号分隔；支持通配符<em>。默认值为</em>，即允许所有第三方站点。</li><li>higress.io/cors-allow-methods：允许的请求方法，如GET、POST，逗号分隔；支持通配符*。默认值为GET, PUT, POST, DELETE, PATCH, OPTIONS。</li><li>higress.io/cors-allow-headers：允许的请求头部，逗号分隔；支持通配符*。默认值为DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization。</li><li>higress.io/cors-expose-headers：允许的响应头部，逗号分隔。</li><li>higress.io/cors-allow-credentials：&quot;true&quot; or &quot;false&quot;。是否允许携带凭证信息。默认允许。</li><li>higress.io/cors-max-age：预检结果的最大缓存时间，单位为秒；默认值为1728000。</li></ul><p>跨域请求被限制为只能来自example.com域的请求，并且HTTP方法只能是GET和POST，允许的请求头部为X-Foo-Bar，不允许携带凭证信息。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/enable-cors: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/cors-allow-origin: &quot;example.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/cors-allow-methods: &quot;GET,POST&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/cors-allow-headers: &quot;X-Foo-Bar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/cors-allow-credentials: &quot;false&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rewrite重写path和host">Rewrite重写Path和Host<a href="#rewrite重写path和host" class="hash-link" aria-label="Rewrite重写Path和Host的直接链接" title="Rewrite重写Path和Host的直接链接">​</a></h2><p>在请求转发给目标后端服务之前，重写可以修改原始请求的路径（Path）和主机域（Host)。</p><ul><li>higress.io/rewrite-target：重写Path，支持捕获组（Capture Group)。</li><li>higress.io/upstream-vhost：重写Host。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rewrite重写path">Rewrite重写Path<a href="#rewrite重写path" class="hash-link" aria-label="Rewrite重写Path的直接链接" title="Rewrite重写Path的直接链接">​</a></h3><ol><li>将请求<code>example.com/test</code>在转发至后端服务之前，重写为<code>example.com/dev</code></li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/rewrite-target: &quot;/dev&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>将请求<code>example.com/v1/app</code>在转发至后端服务之前，去掉Path前缀/v1</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/rewrite-target: &quot;/$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /v1/(app)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Prefix</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>将请求<code>example.com/v1/app</code>在转发至后端服务之前，将Path前缀/v1更改为/v2</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/rewrite-target: &quot;/v2/$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /v1/(app)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Prefix</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rewrite重写host">Rewrite重写Host<a href="#rewrite重写host" class="hash-link" aria-label="Rewrite重写Host的直接链接" title="Rewrite重写Host的直接链接">​</a></h3><p>将请求<code>example.com/test</code>在转发至后端服务之前，重写为<code>test.com/test</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/upstream-vhost: &quot;test.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="重定向">重定向<a href="#重定向" class="hash-link" aria-label="重定向的直接链接" title="重定向的直接链接">​</a></h2><p>通过重定向可以将原始客户端请求更改为目标请求。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置http重定向至https">配置HTTP重定向至HTTPS<a href="#配置http重定向至https" class="hash-link" aria-label="配置HTTP重定向至HTTPS的直接链接" title="配置HTTP重定向至HTTPS的直接链接">​</a></h3><ul><li>higress.io/ssl-redirect：HTTP重定向到HTTPS</li><li>higress.io/force-ssl-redirect: HTTP重定向到HTTPS<blockquote><p>说明：Higress对于以上两个注解不区分对待，都是强制将HTTP重定向到HTTPS。</p></blockquote></li></ul><p>将请求<code>http://example.com/test</code>重定向为<code>https://example.com/test</code>。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/ssl-redirect: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="永久重定向">永久重定向<a href="#永久重定向" class="hash-link" aria-label="永久重定向的直接链接" title="永久重定向的直接链接">​</a></h3><ul><li>higress.io/permanent-redirect：永久重定向的目标url，必须包含scheme（http or https)。</li><li>higress.io/permanent-redirect-code：永久重定向的HTTP状态码，默认为301。</li></ul><p>将请求<code>http://example.com/test</code>永久重定向为<code>http://example.com/app</code>。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/permanent-redirect: &quot;http://example.com/app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="临时重定向">临时重定向<a href="#临时重定向" class="hash-link" aria-label="临时重定向的直接链接" title="临时重定向的直接链接">​</a></h3><ul><li>higress.io/temporal-redirect：临时重定向的目标url，必须包含scheme（http or https)。</li></ul><p>将请求<code>http://example.com/test</code>临时重定向为<code>http://example.com/app</code>。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/temporal-redirect: &quot;http://example.com/app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="header控制">Header控制<a href="#header控制" class="hash-link" aria-label="Header控制的直接链接" title="Header控制的直接链接">​</a></h2><p>通过Header控制，您可以在转发请求到后端服务之前对请求Header进行增删改，在收到响应转发给客户端时对响应Header进行增删改。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="请求header控制">请求Header控制<a href="#请求header控制" class="hash-link" aria-label="请求Header控制的直接链接" title="请求Header控制的直接链接">​</a></h3><ul><li>higress.ingress.kubernetes.io/request-header-control-add：请求在转发给后端服务时，添加指定Header。若该Header存在，则其值拼接在原有值后面。语法如下：<ul><li>单个Header：Key Value</li><li>多个Header：使用yaml特殊符号 |，每对Key Value单独处于一行</li></ul></li><li>higress.ingress.kubernetes.io/request-header-control-update：请求在转发给后端服务时，修改指定Header。若该header存在，则其值覆盖原有值。语法如下：<ul><li>单个Header：Key Value</li><li>多个Header：使用yaml特殊符号 |，每对Key Value单独处于一行</li></ul></li><li>higress.ingress.kubernetes.io/request-header-control-remove：请求在转发给后端服务时，删除指定Header。语法如下：<ul><li>单个Header：Key</li><li>多个Header：逗号分隔</li></ul></li></ul><ol><li>对于请求<code>example.com/test</code>添加两个Header，<code>foo: bar</code>和<code>test: true</code>。</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.ingress.kubernetes.io/request-header-control-add: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      foo bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      test true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>Header控制可以结合灰度发布，对灰度流量进行染色。请求Header为<code>higress：v1</code>时将访问灰度服务demo-service-canary-v1，并添加Header，<code>stage: gray</code>；其他情况将访问正式服务demo-service，并添加Header，<code>stage: production</code>。配置如下：</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary-by-header: &quot;higress&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/canary-by-header-value: &quot;v1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.ingress.kubernetes.io/request-header-control-add: &quot;stage gray&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo-canary-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service-canary-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.ingress.kubernetes.io/request-header-control-add: &quot;stage production&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="响应header控制">响应Header控制<a href="#响应header控制" class="hash-link" aria-label="响应Header控制的直接链接" title="响应Header控制的直接链接">​</a></h3><ul><li>higress.ingress.kubernetes.io/response-header-control-add：请求在收到后端服务响应之后并且转发响应给客户端之前，添加指定Header。若该Header存在，则其值拼接在原有值后面。语法如下：<ul><li>单个Header：Key Value</li><li>多个Header：使用yaml特殊符号 |，每对Key Value单独处于一行</li></ul></li><li>higress.ingress.kubernetes.io/response-header-control-update：请求在收到后端服务响应之后并且转发响应给客户端之前，修改指定Header。若该header存在，则其值覆盖原有值。语法如下：<ul><li>单个Header：Key Value</li><li>多个Header：使用yaml特殊符号 |，每对Key Value单独处于一行</li></ul></li><li>higress.ingress.kubernetes.io/response-header-control-remove：请求在收到后端服务响应之后并且转发响应给客户端之前，删除指定Header。语法如下：<ul><li>单个Header：Key</li><li>多个Header：逗号分隔</li></ul></li></ul><p>对于请求<code>example.com/test</code>的响应删除<code>Header：req-cost-time</code>。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.ingress.kubernetes.io/response-header-control-remove: &quot;req-cost-time&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="重试">重试<a href="#重试" class="hash-link" aria-label="重试的直接链接" title="重试的直接链接">​</a></h2><p>Higress提供路由级别的重试设置，可以为出错的请求调用自动进行重试。您可以按需设置重试条件，例如建立连接失败，或者后端服务不可用以及对指定HTTP状态码的响应等进行请求重试。</p><ul><li>higress.io/proxy-next-upstream-tries：请求的最大重试次数。默认3次。</li><li>higress.io/proxy-next-upstream-timeout：请求重试的超时时间，单位秒。默认未配置超时时间。</li><li>higress.io/proxy-next-upstream：请求重试条件，逗号分隔；默认值为&quot;error,timeout&quot;。合法值如下：<ul><li>error：建立连接失败，请求出错5xx。</li><li>timeout：建立连接超时，请求出错5xx。</li><li>invalid_header：请求出错5xx。</li><li>http_xxx：针对具体响应状态码的情况进行重试。例如http_502，http_403。</li><li>non_idempotent：对于非幂等请求出错时进行重试。默认情况下，Higress针对非幂等POST、PATCH请求出错时不会进行重试，配置non_idempotent可以开启重试。</li><li>off：关闭重试。</li></ul></li></ul><p>设置<code>example/test</code>请求的最大重试次数为2，重试超时时间为5s，只有在响应状态码为502才重试，并且开启非幂等重试。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/proxy-next-upstream-tries: &quot;2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/proxy-next-upstream-timeout: &quot;5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/proxy-next-upstream: &quot;http_502,non_idempotent&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置后端服务协议https或grpc">配置后端服务协议：HTTPS或GRPC<a href="#配置后端服务协议https或grpc" class="hash-link" aria-label="配置后端服务协议：HTTPS或GRPC的直接链接" title="配置后端服务协议：HTTPS或GRPC的直接链接">​</a></h2><p>Higress默认使用HTTP协议转发请求到后端业务容器。当您的业务容器为HTTPS协议时，可以通过使用注解<code>higress.io/backend-protocol: &quot;HTTPS&quot;</code>；当您的业务容器为GRPC服务时，可以通过使用注解<code>higress.io/backend-protocol: &quot;GRPC&quot;</code>。</p><blockquote><p>说明：相比Nginx Ingress的优势，如果您的后端服务所属的K8s Service资源中关于Port Name的定义为grpc或http2，您无需配置注解higress.io/backend-protocol: &quot;GRPC&quot;，Higress会自动使用GRPC或者HTTP2。</p></blockquote><ol><li>请求<code>example/test</code>转发至后端服务使用HTTPS协议。</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/backend-protocol: &quot;HTTPS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>请求<code>example/test</code>转发至后端服务使用GRPC协议。
第一种做法：通过注解。</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/backend-protocol: &quot;GRPC&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第二种做法：通过Service Port Name</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: grpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: demo-service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置后端服务的负载均衡算法">配置后端服务的负载均衡算法<a href="#配置后端服务的负载均衡算法" class="hash-link" aria-label="配置后端服务的负载均衡算法的直接链接" title="配置后端服务的负载均衡算法的直接链接">​</a></h2><p>负载均衡决定着网关在转发请求至后端服务时如何选择节点。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="普通负载均衡算法">普通负载均衡算法<a href="#普通负载均衡算法" class="hash-link" aria-label="普通负载均衡算法的直接链接" title="普通负载均衡算法的直接链接">​</a></h3><ul><li>higress.io/load-balance：后端服务的普通负载均衡算法。默认为round_robin。合法值如下：<ul><li>round_robin：基于轮询的负载均衡。</li><li>least_conn：基于最小请求数的负载均衡。</li><li>random：基于随机的负载均衡。</li></ul></li></ul><p>设置后端服务demo-service的负载均衡算法为least_conn。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/load-balance: &quot;least_conn&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基于一致性hash的负载均衡算法">基于一致性Hash的负载均衡算法<a href="#基于一致性hash的负载均衡算法" class="hash-link" aria-label="基于一致性Hash的负载均衡算法的直接链接" title="基于一致性Hash的负载均衡算法的直接链接">​</a></h3><p>基于一致性Hash的负载均衡算法具备请求亲和性，具有相同特征的请求会始终负载到相同节点上。Higress支持基于部分Nginx 变量、请求Header和请求路径参数作为Hash Key。</p><ul><li>higress.io/upstream-hash-by：基于一致Hash的负载均衡算法。Higress支持以下几种形式：<ul><li>支持配置部分nginx变量：<ul><li>$request_uri：请求的Path（包括路径参数）作为Hash Key</li><li>$host：请求的Host作为Hash Key</li><li>$remote_addr：请求的客户端IP作为Hash Key</li></ul></li><li>基于请求header的一致性Hash。您只需配置为$http_headerName。</li><li>基于请求路径参数的一致性Hash。您只需配置为$arg_varName。</li></ul></li></ul><ol><li>基于请求的客户端IP作为Hash Key，同一个客户端IP的请求始终负载到同一个节点。</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/upstream-hash-by: &quot;$remote_addr&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>基于请求Header x-stage作为Hash key，带有x-stage头部的请求且值相同的请求始终负载到同一个节点。</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/upstream-hash-by: &quot;$http_x-stage&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>基于请求路径参数 x-stage作为Hash key，带有路径参数x-stage的请求且值相同的请求始终负载到同一个节点。</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/upstream-hash-by: &quot;$arg_x-stage&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cookie亲和性-会话保持">Cookie亲和性 （会话保持）<a href="#cookie亲和性-会话保持" class="hash-link" aria-label="Cookie亲和性 （会话保持）的直接链接" title="Cookie亲和性 （会话保持）的直接链接">​</a></h2><p>具备相同的Cookie的请求会被网关始终负载到同一个节点，并且如果第一次访问携带Cookie，Higress会在第一次响应时为客户端生成一个Cookie，用来保证后续的请求被网关始终负载到相同节点。</p><ul><li>higress.io/affinity：亲和性种类，目前只支持cookie，默认为cookie。</li><li>higress.io/affinity-mode：亲和性模式，Higress目前只支持balanced模式，默认为balanced模式。</li><li>higress.io/session-cookie-name：配置指定Cookie的值作为Hash Key，默认为INGRESSCOOKIE</li><li>higress.io/session-cookie-path：当指定Cookie不存在，生成的Cookie的Path值，默认为/</li><li>higress.io/session-cookie-max-age：当指定Cookie不存在，生成的Cookie的过期时间，单位为秒，默认为Session会话级别。</li><li>higress.io/session-cookie-expires：当指定Cookie不存在，生成的Cookie的过期时间，单位为秒，默认为Session会话级别。<blockquote><p>说明：max-age和expires都可以用来指定cookie过期时间。当session-cookie-max-age和session-cookie-expires同时配置时，Higress优先选取session-cookie-max-age作为过期时间。</p></blockquote></li></ul><ol><li>开启Cookie亲和性，利用Higress的默认配置，即Cookie的名字为INGRESSCOOKIE，Path为/，Cookie的生命周期为Session会话级别。</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/affinity: &quot;cookie&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>开启Cookie亲和性，Cookie的名字为test，Path为/，Cookie的过期时间为10s。</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/affinity: &quot;cookie&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/session-cookie-name: &quot;test&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/session-cookie-max-age: &quot;10&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="网关与后端服务双向认证mtls">网关与后端服务双向认证（MTLS)<a href="#网关与后端服务双向认证mtls" class="hash-link" aria-label="网关与后端服务双向认证（MTLS)的直接链接" title="网关与后端服务双向认证（MTLS)的直接链接">​</a></h2><p>默认情况下，Higress默认使用HTTP协议转发请求到后端业务容器。你可以通过使用注解<code>higress.io/backend-protocol: &quot;HTTPS&quot;</code>配置Higress访问后端服务使用HTTPS协议，但这是单向TLS，也就是说只有Higress会验证后端服务提供的证书，且一般后端服务使用的证书需要是权威CA签发的。另一种更安全的模式是零信任，网关会验证后端服务的证书是否合法，同样后端服务也会验证网关提供的证书是否合法，这就是MTLS，网关与后端服务进行双向认证。</p><ul><li>higress.io/proxy-ssl-secret：网关使用的客户端证书，用于后端服务对网关进行身份认证，格式为 secretNamespace/secretName。</li><li>higress.io/proxy-ssl-name：TLS握手期间使用的SNI。</li><li>higress.io/proxy-ssl-server-name：on or off。开启或关闭TLS握手期间使用SNI。</li></ul><p>网关与后端服务进行双向认证，网关使用的secret name为gateway-cert，命名空为default。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higress.io/proxy-ssl-secret: &quot;default/ateway-cert&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: demo-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pathType: Exact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/higress-group/higress-group.github.io/blob/main/i18n/zh-cn/docusaurus-plugin-content-docs/current/user/annotation-use-case.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh-cn/docs/user/annotation"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Ingress Annotation 配置说明</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/docs/user/configurations"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">运维参数配置说明</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前提条件" class="table-of-contents__link toc-highlight">前提条件</a></li><li><a href="#灰度发布" class="table-of-contents__link toc-highlight">灰度发布</a><ul><li><a href="#基于header灰度发布" class="table-of-contents__link toc-highlight">基于Header灰度发布</a></li><li><a href="#基于cookie灰度发布" class="table-of-contents__link toc-highlight">基于Cookie灰度发布</a></li><li><a href="#基于权重灰度发布" class="table-of-contents__link toc-highlight">基于权重灰度发布</a></li></ul></li><li><a href="#跨域" class="table-of-contents__link toc-highlight">跨域</a></li><li><a href="#rewrite重写path和host" class="table-of-contents__link toc-highlight">Rewrite重写Path和Host</a><ul><li><a href="#rewrite重写path" class="table-of-contents__link toc-highlight">Rewrite重写Path</a></li><li><a href="#rewrite重写host" class="table-of-contents__link toc-highlight">Rewrite重写Host</a></li></ul></li><li><a href="#重定向" class="table-of-contents__link toc-highlight">重定向</a><ul><li><a href="#配置http重定向至https" class="table-of-contents__link toc-highlight">配置HTTP重定向至HTTPS</a></li><li><a href="#永久重定向" class="table-of-contents__link toc-highlight">永久重定向</a></li><li><a href="#临时重定向" class="table-of-contents__link toc-highlight">临时重定向</a></li></ul></li><li><a href="#header控制" class="table-of-contents__link toc-highlight">Header控制</a><ul><li><a href="#请求header控制" class="table-of-contents__link toc-highlight">请求Header控制</a></li><li><a href="#响应header控制" class="table-of-contents__link toc-highlight">响应Header控制</a></li></ul></li><li><a href="#重试" class="table-of-contents__link toc-highlight">重试</a></li><li><a href="#配置后端服务协议https或grpc" class="table-of-contents__link toc-highlight">配置后端服务协议：HTTPS或GRPC</a></li><li><a href="#配置后端服务的负载均衡算法" class="table-of-contents__link toc-highlight">配置后端服务的负载均衡算法</a><ul><li><a href="#普通负载均衡算法" class="table-of-contents__link toc-highlight">普通负载均衡算法</a></li><li><a href="#基于一致性hash的负载均衡算法" class="table-of-contents__link toc-highlight">基于一致性Hash的负载均衡算法</a></li></ul></li><li><a href="#cookie亲和性-会话保持" class="table-of-contents__link toc-highlight">Cookie亲和性 （会话保持）</a></li><li><a href="#网关与后端服务双向认证mtls" class="table-of-contents__link toc-highlight">网关与后端服务双向认证（MTLS)</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">愿景</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/">为用户提供一站式云原生网关解决方案.</a></li></ul></div><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/docs/overview/what-is-higress">Higress是什么?</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-cn/docs/user/quickstart">快速开始</a></li><li class="footer__item"><a href="https://github.com/higress-group/higress-group.github.io/issues/new" target="_blank" rel="noopener noreferrer" class="footer__link-item">报告文档问题<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/higress-group/higress-group.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">在GitHub上编辑此文档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">资源</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/blog">博客</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-cn/community">社区</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="//img.alicdn.com/imgextra/i2/O1CN01oNTGgE1lfW7oEPIzP_!!6000000004846-2-tps-960-290.png" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="120" height="36"><img src="//img.alicdn.com/imgextra/i2/O1CN01oNTGgE1lfW7oEPIzP_!!6000000004846-2-tps-960-290.png" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="120" height="36"></div><div class="footer__copyright">Copyright © 2023 Higress<br>浙公网安备 33011002016922号 浙ICP备12022327号-1119</div></div></div></footer></div>
<script src="/zh-cn/assets/js/runtime~main.41931863.js"></script>
<script src="/zh-cn/assets/js/main.5b8e82fe.js"></script>
</body>
</html>